<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°íšì „ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.26/dist/interact.min.js"></script>
    <!-- config.js ì—ì„œ API í‚¤ ë¡œë“œ (ì„œë²„ ì—†ì´ ì“¸ ë•Œ). ì—†ìœ¼ë©´ getGeminiApiKey ë“±ì€ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜ -->
    <script src="config.js"></script>
    <style>
        /* í•˜ë‹¨ ì‹œì•ˆ ì˜ì—­ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ë„˜ì–´ê°€ê¸° ìœ„í•œ ì„¤ì • */
        html { scroll-behavior: smooth; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* mainì´ í—¤ë”Â·ì¸ì‚¬ì´íŠ¸ ì•„ë˜ ë‚¨ì€ ë†’ì´ë¥¼ ê½‰ ì±„ìš°ë„ë¡ */
        html, body { height: 100%; }
        .main-content {
            flex: 1 1 0%;
            min-height: 0;
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            grid-template-rows: 1fr;
        }
        .overlay-text-box { position: absolute; cursor: move; user-select: none; white-space: nowrap; }
        .overlay-text-box.dragging { outline: 1px dashed rgba(255,255,255,0.9); outline-offset: 2px; }
        .overlay-text-box .resize-handle { position: absolute; right: -2px; bottom: -2px; width: 12px; height: 12px; cursor: nwse-resize; background: rgba(255,255,255,0.6); border-radius: 2px; }
        .overlay-text-box .resize-handle:hover { background: rgba(255,255,255,0.9); }
        .overlay-text-box[data-target^="mo-"] { white-space: normal; max-width: 88%; word-break: keep-all; line-height: 1.2; }
        .image-loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .image-loading-overlay.visible { display: flex; }
        .image-loading-overlay .spinner { width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 0.9s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-y-auto overflow-x-hidden min-h-screen">

    <!-- ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="imageLoadingOverlay" class="image-loading-overlay" aria-hidden="true">
        <div class="spinner" role="presentation"></div>
        <p id="imageLoadingOverlayMessage" class="text-lg font-semibold text-indigo-600">AI ë””ìì´ë„ˆê°€ ê³ í™”ì§ˆ ì‹œì•ˆì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <div id="dashboard" class="flex flex-col h-screen flex-shrink-0 overflow-hidden">
        <header class="w-full bg-white border-b z-10 shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-3xl font-bold text-indigo-600">Instant Campaign</h1>
            </div>
            <div class="px-4 py-4 flex gap-4 items-center bg-gray-50">
                <span class="font-medium text-gray-600">ë¸Œëœë“œ ì„ íƒ:</span>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="brand" value="DV" class="w-4 h-4 text-indigo-600" checked>
                    <span class="font-semibold">DV</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="brand" value="ST" class="w-4 h-4 text-indigo-600">
                    <span class="font-semibold">ST</span>
                </label>
            </div>
        </header>

        <div id="aiInsightBar" class="w-full bg-indigo-50 border-b border-indigo-100 shrink-0 px-4 py-3 flex gap-3 items-start">
            <span class="text-sm font-semibold text-indigo-700 whitespace-nowrap pt-0.5">ğŸ¤– AI MD ì œì•ˆ</span>
            <div id="aiInsightText" class="text-sm text-gray-700 min-w-0 flex-1 leading-relaxed whitespace-pre-wrap">íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì œì•ˆì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>

        <main class="main-content grid grid-cols-12 grid-rows-[1fr] gap-0 flex-1 min-h-0 overflow-hidden w-full">
        
        <section class="col-span-3 border-r bg-white p-4 min-h-0 overflow-y-auto">
            <h2 class="text-base font-bold mb-3 text-gray-700">1. ê²€ìƒ‰ì–´ ì„ íƒ</h2>
            <div class="flex items-center justify-between mb-2">
                <span id="trendsUpdateTime" class="text-sm font-bold text-gray-400 uppercase">íŠ¸ë Œë“œ (ë¡œë”© ì¤‘...)</span>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div class="mb-2 text-right">
                <span class="text-xs font-medium text-gray-600">ê²€ìƒ‰ëŸ‰</span>
            </div>
            <div id="trendsList" class="space-y-1">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  íŠ¸ë Œë“œ ë¦¬ìŠ¤íŠ¸ -->
            </div>
            <button type="button" id="trendsReloadBtn" class="mt-3 w-full py-2 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50">ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </section>

        <section class="col-span-4 border-r p-4 min-h-0 overflow-y-auto bg-white">
            <h2 class="text-base font-bold mb-3 text-gray-700">2. ìƒì„¸ ì„¤ì •</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì œí’ˆ ì´ë¯¸ì§€(ëˆ„ë¼ì»·) â€” ë°°ê²½ í•©ì„±ìš©</label>
                    <div id="referenceImageZone" class="w-full h-24 border-2 border-dashed rounded-lg flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="file" id="referenceImageInput" accept="image/*" class="hidden">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
                        <span id="referenceImageLabel" class="text-xs">ì œí’ˆ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ í‚¤ì›Œë“œì™€ ê¸°íšì˜ë„ì— ë§ëŠ” ë°°ê²½ì— í•©ì„±í•©ë‹ˆë‹¤</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1.5">ë˜ëŠ” ì•„ë˜ì— <strong>ì´ë¯¸ì§€ URL</strong>ì„ ë„£ì–´ë„ ë©ë‹ˆë‹¤ (FALÂ·Replicate ëª¨ë‘ URL ì§€ì›)</p>
                    <input type="url" id="referenceImageUrlInput" placeholder="https:// ì˜ˆì‹œ ì´ë¯¸ì§€ ì£¼ì†Œ" class="mt-1.5 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div id="aiModeSection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI ìƒì„± ëª¨ë“œ</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="aiGenerateMode" value="product" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">ì œí’ˆ ì¤‘ì‹¬(ì—°ì¶œì»·)</span> â€” ì œí’ˆì´ ì£¼ì¸ê³µì¸ ì—°ì¶œ ì‚¬ì§„</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="aiGenerateMode" value="person" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">ì¸ë¬¼ ì¤‘ì‹¬(ëª¨ë¸ì»·)</span> â€” ì¸ë¬¼/ëª¨ë¸ì´ ì£¼ì¸ê³µì¸ ì—°ì¶œ ì‚¬ì§„</span>
                        </label>
                    </div>
                    <p id="aiModeHint" class="mt-1.5 text-xs text-gray-400">ìƒì„± ëª¨ë“œëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¯¸ì§€ ìƒì„± API</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="imageApi" value="fal" checked class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">FAL API</span> â€” ë¹ ë¥¸ ìƒì„±, ê¸°ë³¸ ë°°ê²½ êµì²´</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="imageApi" value="replicate" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">Replicate API</span> â€” ì„œë²„ í”„ë¡ì‹œ í•„ìš” (server.js ì‹¤í–‰ í•„ìš”)</span>
                        </label>
                    </div>
                    <p class="text-xs text-amber-700 mt-1 bg-amber-50 border border-amber-200 rounded px-2 py-1">âš ï¸ <strong>í•œë„ ì´ˆê³¼(429)ê°€ ìì£¼ ë‚˜ì˜¤ëŠ” ì´ìœ :</strong> ê²°ì œ ìˆ˜ë‹¨ ì—†ì´ ì“°ë©´ <strong>ë¶„ë‹¹ ìµœëŒ€ 6íšŒ</strong>ë§Œ í—ˆìš©ë©ë‹ˆë‹¤. ì‹œì•ˆ 1íšŒ = MO+PC 2íšŒë¼ì„œ 1ë¶„ì— 2~3ë²ˆë§Œ ìƒì„± ê°€ëŠ¥. ê²°ì œ ì¶”ê°€ ì‹œ ë¶„ë‹¹ 600íšŒë¡œ ì™„í™”ë©ë‹ˆë‹¤. 429 ë‚˜ì˜¤ë©´ 35ì´ˆ í›„ ìë™ ì¬ì‹œë„(1íšŒ)í•©ë‹ˆë‹¤.</p>
                    <div id="serverStatus" class="text-xs mt-2 hidden">
                        <span id="serverStatusText" class="text-gray-500"></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Replicate API ì‚¬ìš© ì‹œ: <code class="bg-gray-100 px-1 rounded">node server.js</code> ì‹¤í–‰ í›„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                    <div class="mt-3 space-y-3">
                        <div>
                            <label for="geminiApiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Gemini API í‚¤ <span class="text-gray-500 font-normal">(í•œ ë²ˆ ì…ë ¥í•˜ë©´ ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨)</span></label>
                            <input type="password" id="geminiApiKeyInput" autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Google AI Studioì—ì„œ ë°œê¸‰í•œ í‚¤">
                        </div>
                        <div>
                            <label for="falApiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">FAL API í‚¤ <span class="text-gray-500 font-normal">(í•œ ë²ˆ ì…ë ¥í•˜ë©´ ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨)</span></label>
                            <input type="password" id="falApiKeyInput" autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="fal.aiì—ì„œ ë°œê¸‰í•œ í‚¤">
                        </div>
                    </div>
                    <p class="text-xs text-amber-700 mt-1.5 bg-amber-50 border border-amber-200 rounded px-2 py-1.5">
                        ğŸ’¡ <strong>ë¬´ë£Œë¡œ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´:</strong> <span class="font-medium text-indigo-700">FAL API</span>ë¥¼ ì„ íƒí•˜ì„¸ìš”. fal.ai ê°€ì… í›„ í¬ë ˆë”§ìœ¼ë¡œ ì²´í—˜ ê°€ëŠ¥. ReplicateëŠ” ê²°ì œ ìˆ˜ë‹¨ ì—†ì´ë„ â€˜Try for Freeâ€™ë¡œ ì œí•œì  ì²´í—˜ ê°€ëŠ¥(ë¶„ë‹¹ ìš”ì²­ ìˆ˜ ì œí•œ ìˆìŒ).
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê¸°íš ì˜ë„ ë° ê°•ì¡°ì </label>
                    <textarea id="campaignIntent" class="w-full border rounded-lg p-3 h-24 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: ì‹ ê·œ íšŒì› ê°€ì… í˜œíƒì„ ê°€ì¥ í¬ê²Œ ë³´ì—¬ì¤˜."></textarea>
                    <p class="mt-1.5 text-xs text-gray-500">
                        ğŸ’¡ <strong>íš¨ê³¼ì ì¸ ì‘ì„± íŒ:</strong><br>
                        â€¢ êµ¬ì²´ì ì¸ ë°°ê²½/ì¥ì†Œ: "ëŒ€í•™ ìº í¼ìŠ¤", "ëª¨ë˜ ì˜¤í”¼ìŠ¤", "ìì—°ìŠ¤ëŸ¬ìš´ ì‹¤ë‚´"<br>
                        â€¢ ë¶„ìœ„ê¸°/ê°ì„±: "í”„ë¦¬ë¯¸ì—„ ëŠë‚Œ", "ì²­ëŸ‰í•œ ëŠë‚Œ", "ë”°ëœ»í•œ ë¶„ìœ„ê¸°"<br>
                        â€¢ ê°•ì¡°í•˜ê³  ì‹¶ì€ ìš”ì†Œ: "ì œí’ˆì´ ë‹ë³´ì´ê²Œ", "ë¸Œëœë“œ ê³ ê¸‰ìŠ¤ëŸ¬ì›€ ê°•ì¡°"<br>
                        â€¢ ìŠ¤íƒ€ì¼: "ë¯¸ë‹ˆë©€", "ëŸ­ì…”ë¦¬", "íŠ¸ë Œë””", "í´ë˜ì‹"
                    </p>
                </div>
            </div>
        </section>

        <section class="col-span-5 p-4 min-h-0 overflow-y-auto bg-gray-50">
            <h2 class="text-base font-bold mb-3 text-gray-700">3. ê¸°íšì „ í…œí”Œë¦¿ <span class="text-xs font-normal text-gray-500">(ì„ íƒì‚¬í•­)</span></h2>
            <div class="grid grid-cols-2 gap-3">
                <div class="template-card relative bg-gray-100 rounded-lg p-4 cursor-pointer border-2 border-transparent transition-all duration-200 hover:scale-[1.02] hover:shadow-md ring-4 ring-indigo-500 ring-offset-2" data-template="A">
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ A</p>
                    <p class="text-xs text-gray-500 mb-2">ë°°ë„ˆí˜• Â· í‚¤ì›Œë“œ ê°•ì¡°</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><line x1="0" y1="20" x2="120" y2="20" stroke="currentColor" stroke-width="1"/><line x1="0" y1="40" x2="80" y2="40" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded bg-indigo-600 text-white font-medium" data-template="A" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="A" data-variant="MO">MO</button>
                    </div>
                </div>
                <div class="template-card template-card--preparing relative bg-gray-100 rounded-lg p-4 border-2 border-transparent transition-all duration-200 opacity-75 cursor-not-allowed pointer-events-none" data-template="B">
                    <div class="absolute inset-0 rounded-lg bg-gray-200/80 flex items-center justify-center z-10 pointer-events-auto">
                        <span class="text-sm font-bold text-gray-600">ì¤€ë¹„ì¤‘</span>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white hidden template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ B</p>
                    <p class="text-xs text-gray-500 mb-2">ì¹´ë“œí˜• Â· ì„¸ì¼ì¦ˆ ê°•ì¡°</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><rect x="5" y="5" width="35" height="25" fill="none" stroke="currentColor" stroke-width="1"/><rect x="45" y="5" width="35" height="25" fill="none" stroke="currentColor" stroke-width="1"/><rect x="85" y="5" width="30" height="25" fill="none" stroke="currentColor" stroke-width="1"/><rect x="5" y="35" width="55" height="20" fill="none" stroke="currentColor" stroke-width="1"/><rect x="65" y="35" width="50" height="20" fill="none" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="B" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="B" data-variant="MO">MO</button>
                    </div>
                </div>
                <div class="template-card template-card--preparing relative bg-gray-100 rounded-lg p-4 border-2 border-transparent transition-all duration-200 opacity-75 cursor-not-allowed pointer-events-none" data-template="C">
                    <div class="absolute inset-0 rounded-lg bg-gray-200/80 flex items-center justify-center z-10 pointer-events-auto">
                        <span class="text-sm font-bold text-gray-600">ì¤€ë¹„ì¤‘</span>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white hidden template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ C</p>
                    <p class="text-xs text-gray-500 mb-2">ë¦¬ìŠ¤íŠ¸í˜• Â· ë¸Œëœë“œ ìŠ¤í† ë¦¬</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><line x1="10" y1="12" x2="110" y2="12" stroke="currentColor" stroke-width="1"/><line x1="10" y1="24" x2="110" y2="24" stroke="currentColor" stroke-width="1"/><line x1="10" y1="36" x2="90" y2="36" stroke="currentColor" stroke-width="1"/><line x1="10" y1="48" x2="100" y2="48" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="C" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="C" data-variant="MO">MO</button>
                    </div>
                </div>
                <div class="template-card template-card--preparing relative bg-gray-100 rounded-lg p-4 border-2 border-transparent transition-all duration-200 opacity-75 cursor-not-allowed pointer-events-none" data-template="D">
                    <div class="absolute inset-0 rounded-lg bg-gray-200/80 flex items-center justify-center z-10 pointer-events-auto">
                        <span class="text-sm font-bold text-gray-600">ì¤€ë¹„ì¤‘</span>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white hidden template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ D</p>
                    <p class="text-xs text-gray-500 mb-2">ì´ë²¤íŠ¸í˜• Â· í”„ë¡œëª¨ì…˜ ê°•ì¡°</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><rect x="10" y="10" width="100" height="15" fill="none" stroke="currentColor" stroke-width="1"/><rect x="10" y="30" width="45" height="20" fill="none" stroke="currentColor" stroke-width="1"/><rect x="65" y="30" width="45" height="20" fill="none" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="D" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="D" data-variant="MO">MO</button>
                    </div>
                </div>
            </div>
            <p id="generateStatus" class="mt-4 text-sm text-indigo-600 min-h-[1.5rem] py-1"></p>
            <div class="mt-4 flex gap-2">
                <button id="generateButton" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg">
                    AI ì‹œì•ˆ ìƒì„±í•˜ê¸° â†“
                </button>
                <button id="resetButton" class="flex-1 bg-gray-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-600 transition-all shadow-lg">
                    ì´ˆê¸°í™”
                </button>
            </div>
        </section>
    </main>
    </div>

    <div id="result" class="min-h-screen w-full bg-indigo-50/60 border-t-2 border-indigo-200 p-4 md:p-6 scroll-mt-4">
        <div class="grid grid-cols-12 gap-0 w-full max-w-full">
            <div class="col-span-12 mb-4">
                <h2 class="text-2xl font-bold text-gray-800 border-b border-indigo-300 pb-3">AI ìƒì„± ê¸°íšì „ ì‹œì•ˆ</h2>
            </div>

            <!-- ì¢Œ+ì¤‘ì•™: ì‹œì•ˆ ê°¤ëŸ¬ë¦¬ (col-span-8) â€” ë¹„ìœ¨ ìœ ì§€, í…ìŠ¤íŠ¸ í¸ì§‘ê³¼ ê°„ê²© í™•ë³´ -->
            <div class="col-span-12 lg:col-span-8 flex flex-col min-h-0 pr-0 lg:pr-6">
                <div class="flex flex-row items-center justify-start gap-4 h-[440px] min-h-[440px] max-w-full rounded-xl border border-indigo-200/80 bg-white shadow-sm overflow-x-auto overflow-y-hidden p-4">
                    <div id="resultMoCapture" class="relative overflow-hidden rounded-lg flex-shrink-0 h-full w-auto min-w-[180px]" style="aspect-ratio: 2304/3500;">
                        <img id="resultMoImage" src="" alt="MO ì‹œì•ˆ" class="absolute inset-0 w-full h-full object-contain object-center hidden">
                        <p id="resultMoPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500 py-12 px-6 text-center text-sm bg-gray-100">í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
                        <div id="resultMoOverlay" class="absolute inset-0 bg-gradient-to-b from-black/30 to-transparent hidden" style="pointer-events:none">
                            <div class="overlay-text-box" data-target="mo-brand" style="pointer-events:auto; left:0; top:0;"><span id="resultMoBrand" class="font-bold text-white/95 tracking-wide">DV 26SS ì»¬ë ‰ì…˜</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                            <div class="overlay-text-box" data-target="mo-keyword" style="pointer-events:auto; left:0; top:0;"><span id="resultMoKeyword" class="font-black text-white tracking-tight uppercase leading-tight break-words">í‚¤ì›Œë“œ</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                        </div>
                    </div>
                    <div id="resultPcCapture" class="relative overflow-hidden rounded-lg flex-shrink-0 h-full w-auto" style="aspect-ratio: 3840/1760;">
                        <img id="resultPcImage" src="" alt="PC ì‹œì•ˆ" class="absolute inset-0 w-full h-full object-cover object-center hidden">
                        <p id="resultPcPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500 py-12 px-6 text-center text-sm bg-gray-100">í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
                        <div id="resultPcOverlay" class="absolute inset-0 bg-gradient-to-b from-black/30 to-transparent hidden" style="pointer-events:none">
                            <div class="overlay-text-box" data-target="pc-brand" style="pointer-events:auto; left:0; top:0;"><span id="resultPcBrand" class="font-bold text-white/95 tracking-wide">DV 26SS ì»¬ë ‰ì…˜</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                            <div class="overlay-text-box" data-target="pc-keyword" style="pointer-events:auto; left:0; top:0;"><span id="resultPcKeyword" class="font-black text-white tracking-tight uppercase leading-tight break-words">í‚¤ì›Œë“œ</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-row flex-wrap gap-2 mt-2">
                    <button type="button" id="copySvgMoBtn" class="px-3 py-2 rounded-lg border border-indigo-300 bg-indigo-50 text-indigo-700 text-sm font-medium hover:bg-indigo-100 transition-colors">í”¼ê·¸ë§ˆìš© SVG ë³µì‚¬ (MO)</button>
                    <button type="button" id="copySvgPcBtn" class="px-3 py-2 rounded-lg border border-indigo-300 bg-indigo-50 text-indigo-700 text-sm font-medium hover:bg-indigo-100 transition-colors">í”¼ê·¸ë§ˆìš© SVG ë³µì‚¬ (PC)</button>
                </div>
            </div>

            <!-- ìš°ì¸¡: ì»¨íŠ¸ë¡¤ íŒ¨ë„ (col-span-4) â€” ìƒë‹¨ 3ë²ˆ(col-span-4)ê³¼ ê°€ë¡œ ë™ì¼ -->
            <div class="col-span-12 lg:col-span-4 p-4 min-h-0 overflow-y-auto bg-white border-l border-gray-200 flex flex-col gap-6">
                <h3 class="text-base font-bold text-gray-700">í…ìŠ¤íŠ¸ í¸ì§‘</h3>
                <div class="rounded-lg bg-amber-50 border border-amber-200/80 px-3 py-2 mb-3">
                    <p class="text-xs text-amber-800 font-medium">ë¬¸êµ¬ê°€ ì‹œì•ˆì—ì„œ ì˜ ë³´ì´ë ¤ë©´ ì§§ê²Œ ì“°ì„¸ìš”.</p>
                    <p class="text-xs text-amber-700 mt-0.5">ìƒë‹¨ ë¬¸êµ¬ 10ì ë‚´ì™¸, ë©”ì¸ ë¬¸êµ¬ 15ì ë‚´ì™¸(ì˜ë¬¸ì´ë©´ 3~4ë‹¨ì–´) ê¶Œì¥.</p>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒë‹¨ ë¬¸êµ¬</label>
                        <input type="text" id="editBrand" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: DV 26SS ì»¬ë ‰ì…˜" maxlength="20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë©”ì¸ ë¬¸êµ¬</label>
                        <input type="text" id="editKeyword" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: SPRING IN QUIET LIGHT" maxlength="25">
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">ë¬¸êµ¬ í¬ê¸° (px)</p>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">MO ìƒë‹¨</label>
                                <input type="number" id="editMoBrandSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="14" placeholder="8~72">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">MO ë©”ì¸</label>
                                <input type="number" id="editMoKeywordSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="28" placeholder="8~72">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">PC ìƒë‹¨</label>
                                <input type="number" id="editPcBrandSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="16" placeholder="8~72">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">PC ë©”ì¸</label>
                                <input type="number" id="editPcKeywordSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="36" placeholder="8~72">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-base font-bold text-gray-700 mb-2">ë””ë ‰ì…˜ & ì¬ìƒì„±</h3>
                    <textarea id="resultFeedback" rows="4" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 outline-none resize-y min-h-[100px]" placeholder="ìì—°ì–´ í”¼ë“œë°± ì…ë ¥ (ì˜ˆ: ë°°ê²½ì„ ë” ë°ê²Œ, í†¤ ë‹¤ìš´ ë“±)"></textarea>
                    <div class="mt-2 flex flex-wrap gap-2 justify-end">
                        <button type="button" id="developImageBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium border border-indigo-600">ì´ë¯¸ì§€ ë””ë²¨ë¡­</button>
                        <button type="button" id="regenerateImageBtn" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-800 text-white text-sm font-medium border border-gray-700">ì´ë¯¸ì§€ ì¬ìƒì„±</button>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-200">
                    <h3 class="text-base font-bold text-gray-700 mb-2">ë‹¤ìš´ë¡œë“œ</h3>
                    <div class="flex flex-col gap-2">
                        <button type="button" id="downloadMoBtn" class="w-full py-2.5 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors">MO ì‹œì•ˆ ì €ì¥ (PNG)</button>
                        <button type="button" id="downloadPcBtn" class="w-full py-2.5 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors">PC ì‹œì•ˆ ì €ì¥ (PNG)</button>
                        <button type="button" id="downloadAllBtn" class="w-full py-3 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 border border-indigo-600 rounded-lg transition-colors">ëª¨ë“  ì‹œì•ˆ ì••ì¶• ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="window.scrollTo(0,0);" class="mt-8 text-indigo-600 underline hover:text-indigo-800 text-sm font-medium">ë‹¤ì‹œ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</button>
    </div>

    <script>
        // ========== ì„œë²„ ì—†ì´ ì“¸ ë•Œ: config.js í‚¤ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œ. ì„œë²„ ì“¸ ë•Œ: API_BASE ì„¤ì •í•˜ë©´ /api/* ë¡œ ìš”ì²­ ==========
        var API_BASE = ''; // ì„œë²„ ë°°í¬ ì‹œ ì—¬ê¸° ë°±ì—”ë“œ URL ë„£ìœ¼ë©´ Gemini/FAL/Replicate ëª¨ë‘ ì„œë²„ ê²½ìœ 
        if (typeof getGeminiApiKey === 'undefined') { function getGeminiApiKey() { return ''; } }
        if (typeof getFalApiKey === 'undefined') { function getFalApiKey() { return ''; } }
        if (typeof getReplicateApiKey === 'undefined') { function getReplicateApiKey() { return ''; } }
        var STORAGE_KEY_GEMINI = 'instant_campaign_gemini_key';
        var STORAGE_KEY_FAL = 'instant_campaign_fal_key';
        // Gemini í‚¤: í™”ë©´ ì…ë ¥ë€ ìš°ì„  â†’ localStorage â†’ config.js
        function getEffectiveGeminiApiKey() {
            var el = document.getElementById('geminiApiKeyInput');
            var fromInput = el && el.value && String(el.value).trim();
            if (fromInput) return fromInput;
            try { fromInput = (localStorage.getItem(STORAGE_KEY_GEMINI) || '').trim(); if (fromInput) return fromInput; } catch (e) {}
            return getGeminiApiKey() || '';
        }
        // FAL í‚¤: í™”ë©´ ì…ë ¥ë€ ìš°ì„  â†’ localStorage â†’ config.js
        function getEffectiveFalApiKey() {
            var el = document.getElementById('falApiKeyInput');
            var fromInput = el && el.value && String(el.value).trim();
            if (fromInput) return fromInput;
            try { fromInput = (localStorage.getItem(STORAGE_KEY_FAL) || '').trim(); if (fromInput) return fromInput; } catch (e) {}
            return getFalApiKey() || '';
        }
        
        // API í‚¤ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜ (ì½˜ì†” ë¡œê·¸ ë³´ì•ˆ)
        function maskApiKey(key) {
            if (!key || key.length < 8) return '***';
            return key.substring(0, 4) + '***' + key.substring(key.length - 4);
        }
        
        // URLì—ì„œ API í‚¤ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
        function maskApiKeyInUrl(url) {
            if (!url || typeof url !== 'string') return url;
            // Gemini API í‚¤ íŒ¨í„´: AIzaSy...
            url = url.replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
            // FAL API í‚¤ íŒ¨í„´: UUID:hash
            url = url.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
            // key= íŒŒë¼ë¯¸í„° ë§ˆìŠ¤í‚¹
            url = url.replace(/[?&]key=([^&]*)/gi, function(match, key) { return match.replace(key, maskApiKey(key)); });
            return url;
        }
        
        // ì—ëŸ¬ ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ë§ˆìŠ¤í‚¹í•˜ì—¬ ë¡œê·¸ ì¶œë ¥ìš©ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function sanitizeErrorForLogging(error) {
            if (!error) return null;
            var sanitized = {};
            try {
                // error.message
                if (error.message) {
                    sanitized.message = maskApiKeyInUrl(error.message);
                    sanitized.message = sanitized.message.replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                    sanitized.message = sanitized.message.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                }
                // error.response (axios ìŠ¤íƒ€ì¼)
                if (error.response) {
                    sanitized.response = {
                        status: error.response.status,
                        statusText: error.response.statusText,
                        headers: error.response.headers || {}
                    };
                    if (error.response.data) {
                        var dataStr = JSON.stringify(error.response.data);
                        dataStr = maskApiKeyInUrl(dataStr);
                        dataStr = dataStr.replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                        dataStr = dataStr.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                        try {
                            sanitized.response.data = JSON.parse(dataStr);
                        } catch (e) {
                            sanitized.response.data = dataStr;
                        }
                    }
                }
                // error.stack
                if (error.stack) {
                    sanitized.stack = maskApiKeyInUrl(error.stack);
                    sanitized.stack = sanitized.stack.replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                    sanitized.stack = sanitized.stack.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                }
                // ê¸°íƒ€ ì†ì„±
                sanitized.name = error.name || 'Error';
            } catch (e) {
                sanitized = { message: String(error), sanitizationError: 'Failed to sanitize error object' };
            }
            return sanitized;
        }
        
        // HTTP ìƒíƒœ ì½”ë“œì— ëŒ€í•œ ì„¤ëª… ë°˜í™˜
        function getHttpStatusDescription(status) {
            var descriptions = {
                400: 'ì˜ëª»ëœ ìš”ì²­ (400) - ìš”ì²­ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                401: 'ì¸ì¦ ì‹¤íŒ¨ (401) - API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                403: 'ê¶Œí•œ ì—†ìŒ (403) - API í‚¤ì— ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
                404: 'ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (404) - ìš”ì²­í•œ ì—”ë“œí¬ì¸íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                429: 'í• ë‹¹ëŸ‰ ì´ˆê³¼ (429) - API ì‚¬ìš©ëŸ‰ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.',
                500: 'ì„œë²„ ì˜¤ë¥˜ (500) - ì„œë²„ ì¸¡ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                502: 'ê²Œì´íŠ¸ì›¨ì´ ì˜¤ë¥˜ (502) - ì„œë²„ê°€ ì˜ëª»ëœ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.',
                503: 'ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶ˆê°€ (503) - ì„œë²„ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            };
            return descriptions[status] || 'HTTP ' + status + ' - ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        }
        
        // Gemini API í˜¸ì¶œ ì“°ë¡œí‹€ë§ (3ì´ˆ)
        var lastGeminiCallTime = 0;
        var geminiThrottleDelay = 3000; // 3ì´ˆ
        
        // ì„ íƒëœ í‚¤ì›Œë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let selectedKeyword = null;
        // íŠ¸ë Œë“œ í‚¤ì›Œë“œ ëª©ë¡ (ê²€ìƒ‰ëŸ‰ ë‚´ë¦¼ì°¨ìˆœ) â€” ë¡œë“œ í›„ AI ì œì•ˆì— ì‚¬ìš©
        let currentTrendKeywords = [];
        // ì„ íƒëœ ë¸Œëœë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let selectedBrand = 'DV';
        // ì„ íƒëœ í…œí”Œë¦¿ì„ ì €ì¥í•  ë³€ìˆ˜ (A/B/C/D)
        let selectedTemplate = 'A';
        // ì„ íƒëœ ë ˆì´ì•„ì›ƒ (PC/MO)
        let selectedVariant = 'PC';
        // ë§ˆì§€ë§‰ ìƒì„±ëœ ì´ë¯¸ì§€ URL / í”„ë¡¬í”„íŠ¸ (ë””ë²¨ë¡­Â·ì¬ìƒì„±ìš©)
        let lastGeneratedImageUrl = '';
        let lastGeneratedMoImageUrl = '';
        let lastGeneratedPcImageUrl = '';
        let lastImagePrompt = '';
        let lastDetailInstructions = '';
        let lastAiMode = 'mood';
        let lastImageSeed = null;
        
        // ì œí’ˆ ëˆ„ë¼ì»· ì´ë¯¸ì§€ (image-to-image ì†ŒìŠ¤: íŒŒì¼ ì—…ë¡œë“œ ë˜ëŠ” URL)
        let referenceImageComposition = '';
        let referenceImageFromFile = null;   // data URL (ì—…ë¡œë“œ)
        let referenceImageUrlFromInput = null; // https URL (ì…ë ¥ë€)
        let referenceImageUrl = null;        // ì‹¤ì œ ì‚¬ìš©ê°’ = FromFile || FromInput
        let hasReferenceImage = false;
        
        function updateReferenceImage() {
            referenceImageUrl = referenceImageFromFile || referenceImageUrlFromInput || null;
            hasReferenceImage = !!referenceImageUrl;
        }
        let selectedAiMode = null;
        let selectedImageApi = 'fal'; // ê¸°ë³¸ê°’: FAL API
        
        // â€”â€”â€” 1. ë¸Œëœë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (Style Asset Database) â€”â€”â€”
        var BRAND_ASSETS = {
            DV: {
                fullName: 'Duvetica',
                style_keywords: 'Premium lifestyle, Italian elegance, modern resort, soft luxury lighting, refined atmosphere',
                negative_prompt: 'dark night, messy background, urban clutter, text, logo, person'
            },
            ST: {
                fullName: 'Sergio Tacchini',
                style_keywords: 'Classic Italian tennis club, sun-drenched clay court, premium heritage mood, soft cinematic lighting',
                negative_prompt: 'modern city, dark night, messy background, text, logo, person'
            }
        };
        
        // â€”â€”â€” 2. Gemini Creative Director: í‚¤ì›Œë“œ ìë™ ë¶„ì„ ë° ì°½ì˜ì  ì‹œê°í™” (fal.ai Flux ìµœì í™”) â€”â€”â€”
        var GEMINI_CREATIVE_DIRECTOR_SYSTEM = 'ë„ˆëŠ” ë°°ë„ˆ ì´ë¯¸ì§€ìš© ì¥ë©´ì„ ì„¤ê³„í•˜ëŠ” í¬ë¦¬ì—ì´í‹°ë¸Œ ë””ë ‰í„°ë‹¤. **ì´ë¯¸ì§€ ìƒì„± AIëŠ” fal.ai Flux ëª¨ë¸ì´ê³ , ì˜ì–´ í”„ë¡¬í”„íŠ¸ë§Œ ì˜ ì´í•´í•œë‹¤. í•œê¸€ í‚¤ì›Œë“œÂ·ê¸°íšì˜ë„ëŠ” ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ì˜ì–´ ì¥ë©´ ë¬˜ì‚¬ í•œ ë¬¸ì¥ìœ¼ë¡œ ë³€í™˜í•´ë¼.**\n\n**Flux ëª¨ë¸ íŠ¹ì„± ì´í•´:**\n- FluxëŠ” êµ¬ì²´ì ì´ê³  ìƒì„¸í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„ í˜¸í•œë‹¤\n- ëª…ì‚¬ì™€ í˜•ìš©ì‚¬ë¥¼ í’ë¶€í•˜ê²Œ ì‚¬ìš©í•˜ë©´ ë” ì •í™•í•œ ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤\n- ì¡°ëª…, ìƒ‰ê°, ë¶„ìœ„ê¸°, êµ¬ë„ ë“±ì„ ëª…ì‹œí•˜ë©´ ì¢‹ë‹¤\n- ì¶”ìƒì ì´ê±°ë‚˜ ëª¨í˜¸í•œ í‘œí˜„ë³´ë‹¤ëŠ” ì‹œê°ì ìœ¼ë¡œ ëª…í™•í•œ ë¬˜ì‚¬ê°€ ì¢‹ë‹¤\n\n**í•µì‹¬ ì„ë¬´:**\n1. ì£¼ì–´ì§„ í‚¤ì›Œë“œë¥¼ ë¶„ì„í•´ë¼. í‚¤ì›Œë“œê°€ ë¬´ì—‡ì¸ì§€(íšŒì‚¬ëª…, ë¸Œëœë“œëª…, ì¥ì†Œëª…, ì œí’ˆëª…, ê°œë… ë“±) íŒŒì•…í•˜ê³ , ê·¸ í‚¤ì›Œë“œì˜ ë³¸ì§ˆê³¼ íŠ¹ì§•ì„ ì´í•´í•´ë¼.\n2. í‚¤ì›Œë“œì™€ ê¸°íšì˜ë„ë¥¼ ë°°ë„ˆ ì´ë¯¸ì§€ì— ì°½ì˜ì ìœ¼ë¡œ ë…¹ì—¬ë¼. í‚¤ì›Œë“œê°€ ì‹œê°ì ìœ¼ë¡œ ë°”ë¡œ ì—°ìƒë˜ëŠ” ìš”ì†Œ, ê·¸ í‚¤ì›Œë“œì˜ ëŒ€í‘œì ì¸ íŠ¹ì§•, ë˜ëŠ” í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ ì œí’ˆÂ·ì„œë¹„ìŠ¤Â·ë¶„ìœ„ê¸°Â·ë§¥ë½ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•´ë¼.\n3. **Fluxì— ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ì‘ì„±:**\n   - êµ¬ì²´ì ì¸ ëª…ì‚¬ ì‚¬ìš© (ì˜ˆ: "refrigerator" not "appliance")\n   - ì¡°ëª…ê³¼ ìƒ‰ê° ëª…ì‹œ (ì˜ˆ: "soft natural lighting, warm tones")\n   - ë¶„ìœ„ê¸°ì™€ ìŠ¤íƒ€ì¼ ëª…ì‹œ (ì˜ˆ: "modern, minimalist, professional")\n   - êµ¬ë„ì™€ ë°°ì¹˜ ëª…ì‹œ (ì˜ˆ: "centered composition, spacious background")\n4. ì˜ˆì‹œ(ì°¸ê³ ìš©, ì ˆëŒ€ í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³  í‚¤ì›Œë“œì— ë§ê²Œ ì°½ì˜ì ìœ¼ë¡œ ì„¤ê³„):\n   - íšŒì‚¬ëª…/ë¸Œëœë“œëª…ì´ë©´ â†’ ê·¸ íšŒì‚¬ì˜ ëŒ€í‘œ ì œí’ˆÂ·ì„œë¹„ìŠ¤Â·ë¸Œëœë“œ íŠ¹ì„±ì„ ì‹œê°ì ìœ¼ë¡œ ë°˜ì˜\n   - ì¥ì†Œëª…ì´ë©´ â†’ ê·¸ ì¥ì†Œì˜ ì „í˜•ì ì¸ ë°°ê²½Â·ë¶„ìœ„ê¸°Â·íŠ¹ì§•\n   - ì œí’ˆëª…ì´ë©´ â†’ ê·¸ ì œí’ˆì´ ì‚¬ìš©ë˜ëŠ” ë§¥ë½Â·í™˜ê²½\n   - ê°œë…/ê°ì„±ì´ë©´ â†’ ê·¸ ê°œë…ì„ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìˆëŠ” ì¥ë©´\n5. **ì‹¤ë‚´Â·ë°©Â·ì¸í…Œë¦¬ì–´Â·ì°½ë¬¸Â·ê°€êµ¬ëŠ” ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì‹¤ë‚´ë¥¼ ìš”ì²­í•  ë•Œë§Œ ì¨ë¼. ë°”ë‹¤/ë‚ ì”¨/ë°”ë‹·ê°€/í•´ë³€/ì²­ëŸ‰ ë“±ì´ ë‚˜ì˜¤ë©´ ë¬´ì¡°ê±´ ì•¼ì™¸ í•´ì•ˆÂ·í•˜ëŠ˜Â·ë°”ë‹¤ ì¥ë©´ìœ¼ë¡œ.**\n\nì‘ë‹µì€ JSON í•œ ê°œë§Œ, í‚¤ "backgroundPrompt" (string). backgroundPromptëŠ” ì˜ì–´ í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ, í‚¤ì›Œë“œì™€ ê¸°íšì˜ë„ê°€ ë“œëŸ¬ë‚˜ëŠ” êµ¬ì²´ì ì´ê³  ìƒì„¸í•˜ë©° Fluxì— ìµœì í™”ëœ ì¥ë©´ì„ ë¬˜ì‚¬í•´ë¼.';
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function setGenerateStatus(msg) {
            var el = document.getElementById('generateStatus');
            if (el) el.textContent = msg || '';
        }
        
        // Gemini Creative Director í˜¸ì¶œ: í‚¤ì›Œë“œ+ê¸°íšì˜ë„+ëª¨ë“œ+ì°¸ì¡°ì´ë¯¸ì§€ â†’ ë°°ê²½ ì „ìš© ì˜ì–´ í”„ë¡¬í”„íŠ¸
        async function callGeminiCreativeDirector(userKeyword, userInstructions, aiMode, hasReferenceImage) {
            // ì“°ë¡œí‹€ë§ ì²´í¬: 3ì´ˆ ì´ë‚´ ì¬í˜¸ì¶œ ë°©ì§€
            var now = Date.now();
            var timeSinceLastCall = now - lastGeminiCallTime;
            if (timeSinceLastCall < geminiThrottleDelay) {
                var waitTime = Math.ceil((geminiThrottleDelay - timeSinceLastCall) / 1000);
                console.warn('â±ï¸ Gemini API í˜¸ì¶œ ì“°ë¡œí‹€ë§: ' + waitTime + 'ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                return ''; // ë¹ˆ ë¬¸ìì—´ ë°˜í™˜í•˜ì—¬ í´ë°± í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
            }
            lastGeminiCallTime = now;
            
            var apiKey = getEffectiveGeminiApiKey();
            var res = null;
            try {
                if (apiKey && !API_BASE) {
                    // ì„œë²„ ì—†ì´: config.js í‚¤ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ Gemini ì§ì ‘ í˜¸ì¶œ
                    console.log('ğŸ”µ [ì§„í–‰ ë‹¨ê³„] Gemini API í˜¸ì¶œ ì¤‘... (ë¸Œë¼ìš°ì € ì§ì ‘)');
                    var modeInstruction = '';
                    if (aiMode === 'product') modeInstruction = ' Focus: product-centered commercial photography. The scene should showcase a product as the main subject.';
                    else if (aiMode === 'person') modeInstruction = ' Focus: person/model-centered commercial photography. The scene should feature a person or model as the main subject.';
                    var refImageNote = hasReferenceImage ? '\n\n**CRITICAL: A reference product/subject image will be provided, but the KEYWORD is the PRIMARY and DOMINANT theme. Your backgroundPrompt must describe ONLY the keyword-themed background scene that will COMPLETELY REPLACE the reference image\'s background. Do NOT describe the product itself - only describe the environment, setting, scene, atmosphere, lighting, colors, mood that represents the keyword. The product from the reference image will be placed into this background later. Focus on creating a rich, detailed background scene that represents the keyword theme - NOT a simple or plain background.' : '';
                    var userContent = 'Analyze this keyword and create a creative visual scene for a banner image optimized for fal.ai Flux model.\n\nKeyword: "' + (userKeyword || '') + '"\nCampaign intent (ê¸°íš ì˜ë„ ë° ê°•ì¡°ì ): "' + (userInstructions || '') + '"' + refImageNote + '\n\n' + modeInstruction + '\n\n**Your task (optimized for Flux):**\n1. Analyze what this keyword represents (company/brand, place, product, concept, etc.)\n2. Understand the essence and characteristics of this keyword\n3. Design a creative visual scene that incorporates the keyword and campaign intent into the banner' + (hasReferenceImage ? '\n4. **If a reference product/subject image is provided:** Describe ONLY the background environment, setting, atmosphere, lighting, colors, mood that represents the keyword theme. Do NOT describe the product itself - the product will be added separately. Focus on creating a complete, detailed background scene that the keyword represents.' : '') + '\n4. **Write a detailed, specific English prompt optimized for Flux:**\n   - Use concrete nouns and descriptive adjectives\n   - Specify lighting, color tones, mood, and style\n   - Include composition and spatial arrangement details\n   - Make it visually clear and immediately recognizable\n   - ' + (hasReferenceImage ? 'Describe ONLY the background scene, environment, setting - NOT any products or subjects' : '') + '\n5. Be creative and thoughtful.\n\n**Important:** Flux works best with detailed, specific descriptions. One sentence only, but make it detailed and specific.';
                    res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { parts: [{ text: GEMINI_CREATIVE_DIRECTOR_SYSTEM }] },
                            contents: [{ role: 'user', parts: [{ text: userContent }] }],
                            generationConfig: { response_mime_type: 'application/json', maxOutputTokens: 256 }
                        })
                    });
                    var data = await res.json().catch(function() { return {}; });
                    if (!res.ok) throw new Error(data.error?.message || 'Gemini API ì˜¤ë¥˜: ' + res.status);
                    var text = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) ? data.candidates[0].content.parts[0].text : '';
                    text = (text || '').replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
                    var parsed = (function() { try { var m = text.match(/\{[\s\S]*\}/); return m ? JSON.parse(m[0]) : {}; } catch (e) { return {}; } })();
                    var result = (parsed.backgroundPrompt && String(parsed.backgroundPrompt).trim()) ? String(parsed.backgroundPrompt).trim() : '';
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] Gemini í‚¤ì›Œë“œ ë¶„ì„ ì™„ë£Œ');
                    return result;
                }
                // ì„œë²„ ì‚¬ìš© ì‹œ
                console.log('ğŸ”µ [ì§„í–‰ ë‹¨ê³„] Gemini API í˜¸ì¶œ ì¤‘... (ì„œë²„ /api/gemini)');
                res = await fetch(API_BASE + '/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userKeyword: userKeyword || '',
                        userInstructions: userInstructions || '',
                        aiMode: aiMode || null,
                        hasReferenceImage: !!hasReferenceImage
                    })
                });
                var data = await res.json().catch(function() { return {}; });
                if (!res.ok) {
                    console.error('âŒ Gemini API ì‘ë‹µ ì˜¤ë¥˜:', res.status, data);
                    throw new Error(data.error || 'Gemini API ì˜¤ë¥˜: ' + res.status);
                }
                var result = (data.backgroundPrompt && String(data.backgroundPrompt).trim()) ? String(data.backgroundPrompt).trim() : '';
                console.log('âœ… [ì§„í–‰ ë‹¨ê³„] Gemini í‚¤ì›Œë“œ ë¶„ì„ ì™„ë£Œ');
                return result;
            } catch (e) {
                console.error('âŒ Gemini Creative Director í˜¸ì¶œ ì‹¤íŒ¨');
                
                // ìƒì„¸ ì—ëŸ¬ ì •ë³´ ì¶œë ¥ (API í‚¤ ë§ˆìŠ¤í‚¹)
                var sanitizedError = sanitizeErrorForLogging(e);
                if (sanitizedError) {
                    console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                    if (sanitizedError.response) {
                        console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', sanitizedError.response.status, '(' + sanitizedError.response.statusText + ')');
                        console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(sanitizedError.response.status));
                        if (sanitizedError.response.data) {
                            console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', sanitizedError.response.data);
                        }
                    }
                    if (sanitizedError.stack) {
                        console.error('ğŸ” ì—ëŸ¬ ìŠ¤íƒ (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', sanitizedError.stack);
                    }
                } else {
                    // sanitizeErrorForLoggingì´ ì‹¤íŒ¨í•œ ê²½ìš° ê¸°ë³¸ ë§ˆìŠ¤í‚¹
                    var errorMsg = e.message || String(e);
                    errorMsg = maskApiKeyInUrl(errorMsg);
                    errorMsg = errorMsg.replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                    errorMsg = errorMsg.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                    console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', errorMsg);
                }
                
                // res ê°ì²´ê°€ ìˆëŠ” ê²½ìš° ìƒíƒœ ì½”ë“œ ì¶œë ¥
                if (res) {
                    console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', res.status, '(' + res.statusText + ')');
                    console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(res.status));
                }
                
                // ì „ì²´ ì—ëŸ¬ ê°ì²´ ì¶œë ¥ (ìˆœí™˜ ì°¸ì¡° ë°©ì§€)
                    try {
                        var errorObj = {
                            name: e.name,
                            message: sanitizedError ? sanitizedError.message : (e.message || String(e)),
                            stack: sanitizedError ? sanitizedError.stack : (e.stack || '')
                        };
                        console.error('ğŸ“¦ ì „ì²´ ì—ëŸ¬ ê°ì²´ (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):');
                        console.error('   - ì—ëŸ¬ ì´ë¦„:', errorObj.name);
                        console.error('   - ì—ëŸ¬ ë©”ì‹œì§€:', errorObj.message);
                        if (errorObj.stack) {
                            console.error('   - ì—ëŸ¬ ìŠ¤íƒ:', errorObj.stack);
                        }
                        console.error('   - ì „ì²´ ê°ì²´:', errorObj);
                    } catch (err) {
                        console.error('âš ï¸ ì—ëŸ¬ ê°ì²´ ì§ë ¬í™” ì‹¤íŒ¨:', err);
                    }
                
                console.warn('ğŸ”„ í‚¤ì›Œë“œë¥¼ ì§ì ‘ ë¶„ì„í•˜ì—¬ í´ë°± í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
                return '';
            }
        }
        
        // â€”â€”â€” 3. í”„ë¡¬í”„íŠ¸ í“¨ì „: ì„ íƒëœ í‚¤ì›Œë“œ + ê¸°íš ì˜ë„Â·ê°•ì¡°ì  + ëª¨ë“œ ë°˜ì˜ (Gemini ì‹¤íŒ¨ ì‹œ ì˜ì–´ í´ë°±ìœ¼ë¡œ ì‹¤ë‚´ ë°©ì§€) â€”â€”â€”
        function fusePrompt(selectedBrand, userKeyword, userInstructions, geminiBackgroundPrompt, isMo, aiMode) {
            var base = 'High quality, 8k, professional.';
            var themeFirst = (geminiBackgroundPrompt && String(geminiBackgroundPrompt).trim()) ? String(geminiBackgroundPrompt).trim() : '';
            var kw = (userKeyword && String(userKeyword).trim()) ? 'Theme and setting: ' + String(userKeyword).trim() + '.' : '';
            var instruction = (userInstructions && String(userInstructions).trim()) ? String(userInstructions).trim() : '';
            var modePrompt = '';
            if (aiMode === 'product') {
                modePrompt = 'Product-centered composition, product as main subject, commercial product photography.';
            } else if (aiMode === 'person') {
                modePrompt = 'Person-centered composition, model or person as main subject, commercial portrait photography.';
            }
            // aiModeê°€ nullì´ê±°ë‚˜ ë¹ˆ ê°’ì´ë©´ modePromptëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ìœ ì§€ (í‚¤ì›Œë“œì™€ ê¸°íš ì˜ë„ë§Œìœ¼ë¡œ ìƒì„±)
            var fallback = '';
            // Geminiê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ í‚¤ì›Œë“œë¥¼ ì§ì ‘ ë¶„ì„í•´ì„œ í´ë°± ìƒì„±
            if (!themeFirst && (kw || instruction)) {
                var keywordStr = (userKeyword || '').toLowerCase();
                var hasBeach = /ë°”ë‹¤|ë°”ë‹·ê°€|í•´ë³€|ì²­ëŸ‰|ë‚ ì”¨|ë¶€ì‚°|í•´ì•ˆ|ocean|beach|seaside|sea\b/i.test((userKeyword || '') + ' ' + (userInstructions || ''));
                if (hasBeach) {
                    fallback = 'Outdoor scene: refreshing seaside, ocean view, beach, clear sky, coastal vibe. No indoor, no room, no furniture.';
                } else if (/lgì „ì|lg\s*ì „ì|lg\s*electronics/i.test(keywordStr)) {
                    fallback = 'Modern LG electronics showroom, home appliances display, smart home technology, TVs, refrigerators, washing machines, tech products, contemporary retail environment, professional lighting.';
                } else if (/ì‚¼ì„±ì „ì|samsung\s*ì „ì|samsung\s*electronics/i.test(keywordStr)) {
                    fallback = 'Samsung electronics showcase, smartphones, TVs, home appliances, technology innovation, modern tech products, sleek retail space, professional commercial photography.';
                } else if (/ì• í”Œ|apple/i.test(keywordStr)) {
                    fallback = 'Apple products display, iPhone, MacBook, iPad, minimalist tech design, modern technology, clean retail environment, professional product photography.';
                } else if (/ë‚˜ì´í‚¤|nike/i.test(keywordStr)) {
                    fallback = 'Nike sportswear showcase, athletic gear, sports equipment, active lifestyle, athletic performance, modern sports retail, dynamic commercial photography.';
                } else if (/ëŒ€í•™êµ|university|ëŒ€í•™/i.test(keywordStr)) {
                    fallback = 'University campus, academic building, library, modern educational institution, student environment, professional academic setting.';
                }
            }
            var composition = isMo
                ? 'Leave top 60% of frame empty for typography.'
                : 'Leave left 60% of frame empty for typography.';
            var parts = [base, themeFirst, fallback, modePrompt, kw, instruction, composition].filter(Boolean);
            return parts.join(' ');
        }
        
        // í”„ë¡¬í”„íŠ¸ + ë¸Œëœë“œ/í‚¤ì›Œë“œ ë³µì‚¬ìš© ê²°ê³¼ (Gemini Creative Director + í“¨ì „)
        async function getPromptResult(selectedBrand, selectedKeyword, campaignIntent, aiMode, hasReferenceImage) {
            console.log('ğŸ”µ [ì§„í–‰ ë‹¨ê³„] í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œì‘');
            setGenerateStatus('í¬ë¦¬ì—ì´í‹°ë¸Œ ë””ë ‰í„°ê°€ ë°°ê²½ì„ ì„¤ê³„í•˜ëŠ” ì¤‘...');
            
            // ì°¸ì¡° ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš° í¬ê¸° í™•ì¸ ë° ê²½ê³ 
            if (hasReferenceImage && referenceImageUrl) {
                var base64Length = referenceImageUrl.length;
                var estimatedSizeKB = Math.round((base64Length - 22) * 0.75 / 1024); // data:image/jpeg;base64, ì œì™¸
                console.log('ğŸ“Š ì°¸ì¡° ì´ë¯¸ì§€ í¬ê¸°:', estimatedSizeKB + ' KB (base64)');
                if (estimatedSizeKB > 500) {
                    console.warn('âš ï¸ ì°¸ì¡° ì´ë¯¸ì§€ê°€ í½ë‹ˆë‹¤ (' + estimatedSizeKB + ' KB). API ìš”ì²­ í¬ê¸°ê°€ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
            }
            
            var geminiBackground = await callGeminiCreativeDirector(selectedKeyword, campaignIntent, aiMode, hasReferenceImage);
            console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] í”„ë¡¬í”„íŠ¸ í“¨ì „ ì¤‘...');
            var imagePromptPc = fusePrompt(selectedBrand, selectedKeyword, campaignIntent, geminiBackground, false, aiMode);
            var imagePromptMo = fusePrompt(selectedBrand, selectedKeyword, campaignIntent, geminiBackground, true, aiMode);
            console.log('âœ… [ì§„í–‰ ë‹¨ê³„] í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ');
            var brand = BRAND_ASSETS[selectedBrand];
            var brandCopy = (brand && brand.fullName) ? brand.fullName + ' 26SS ì»¬ë ‰ì…˜' : (selectedBrand || '') + ' 26SS ì»¬ë ‰ì…˜';
            return {
                imagePrompt: imagePromptPc,
                imagePromptMo: imagePromptMo,
                brandCopy: brandCopy,
                keywordCopy: selectedKeyword || ''
            };
        }
        
        // â€”â€”â€” 4. fal.ai Flux ì´ë¯¸ì§€ ìƒì„± (í‚¤ì›Œë“œÂ·ì§€ì¹¨ ìš°ì„ , ì°¸ì¡° ì´ë¯¸ì§€ ìˆìœ¼ë©´ 2ë‹¨ê³„ ì ‘ê·¼: ë°°ê²½ ë¨¼ì € ìƒì„± í›„ ì œí’ˆ í•©ì„±) â€”â€”â€”
        function fetchNanoBananaImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl) {
            var imageType = isMo ? 'MO' : 'PC';
            console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] FAL API í˜¸ì¶œ ì¤‘... (' + imageType + ' ì´ë¯¸ì§€ ìƒì„±)');
            
            var imageSize = isMo ? 'portrait_16_9' : 'landscape_16_9';
            var negativePrompt = 'text, watermark, blurry, distorted, deformed';
            var apiKey = getEffectiveFalApiKey();
            var useDirectFal = !!(apiKey && String(apiKey).trim());
            if (!API_BASE) {
                if (!useDirectFal) {
                    return Promise.reject(new Error('ì„œë²„ ì—†ì´ ì‚¬ìš©í•˜ë ¤ë©´ config.jsì— FAL API í‚¤ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”. (fal.ai ê°€ì… í›„ API í‚¤ ë°œê¸‰) ë˜ëŠ” ë¡œì»¬ì—ì„œ node server.jsë¥¼ ì‹¤í–‰í•œ ë’¤ ì‚¬ìš©í•˜ì„¸ìš”.'));
                }
                useDirectFal = true;
            }
            // ì„œë²„ ì—†ì„ ë•ŒëŠ” ì ˆëŒ€ ìƒëŒ€ ê²½ë¡œ /api/... ì‚¬ìš© ê¸ˆì§€ (GitHub Pagesì—ì„œ 405 ë°©ì§€)
            function falTextToImageUrl() { return useDirectFal ? 'https://fal.run/fal-ai/flux/dev' : (API_BASE + '/api/fal/text-to-image'); }
            function falImageToImageUrl() { return useDirectFal ? 'https://fal.run/fal-ai/flux/dev/image-to-image' : (API_BASE + '/api/fal/image-to-image'); }
            function falOpts(body) { return useDirectFal ? { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Key ' + apiKey }, body: JSON.stringify(body) } : { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }; }
            
            // ì°¸ì¡° ì´ë¯¸ì§€(íŒŒì¼ data URL ë˜ëŠ” ì´ë¯¸ì§€ URL)ê°€ ìˆìœ¼ë©´ 2ë‹¨ê³„: í‚¤ì›Œë“œ ë°°ê²½ ìƒì„± â†’ ì œí’ˆ í•©ì„±
            if (productImageUrl) {
                var isUrl = typeof productImageUrl === 'string' && /^https?:\/\//i.test(productImageUrl.trim());
                console.log('ğŸ”„ [2ë‹¨ê³„ ì ‘ê·¼] ì°¸ì¡° ì´ë¯¸ì§€ ì‚¬ìš© (' + (isUrl ? 'URL' : 'ì—…ë¡œë“œ') + ') â†’ 1ë‹¨ê³„: í‚¤ì›Œë“œ ë°°ê²½ ìƒì„±...');
                
                var backgroundPrompt = fusedPrompt + ' This is a background scene only. No products, no subjects, no objects in the foreground. Just the environment, setting, atmosphere, and scene that represents the keyword theme. The background should fill the entire image.';
                var backgroundNegativePrompt = negativePrompt + ', product, object, subject, person, item, thing, foreground object, main subject';
                var body1 = { prompt: backgroundPrompt, image_size: imageSize, negative_prompt: backgroundNegativePrompt, seed: seed != null ? seed : undefined };
                
                return fetch(falTextToImageUrl(), falOpts(body1))
                .then(function(r) {
                    if (!r.ok) {
                        return r.json().then(function(errorData) {
                            throw { response: r, errorData: errorData };
                        }).catch(function() {
                            throw { response: r, errorData: { error: { message: 'Unknown error' } } };
                        });
                    }
                    return r.json();
                })
                .then(function(data) {
                    var backgroundUrl = (data && data.images && data.images[0] && data.images[0].url) ? data.images[0].url : null;
                    if (!backgroundUrl) throw new Error('ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
                    
                    console.log('âœ… [2ë‹¨ê³„ ì ‘ê·¼] 1ë‹¨ê³„ ì™„ë£Œ: ë°°ê²½ ìƒì„±ë¨');
                    console.log('ğŸ”„ [2ë‹¨ê³„ ì ‘ê·¼] 2ë‹¨ê³„: ë°°ê²½ ìœ„ì— ì œí’ˆ í•©ì„±...');
                    
                    // 2ë‹¨ê³„: ì œí’ˆ ì´ë¯¸ì§€ë¥¼ ì°¸ì¡°ë¡œ ì‚¬ìš©í•˜ë˜, ë°°ê²½ì€ ì™„ì „íˆ ë¬´ì‹œí•˜ê³  ìƒì„±ëœ ë°°ê²½ìœ¼ë¡œ êµì²´
                    // í•µì‹¬: ì œí’ˆ ì´ë¯¸ì§€ì˜ ì œí’ˆë§Œ ì¶”ì¶œí•˜ê³ , ë°°ê²½ì€ ìƒì„±ëœ ë°°ê²½ìœ¼ë¡œ ì™„ì „íˆ êµì²´
                    var imageUrlForApi = (typeof productImageUrl === 'string' && productImageUrl.trim()) ? productImageUrl.trim() : productImageUrl;
                    var strength = 0.12; // ë§¤ìš° ë‚®ì€ strengthë¡œ ì œí’ˆë§Œ ìœ ì§€í•˜ê³  ë°°ê²½ì€ ì™„ì „íˆ êµì²´
                    
                    // í”„ë¡¬í”„íŠ¸: ìƒì„±ëœ ë°°ê²½ì„ ê°•ì¡°í•˜ê³ , ì œí’ˆì€ ì°¸ì¡° ì´ë¯¸ì§€ì—ì„œë§Œ ê°€ì ¸ì˜¤ë„ë¡
                    // ë°°ê²½ êµì²´ë¥¼ ë§¤ìš° ê°•ë ¥í•˜ê²Œ ì§€ì‹œ
                    var compositePrompt = fusedPrompt + ' IGNORE AND COMPLETELY REMOVE the background from the reference image. REPLACE it entirely with this keyword-themed background scene. Extract ONLY the main product/subject (clothing, item, object) from the reference image and place it naturally within the new keyword-themed background. The original background (black, grey, white, or any solid color) must be completely gone and replaced with the keyword scene. The product should appear as if it was photographed in this new environment. Do not preserve any part of the original background.';
                    
                    var body2 = { image_url: imageUrlForApi, prompt: compositePrompt, strength: strength, image_size: imageSize, negative_prompt: negativePrompt + ', plain background, grey background, simple background, black background, white background, neutral background, product photography background, studio background, solid color background, monochrome background, uniform background, empty background, void background', seed: seed != null ? seed : undefined };
                    return fetch(falImageToImageUrl(), falOpts(body2))
                    .then(function(r2) {
                        if (!r2.ok) {
                            return r2.json().then(function(errorData) {
                                throw { response: r2, errorData: errorData };
                            }).catch(function() {
                                throw { response: r2, errorData: { error: { message: 'Unknown error' } } };
                            });
                        }
                        return r2.json();
                    })
                    .then(function(data2) {
                        var compositeUrl = (data2 && data2.images && data2.images[0] && data2.images[0].url) ? data2.images[0].url : null;
                        if (!compositeUrl) {
                            console.warn('âš ï¸ ì œí’ˆ í•©ì„± ì‹¤íŒ¨, ë°°ê²½ë§Œ ë°˜í™˜');
                            return backgroundUrl;
                        }
                        console.log('âœ… [2ë‹¨ê³„ ì ‘ê·¼] 2ë‹¨ê³„ ì™„ë£Œ: ì œí’ˆ í•©ì„±ë¨');
                        return compositeUrl;
                    })
                    .catch(function(err2) {
                        console.warn('âš ï¸ ì œí’ˆ í•©ì„± ë‹¨ê³„ ì˜¤ë¥˜ (ë°°ê²½ë§Œ ë°˜í™˜):', err2 && (err2.message || err2.errorData));
                        return backgroundUrl;
                    });
                })
                .then(function(finalUrl) {
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (' + imageType + ')');
                    return finalUrl;
                })
                .catch(function(err) {
                    console.error('âŒ FAL API ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (' + imageType + ')');
                    // ì—ëŸ¬ ì²˜ë¦¬ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
                    var sanitizedError = sanitizeErrorForLogging(err);
                    if (sanitizedError) {
                        console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                        if (sanitizedError.response) {
                            console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', sanitizedError.response.status, '(' + sanitizedError.response.statusText + ')');
                            console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(sanitizedError.response.status));
                            if (sanitizedError.response.data) {
                                console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', sanitizedError.response.data);
                            }
                        }
                    }
                    return 'https://picsum.photos/seed/fallback/1920/1080';
                });
            } else {
                // ì°¸ì¡° ì´ë¯¸ì§€ ì—†ìœ¼ë©´ text-to-image â€” ì„œë²„ /api/fal/text-to-image
                var body = { prompt: fusedPrompt, image_size: imageSize, negative_prompt: negativePrompt };
                if (seed != null) body.seed = seed;
                var responseObj = null;
                return fetch(falTextToImageUrl(), falOpts(body))
                    .then(function(r) {
                        responseObj = r;
                        if (!r.ok) {
                            return r.json().then(function(errorData) {
                                throw { response: r, errorData: errorData };
                            }).catch(function() {
                                throw { response: r, errorData: { error: { message: 'Unknown error' } } };
                            });
                        }
                        console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL API ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ (' + imageType + ')');
                        return r.json();
                    })
                    .then(function(data) {
                        console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] ì‘ë‹µ ë°ì´í„° íŒŒì‹± ì¤‘... (' + imageType + ')');
                        var url = (data && data.images && data.images[0] && data.images[0].url) ? data.images[0].url : null;
                        if (!url) throw new Error('fal.ai ì´ë¯¸ì§€ URL ì—†ìŒ');
                        console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (' + imageType + ')');
                        return url;
                    })
                    .catch(function(err) {
                        console.error('âŒ FAL API ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (' + imageType + ')');
                        
                        // ìƒì„¸ ì—ëŸ¬ ì •ë³´ ì¶œë ¥
                        var sanitizedError = sanitizeErrorForLogging(err);
                        if (sanitizedError) {
                            console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                            if (sanitizedError.response) {
                                console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', sanitizedError.response.status, '(' + sanitizedError.response.statusText + ')');
                                console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(sanitizedError.response.status));
                                if (sanitizedError.response.data) {
                                    console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', sanitizedError.response.data);
                                }
                            }
                        }
                        
                        // responseObjê°€ ìˆëŠ” ê²½ìš° (fetch ì„±ê³µí–ˆì§€ë§Œ !r.okì¸ ê²½ìš°)
                        if (responseObj) {
                            console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', responseObj.status, '(' + responseObj.statusText + ')');
                            console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(responseObj.status));
                        }
                        
                        // err.errorDataê°€ ìˆëŠ” ê²½ìš° (ì‘ë‹µ ë³¸ë¬¸ íŒŒì‹± ì„±ê³µ)
                        if (err && err.errorData) {
                            var safeErrorData = JSON.stringify(err.errorData).replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                            safeErrorData = safeErrorData.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                            try {
                                console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„° (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', JSON.parse(safeErrorData));
                            } catch (e) {
                                console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', safeErrorData);
                            }
                        }
                        
                        // ì „ì²´ ì—ëŸ¬ ê°ì²´ ì¶œë ¥
                        try {
                            var errorObj = {
                                name: err.name || 'Error',
                                message: sanitizedError ? sanitizedError.message : (err.message || String(err)),
                                response: sanitizedError ? sanitizedError.response : (err.response || null),
                                errorData: err.errorData || null
                            };
                            console.error('ğŸ“¦ ì „ì²´ ì—ëŸ¬ ê°ì²´ (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', errorObj);
                        } catch (e) {
                            console.error('âš ï¸ ì—ëŸ¬ ê°ì²´ ì§ë ¬í™” ì‹¤íŒ¨');
                        }
                        
                    return 'https://picsum.photos/seed/fallback/1920/1080';
                });
            }
        }
        
        // â€”â€”â€” 5. Replicate API ì´ë¯¸ì§€ ìƒì„± (ControlNetìœ¼ë¡œ ì •í™•í•œ ë°°ê²½ êµì²´) â€”â€”â€”
        function fetchReplicateImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl, retried) {
            if (!API_BASE) {
                return Promise.reject(new Error('ReplicateëŠ” ì„œë²„(node server.js) ì‹¤í–‰ í›„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì§€ê¸ˆì€ FAL APIë¥¼ ì„ íƒí•˜ê±°ë‚˜, ë¡œì»¬ì—ì„œ node server.jsë¥¼ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.'));
            }
            var imageType = isMo ? 'MO' : 'PC';
            if (retried) console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] Replicate API ì¬ì‹œë„ ì¤‘... (' + imageType + ')');
            else console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] Replicate API í˜¸ì¶œ ì¤‘... (' + imageType + ' ì´ë¯¸ì§€ ìƒì„±)');
            if (fusedPrompt && fusedPrompt.trim()) {
                console.log('ğŸ“ Replicateì— ì „ë‹¬í•˜ëŠ” í”„ë¡¬í”„íŠ¸:', fusedPrompt.trim().substring(0, 200) + (fusedPrompt.length > 200 ? '...' : ''));
            } else {
                console.warn('âš ï¸ Replicate í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í‚¤ì›Œë“œ ë°˜ì˜ ì´ë¯¸ì§€ê°€ ë‚˜ì˜¤ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            // Replicate API í‚¤ëŠ” ì„œë²„(.env)ì—ì„œ ê´€ë¦¬. ì„œë²„ì— ì—†ìœ¼ë©´ 503 ë°˜í™˜
            
            // ì°¸ì¡° ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ 2ë‹¨ê³„ ì ‘ê·¼ (ë°°ê²½ ìƒì„± â†’ ì œí’ˆ í•©ì„±)
            if (productImageUrl) {
                console.log('ğŸ”„ [Replicate 2ë‹¨ê³„ ì ‘ê·¼] 1ë‹¨ê³„: í‚¤ì›Œë“œ ë°°ê²½ ë¨¼ì € ìƒì„±...');
                
                // 1ë‹¨ê³„: í‚¤ì›Œë“œ ë°°ê²½ë§Œ ë¨¼ì € ìƒì„±
                var backgroundPrompt = fusedPrompt + ' This is a background scene only. No products, no subjects, no objects in the foreground. Just the environment, setting, atmosphere, and scene that represents the keyword theme. The background should fill the entire image.';
                
                // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ Replicate API í˜¸ì¶œ (CORS ë¬¸ì œ í•´ê²°)
                var proxyUrl = API_BASE + '/api/replicate';
                return fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        version: "black-forest-labs/flux-dev",
                        input: {
                            prompt: backgroundPrompt,
                            aspect_ratio: isMo ? '9:16' : '16:9',
                            output_format: 'webp',
                            seed: seed != null ? seed : undefined
                        }
                    })
                })
                .then(function(r) {
                    if (!r.ok) {
                        return r.json().then(function(errorData) {
                            throw { response: r, errorData: errorData };
                        }).catch(function() {
                            throw { response: r, errorData: { error: { message: 'Unknown error' } } };
                        });
                    }
                    return r.json();
                })
                .then(function(data) {
                    // ReplicateëŠ” ë¹„ë™ê¸° ì²˜ë¦¬ì´ë¯€ë¡œ predictionì„ í™•ì¸í•´ì•¼ í•¨
                    var predictionId = data.id;
                    console.log('âœ… [Replicate 2ë‹¨ê³„ ì ‘ê·¼] 1ë‹¨ê³„ ì˜ˆì¸¡ ìƒì„±ë¨:', predictionId);
                    
                    // ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
                    function waitForPrediction(predictionId) {
                        return new Promise(function(resolve, reject) {
                            function checkStatus() {
                                // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ ìƒíƒœ í™•ì¸
                                fetch(API_BASE + '/api/replicate/' + predictionId)
                                .then(function(r) { return r.json(); })
                                .then(function(prediction) {
                                    if (prediction.status === 'succeeded') {
                                        var backgroundUrl = prediction.output && prediction.output[0] ? prediction.output[0] : null;
                                        if (!backgroundUrl) {
                                            reject(new Error('ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨'));
                                            return;
                                        }
                                        console.log('âœ… [Replicate 2ë‹¨ê³„ ì ‘ê·¼] 1ë‹¨ê³„ ì™„ë£Œ: ë°°ê²½ ìƒì„±ë¨');
                                        console.log('ğŸ”„ [Replicate 2ë‹¨ê³„ ì ‘ê·¼] 2ë‹¨ê³„: ë°°ê²½ ìœ„ì— ì œí’ˆ í•©ì„±...');
                                        
                                        // 2ë‹¨ê³„: ControlNetìœ¼ë¡œ ë°°ê²½ ìœ„ì— ì œí’ˆ í•©ì„±
                                        var imageUrlForApi = (typeof productImageUrl === 'string' && productImageUrl.trim()) ? productImageUrl.trim() : productImageUrl;
                                        var compositePrompt = fusedPrompt + ' Place the product/subject from the reference image naturally into this background scene. The product should blend seamlessly into the environment. Keep the background scene unchanged - only add the product from the reference image.';
                                        
                                        // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ Replicate API í˜¸ì¶œ
                                        fetch(API_BASE + '/api/replicate', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({
                                                version: "runvnc/controlnet2",
                                                input: {
                                                    image: imageUrlForApi,
                                                    prompt: compositePrompt,
                                                    structure: "background_mask",
                                                    strength: 0.8,
                                                    scale: 7.5
                                                }
                                            })
                                        })
                                        .then(function(r2) {
                                            if (!r2.ok) {
                                                return r2.json().then(function(errorData) {
                                                    throw { response: r2, errorData: errorData };
                                                });
                                            }
                                            return r2.json();
                                        })
                                        .then(function(data2) {
                                            var compositePredictionId = data2.id;
                                            return waitForPrediction(compositePredictionId);
                                        })
                                        .then(function(finalUrl) {
                                            console.log('âœ… [Replicate 2ë‹¨ê³„ ì ‘ê·¼] 2ë‹¨ê³„ ì™„ë£Œ: ì œí’ˆ í•©ì„±ë¨');
                                            resolve(finalUrl);
                                        })
                                        .catch(function(err) {
                                            console.warn('âš ï¸ ì œí’ˆ í•©ì„± ì‹¤íŒ¨, ë°°ê²½ë§Œ ë°˜í™˜');
                                            resolve(backgroundUrl);
                                        });
                                    } else if (prediction.status === 'failed') {
                                        reject(new Error(prediction.error || 'ì˜ˆì¸¡ ì‹¤íŒ¨'));
                                    } else {
                                        // ì•„ì§ ì²˜ë¦¬ ì¤‘ì´ë©´ 1ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸
                                        setTimeout(checkStatus, 1000);
                                    }
                                })
                                .catch(reject);
                            }
                            checkStatus();
                        });
                    }
                    
                    return waitForPrediction(predictionId);
                })
                .then(function(finalUrl) {
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] Replicate ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (' + imageType + ')');
                    return finalUrl;
                })
                .catch(function(err) {
                    console.error('âŒ Replicate API ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (' + imageType + ')');
                    var sanitizedError = sanitizeErrorForLogging(err);
                    if (sanitizedError) {
                        console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                        if (sanitizedError.response) {
                            console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', sanitizedError.response.status);
                        }
                    }
                    if (err.response && err.response.status === 429 && !retried) {
                        console.warn('â³ 429 í•œë„ ì´ˆê³¼. 35ì´ˆ í›„ ìë™ ì¬ì‹œë„ (1íšŒ)...');
                        if (typeof setGenerateStatus === 'function') setGenerateStatus('Replicate í•œë„ ì´ˆê³¼. 35ì´ˆ í›„ ìë™ ì¬ì‹œë„...');
                        return new Promise(function(go) { setTimeout(go, 35000); }).then(function() {
                            if (typeof setGenerateStatus === 'function') setGenerateStatus('ì¬ì‹œë„ ì¤‘...');
                            return fetchReplicateImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl, true);
                        });
                    }
                    return Promise.reject(err);
                });
            } else {
                // ì°¸ì¡° ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ë°°ê²½ë§Œ ìƒì„±
                // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ Replicate API í˜¸ì¶œ
                return fetch(API_BASE + '/api/replicate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        version: "black-forest-labs/flux-dev",
                        input: {
                            prompt: fusedPrompt,
                            aspect_ratio: isMo ? '9:16' : '16:9',
                            output_format: 'webp',
                            seed: seed != null ? seed : undefined
                        }
                    })
                })
                .then(function(r) {
                    if (!r.ok) {
                        return r.json().then(function(errorData) {
                            throw { response: r, errorData: errorData };
                        }).catch(function() {
                            throw { response: r, errorData: { error: 'ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨' } };
                        });
                    }
                    return r.json();
                })
                .catch(function(err) {
                    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ì„œë²„ ë¯¸ì‹¤í–‰ ë“±)
                    if (err.message && (err.message.includes('Failed to fetch') || err.message.includes('ERR_CONNECTION_REFUSED'))) {
                        console.error('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: server.jsê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                        console.error('ğŸ’¡ í•´ê²° ë°©ë²•: í„°ë¯¸ë„ì—ì„œ "node server.js" ì‹¤í–‰ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                        console.log('ğŸ’¡ ìë™ìœ¼ë¡œ FAL APIë¡œ í´ë°±í•©ë‹ˆë‹¤.');
                        return fetchNanoBananaImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl);
                    }
                    throw err;
                })
                .then(function(data) {
                    // dataê°€ ì´ë¯¸ FAL API ê²°ê³¼(URL ë¬¸ìì—´)ì¸ ê²½ìš°
                    if (typeof data === 'string') {
                        return data;
                    }
                    var predictionId = data.id;
                    function waitForPrediction(predictionId) {
                        return new Promise(function(resolve, reject) {
                            function checkStatus() {
                                // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ ìƒíƒœ í™•ì¸
                                fetch(API_BASE + '/api/replicate/' + predictionId)
                                .then(function(r) { return r.json(); })
                                .then(function(prediction) {
                                    if (prediction.status === 'succeeded') {
                                        var url = prediction.output && prediction.output[0] ? prediction.output[0] : null;
                                        if (!url) reject(new Error('ì´ë¯¸ì§€ URL ì—†ìŒ'));
                                        else resolve(url);
                                    } else if (prediction.status === 'failed') {
                                        reject(new Error(prediction.error || 'ì˜ˆì¸¡ ì‹¤íŒ¨'));
                                    } else {
                                        setTimeout(checkStatus, 1000);
                                    }
                                })
                                .catch(function(err) {
                                    if (err.message && (err.message.includes('Failed to fetch') || err.message.includes('ERR_CONNECTION_REFUSED'))) {
                                        console.error('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: waitForPrediction ì¤‘');
                                        console.log('ğŸ’¡ ìë™ìœ¼ë¡œ FAL APIë¡œ í´ë°±í•©ë‹ˆë‹¤.');
                                        fetchNanoBananaImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl)
                                            .then(resolve)
                                            .catch(reject);
                                    } else {
                                        reject(err);
                                    }
                                });
                            }
                            checkStatus();
                        });
                    }
                    return waitForPrediction(predictionId);
                })
                .then(function(url) {
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] Replicate ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (' + imageType + ')');
                    return url;
                })
                .catch(function(err) {
                    console.error('âŒ Replicate API ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (' + imageType + ')');
                    if (err.message && (err.message.includes('Failed to fetch') || err.message.includes('ERR_CONNECTION_REFUSED'))) {
                        console.error('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: server.jsê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”. (node server.js)');
                        console.error('ğŸ’¡ ìë™ìœ¼ë¡œ FAL APIë¡œ í´ë°±í•©ë‹ˆë‹¤.');
                        return fetchNanoBananaImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl);
                    }
                    if (err.response && err.response.status === 429 && !retried) {
                        console.warn('â³ 429 í•œë„ ì´ˆê³¼. 35ì´ˆ í›„ ìë™ ì¬ì‹œë„ (1íšŒ)...');
                        if (typeof setGenerateStatus === 'function') setGenerateStatus('Replicate í•œë„ ì´ˆê³¼. 35ì´ˆ í›„ ìë™ ì¬ì‹œë„...');
                        return new Promise(function(go) { setTimeout(go, 35000); }).then(function() {
                            if (typeof setGenerateStatus === 'function') setGenerateStatus('ì¬ì‹œë„ ì¤‘...');
                            return fetchReplicateImage(selectedBrand, fusedPrompt, seed, isMo, productImageUrl, true);
                        });
                    }
                    return Promise.reject(err);
                });
            }
        }
        
        // fal.ai Flux Image-to-Image (ë””ë²¨ë¡­: í˜„ì¬ ì´ë¯¸ì§€ URL + í”¼ë“œë°±, strength 0.45)
        function fetchFluxImageToImage(imageUrl, prompt, strength) {
            var falKey = getEffectiveFalApiKey();
            var useDirect = !!(falKey && String(falKey).trim());
            if (!API_BASE) {
                if (!useDirect) return Promise.reject(new Error('ì„œë²„ ì—†ì´ ì‚¬ìš©í•˜ë ¤ë©´ config.jsì— FAL API í‚¤ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”. ë˜ëŠ” node server.jsë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.'));
                useDirect = true;
            }
            console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] FAL API ì´ë¯¸ì§€ ë””ë²¨ë¡­ ì¤‘...' + (useDirect ? ' (ì§ì ‘ fal.run)' : ' (ì„œë²„ /api/fal/image-to-image)'));
            strength = strength == null ? 0.45 : Math.min(1, Math.max(0, strength));
            var body = { image_url: imageUrl, prompt: prompt || 'Keep the same composition, improve quality.', strength: strength };
            var url = useDirect ? 'https://fal.run/fal-ai/flux/dev/image-to-image' : (API_BASE + '/api/fal/image-to-image');
            var opts = useDirect ? { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Key ' + falKey }, body: JSON.stringify(body) } : { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) };
            var responseObj = null;
            return fetch(url, opts)
                .then(function(r) {
                    responseObj = r;
                    if (!r.ok) {
                        return r.json().then(function(errorData) {
                            throw { response: r, errorData: errorData };
                        }).catch(function() {
                            throw { response: r, errorData: { error: { message: 'Unknown error' } } };
                        });
                    }
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL API ë””ë²¨ë¡­ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ');
                    return r.json();
                })
                .then(function(data) {
                    console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] ë””ë²¨ë¡­ ì‘ë‹µ ë°ì´í„° íŒŒì‹± ì¤‘...');
                    var url = (data && data.images && data.images[0] && data.images[0].url) ? data.images[0].url : null;
                    if (!url) throw new Error('fal.ai image-to-image URL ì—†ìŒ');
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL ì´ë¯¸ì§€ ë””ë²¨ë¡­ ì™„ë£Œ');
                    return url;
                })
                .catch(function(err) {
                    console.error('âŒ FAL API ì´ë¯¸ì§€ ë””ë²¨ë¡­ ì‹¤íŒ¨');
                    
                    // ìƒì„¸ ì—ëŸ¬ ì •ë³´ ì¶œë ¥
                    var sanitizedError = sanitizeErrorForLogging(err);
                    if (sanitizedError) {
                        console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                        if (sanitizedError.response) {
                            console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', sanitizedError.response.status, '(' + sanitizedError.response.statusText + ')');
                            console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(sanitizedError.response.status));
                            if (sanitizedError.response.data) {
                                console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', sanitizedError.response.data);
                            }
                        }
                    }
                    
                    if (responseObj) {
                        console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', responseObj.status, '(' + responseObj.statusText + ')');
                        console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(responseObj.status));
                    }
                    
                    if (err && err.errorData) {
                        var safeErrorData = JSON.stringify(err.errorData).replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                        safeErrorData = safeErrorData.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                        try {
                            console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„° (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', JSON.parse(safeErrorData));
                        } catch (e) {
                            console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', safeErrorData);
                        }
                    }
                    
                    try {
                        var errorObj = {
                            name: err.name || 'Error',
                            message: sanitizedError ? sanitizedError.message : (err.message || String(err)),
                            response: sanitizedError ? sanitizedError.response : (err.response || null),
                            errorData: err.errorData || null
                        };
                        console.error('ğŸ“¦ ì „ì²´ ì—ëŸ¬ ê°ì²´ (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', errorObj);
                    } catch (e) {
                        console.error('âš ï¸ ì—ëŸ¬ ê°ì²´ ì§ë ¬í™” ì‹¤íŒ¨');
                    }
                    
                    return null;
                });
        }
        
        // MO ì‹œì•ˆì„ ê¸°ì¤€ìœ¼ë¡œ PC ì‹œì•ˆ ìƒì„± (ê°™ì€ ëŠë‚Œ ìœ ì§€, êµ¬ë„ë§Œ ê°€ë¡œë¡œ í™•ì¥. ì¸ë¬¼/ì œí’ˆ ë™ì¼)
        function fetchPcFromMoImage(moImageUrl, seed) {
            if (!moImageUrl) return Promise.resolve('');
            var falKey = getEffectiveFalApiKey();
            var useDirect = !!(falKey && String(falKey).trim());
            if (!API_BASE) {
                if (!useDirect) return Promise.reject(new Error('ì„œë²„ ì—†ì´ ì‚¬ìš©í•˜ë ¤ë©´ config.jsì— FAL API í‚¤ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”. ë˜ëŠ” node server.jsë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.'));
                useDirect = true;
            }
            console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] FAL API MOâ†’PC í™•ì¥ ì¤‘...');
            var prompt = 'Same exact image, same scene, same colors, same mood. Only recompose for horizontal layout: place the main content on the FAR RIGHT 40% of the frame. The LEFT 60% must be empty or same background for text. Landscape 16:9. Do not add or remove any object. No new person.';
            var body = { image_url: moImageUrl, prompt: prompt, strength: 0.42 };
            if (seed != null) body.seed = seed;
            var url = useDirect ? 'https://fal.run/fal-ai/flux/dev/image-to-image' : (API_BASE + '/api/fal/image-to-image');
            var opts = useDirect ? { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Key ' + falKey }, body: JSON.stringify(body) } : { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) };
            var responseObj = null;
            return fetch(url, opts)
                .then(function(r) {
                    responseObj = r;
                    if (!r.ok) {
                        return r.json().then(function(errorData) {
                            throw { response: r, errorData: errorData };
                        }).catch(function() {
                            throw { response: r, errorData: { error: { message: 'Unknown error' } } };
                        });
                    }
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL API MOâ†’PC í™•ì¥ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ');
                    return r.json();
                })
                .then(function(data) {
                    console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] MOâ†’PC í™•ì¥ ì‘ë‹µ ë°ì´í„° íŒŒì‹± ì¤‘...');
                    var url = (data && data.images && data.images[0] && data.images[0].url) ? data.images[0].url : null;
                    if (!url) throw new Error('fal.ai MOâ†’PC URL ì—†ìŒ');
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] FAL MOâ†’PC í™•ì¥ ì™„ë£Œ');
                    return url;
                })
                .catch(function(err) {
                    console.error('âŒ FAL API MOâ†’PC í™•ì¥ ì‹¤íŒ¨');
                    
                    // ìƒì„¸ ì—ëŸ¬ ì •ë³´ ì¶œë ¥
                    var sanitizedError = sanitizeErrorForLogging(err);
                    if (sanitizedError) {
                        console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                        if (sanitizedError.response) {
                            console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', sanitizedError.response.status, '(' + sanitizedError.response.statusText + ')');
                            console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(sanitizedError.response.status));
                            if (sanitizedError.response.data) {
                                console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', sanitizedError.response.data);
                            }
                        }
                    }
                    
                    if (responseObj) {
                        console.error('ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ:', responseObj.status, '(' + responseObj.statusText + ')');
                        console.error('ğŸ“‹ ìƒíƒœ ì½”ë“œ ì„¤ëª…:', getHttpStatusDescription(responseObj.status));
                    }
                    
                    if (err && err.errorData) {
                        var safeErrorData = JSON.stringify(err.errorData).replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                        safeErrorData = safeErrorData.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                        try {
                            console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„° (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', JSON.parse(safeErrorData));
                        } catch (e) {
                            console.error('ğŸ“„ ì‘ë‹µ ë°ì´í„°:', safeErrorData);
                        }
                    }
                    
                    try {
                        var errorObj = {
                            name: err.name || 'Error',
                            message: sanitizedError ? sanitizedError.message : (err.message || String(err)),
                            response: sanitizedError ? sanitizedError.response : (err.response || null),
                            errorData: err.errorData || null
                        };
                        console.error('ğŸ“¦ ì „ì²´ ì—ëŸ¬ ê°ì²´ (API í‚¤ ë§ˆìŠ¤í‚¹ë¨):', errorObj);
                    } catch (e) {
                        console.error('âš ï¸ ì—ëŸ¬ ê°ì²´ ì§ë ¬í™” ì‹¤íŒ¨');
                    }
                    
                    return '';
                });
        }
        
        // CSV íŒŒì‹± í•¨ìˆ˜
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const rows = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // CSV íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
                const values = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());
                
                rows.push(values);
            }
            
            return rows;
        }
        
        // Gì—´ ê²€ìƒ‰ëŸ‰ ë¬¸ìì—´ì„ ì •ë ¬ìš© ìˆ«ìë¡œ ë³€í™˜ (ì˜ˆ: "ê²€ìƒ‰ 200+íšŒ"â†’200, "ê²€ìƒ‰ 1ë§Œ+íšŒ"â†’10000)
        function parseCountForSort(countStr) {
            if (!countStr || typeof countStr !== 'string') return 0;
            const s = countStr.trim();
            if (s.toLowerCase().includes('search count')) return 0;
            const man = s.match(/(\d+)\s*ë§Œ/);
            if (man) return (parseInt(man[1], 10) || 0) * 10000;
            const chun = s.match(/(\d+)\s*ì²œ/);
            if (chun) return (parseInt(chun[1], 10) || 0) * 1000;
            const num = s.match(/(\d+)/);
            return num ? parseInt(num[1], 10) || 0 : 0;
        }
        
        // ê²€ìƒ‰ëŸ‰ í¬ë§·íŒ… í•¨ìˆ˜
        function formatSearchCount(count) {
            const num = parseInt(count);
            if (isNaN(num)) return count;
            
            if (num >= 100000) {
                return Math.floor(num / 10000) + 'ë§Œ+';
            } else if (num >= 10000) {
                return Math.floor(num / 1000) + 'ì²œ+';
            } else if (num >= 1000) {
                return Math.floor(num / 1000) + 'ì²œ+';
            }
            return num.toString();
        }
        
        // íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ UIì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function fetchTrends() {
            // ì›ë³¸ Google Sheets CSV URL (Trending Searches ì‹œíŠ¸, ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
            const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWv_8Md3vx8TZezAFvPUQuGJR2cKZZ-PcEelMqGqBhnSTyuXtQi54Kw2dauVa6t-4ZOul_7TiRPz_v/pub?gid=15033788&single=true&output=csv&t=' + Date.now();
            const trendsListContainer = document.getElementById('trendsList');
            const trendsUpdateTime = document.getElementById('trendsUpdateTime');
            
            // í”„ë¡ì‹œ URL ëª©ë¡ (í´ë°± ìˆœì„œ)
            const proxyUrls = [
                'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(originalUrl),
                'https://api.allorigins.win/raw?url=' + encodeURIComponent(originalUrl)
            ];
            
            let csvText = null;
            let lastError = null;
            
            try {
                // ë¡œë”© í‘œì‹œ
                trendsListContainer.innerHTML = '<div class="p-2 text-sm text-gray-500">ë¡œë”© ì¤‘...</div>';
                
                // í”„ë¡ì‹œë¥¼ í†µí•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
                for (let i = 0; i < proxyUrls.length; i++) {
                    try {
                        const response = await fetch(proxyUrls[i], {
                            mode: 'cors',
                            cache: 'no-store'
                        });
                        
                        if (response.ok) {
                            csvText = await response.text();
                            break;
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        lastError = error;
                        continue;
                    }
                }
                
                // í”„ë¡ì‹œê°€ ëª¨ë‘ ì‹¤íŒ¨í•˜ë©´ ì§ì ‘ fetch ì‹œë„
                if (!csvText) {
                    try {
                        const response = await fetch(originalUrl, {
                            mode: 'cors',
                            cache: 'no-store'
                        });
                        
                        if (response.ok) {
                            csvText = await response.text();
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        lastError = error;
                    }
                }
                
                // ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•œ ê²½ìš°
                if (!csvText) {
                    throw lastError || new Error('ëª¨ë“  ë°ì´í„° ë¡œë“œ ë°©ë²•ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ì‘ë‹µ í˜•ì‹ í™•ì¸ ë° ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”
                if (!csvText) {
                    throw new Error('CSV ì‘ë‹µì´ nullì…ë‹ˆë‹¤.');
                }
                
                // BOM ì œê±° (ì¼ë¶€ ë‚´ë³´ë‚´ê¸°/ì—‘ì…€ì—ì„œ ë¶™ëŠ” ê²½ìš°)
                csvText = csvText.replace(/^\uFEFF/, '');
                const trimmedText = csvText.trim();
                if (trimmedText === '' || trimmedText.length === 0) {
                    throw new Error('CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
                
                // CSVë¥¼ í–‰ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
                const lines = csvText.split('\n');
                const rows = [];
                
                // ê° í–‰ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // CSV íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
                    const values = [];
                    let currentValue = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue.trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue.trim());
                    
                    rows.push(values);
                }
                
                // ì‹œíŠ¸ êµ¬ì¡°: 1í–‰=í—¤ë”, Aì—´(0)=ì‹œê°„, Fì—´(5)=ê²€ìƒ‰ì–´, Gì—´(6)=ê²€ìƒ‰ëŸ‰ (ê³ ì •)
                const dataStartIndex = 1;
                const timeCol = 0;
                const keywordCol = 5;
                const countCol = 6;
                
                // ê¸°ì¤€ ì‹œê°„: ë§ˆì§€ë§‰ ë°ì´í„° í–‰ì˜ Aì—´ ê°’
                let targetTime = null;
                for (let i = rows.length - 1; i >= dataStartIndex; i--) {
                    const row = rows[i];
                    if (row && row.length > timeCol && row[timeCol] != null && String(row[timeCol]).trim() !== '') {
                        targetTime = String(row[timeCol]).trim();
                        break;
                    }
                }
                
                if (!targetTime) {
                    throw new Error('ìµœì‹  ì‹œê°„ëŒ€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ë™ì¼ ì‹œê°„ëŒ€ í–‰ë§Œ ì¶”ì¶œ (1í–‰ì€ í—¤ë” ì œì™¸)
                const latestRows = [];
                for (let i = dataStartIndex; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length > countCol) {
                        const timeValue = String(row[timeCol] ?? '').trim();
                        if (timeValue === targetTime) latestRows.push(row);
                    }
                }
                
                // ì‹œê°„ëŒ€ ì¼ì¹˜ í–‰ì´ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„° í–‰ ì‚¬ìš©
                let rowsToUse = latestRows.length > 0 ? latestRows : rows.slice(dataStartIndex);
                
                trendsUpdateTime.textContent = `íŠ¸ë Œë“œ (${targetTime} ì—…ë°ì´íŠ¸ë¨)`;
                trendsListContainer.innerHTML = '';
                
                if (rowsToUse.length === 0) {
                    trendsListContainer.innerHTML = '<div class="p-2 text-sm text-gray-500">í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    currentTrendKeywords = [];
                    updateInsight();
                    return;
                }
                
                // Fì—´=ê²€ìƒ‰ì–´, Gì—´=ê²€ìƒ‰ëŸ‰ â€” Gì—´ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ, ì •ë ¬ìš© ìˆ«ìë§Œ íŒŒì‹±
                const keywordRows = [];
                rowsToUse.forEach((row) => {
                    const keyword = (row[keywordCol] != null ? String(row[keywordCol]) : '').trim();
                    if (!keyword) return;
                    if (keyword.toLowerCase().includes('search term')) return;
                    const countDisplay = (row[countCol] != null ? String(row[countCol]) : '').trim();
                    const sortNum = parseCountForSort(countDisplay);
                    keywordRows.push({ keyword, countDisplay: countDisplay || '-', searchCount: sortNum });
                });
                keywordRows.sort((a, b) => b.searchCount - a.searchCount);
                currentTrendKeywords = keywordRows;
                
                // ë¦¬ìŠ¤íŠ¸ UI ìƒì„± (ê²€ìƒ‰ëŸ‰ì€ Gì—´ ê°’ ê·¸ëŒ€ë¡œ í‘œì‹œ)
                keywordRows.forEach(({ keyword, countDisplay }) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'p-2 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center trend-item';
                    listItem.dataset.keyword = keyword;
                    
                    listItem.addEventListener('click', function() {
                        document.querySelectorAll('.trend-item').forEach(item => {
                            item.classList.remove('border-2', 'border-indigo-500', 'bg-indigo-50');
                            const keywordSpan = item.querySelector('.keyword-text');
                            const countDiv = item.querySelector('.count-text');
                            if (keywordSpan) keywordSpan.classList.remove('font-bold', 'text-indigo-600');
                            if (countDiv) countDiv.classList.remove('text-indigo-600');
                        });
                        this.classList.add('border-2', 'border-indigo-500', 'bg-indigo-50');
                        const keywordSpan = this.querySelector('.keyword-text');
                        const countDiv = this.querySelector('.count-text');
                        if (keywordSpan) keywordSpan.classList.add('font-bold', 'text-indigo-600');
                        if (countDiv) countDiv.classList.add('text-indigo-600');
                        selectedKeyword = keyword;
                        updateInsight();
                    });
                    
                    listItem.innerHTML = `
                        <span class="text-sm text-gray-700 keyword-text">${keyword}</span>
                        <div class="text-right">
                            <div class="text-sm font-bold count-text">${countDisplay || '-'}</div>
                            <div class="text-xs text-red-500">â†‘ ${Math.floor(Math.random() * 900 + 100)}%</div>
                        </div>
                    `;
                    trendsListContainer.appendChild(listItem);
                });
                
                // í‚¤ì›Œë“œ ë¡œë“œ ì§í›„ AI MD ì œì•ˆ ë¨¼ì € í‘œì‹œ
                updateInsight();
                
            } catch (error) {
                // ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ API í‚¤ ë§ˆìŠ¤í‚¹
                var safeErrorMsg = error.message || String(error);
                safeErrorMsg = maskApiKeyInUrl(safeErrorMsg);
                safeErrorMsg = safeErrorMsg.replace(/AIzaSy[A-Za-z0-9_-]+/g, function(match) { return maskApiKey(match); });
                safeErrorMsg = safeErrorMsg.replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]+/gi, function(match) { return maskApiKey(match); });
                
                console.error('âŒ íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', safeErrorMsg);
                
                // ë” ìì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                var errorMsg = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                if (error.message && error.message.includes('CORS')) {
                    errorMsg = 'CORS ì˜¤ë¥˜: Google Sheets ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
                } else if (error.message && error.message.includes('HTTP error')) {
                    errorMsg = 'HTTP ì˜¤ë¥˜: ì„œë²„ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                } else if (error.message && error.message.includes('ë¹„ì–´ìˆìŠµë‹ˆë‹¤')) {
                    errorMsg = 'CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Google Sheetsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
                
                trendsListContainer.innerHTML = '<div class="p-2 text-sm text-red-500">' + errorMsg + '</div>';
                trendsUpdateTime.textContent = 'íŠ¸ë Œë“œ (ì˜¤ë¥˜ ë°œìƒ)';
                
                // currentTrendKeywords ì´ˆê¸°í™”
                currentTrendKeywords = [];
                updateInsight();
            }
        }
        
        // AI MD ì œì•ˆ ë¬¸êµ¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (í‚¤ì›Œë“œ ë¡œë“œ í›„ ë¨¼ì € ì œì•ˆ, ì„ íƒ ì‹œ êµ¬ì²´í™”)
        function updateInsight() {
            const el = document.getElementById('aiInsightText');
            if (!el) return;
            
            const topN = currentTrendKeywords.slice(0, 5);
            const topKeywords = topN.map(k => k.keyword);
            const topKeywordStr = topKeywords.length ? topKeywords.join(', ') : '';
            
            if (selectedKeyword) {
                // ì‚¬ìš©ìê°€ í‚¤ì›Œë“œë¥¼ ì„ íƒí•œ ê²½ìš° â€” í•´ë‹¹ í‚¤ì›Œë“œ ê¸°ì¤€ êµ¬ì²´ì  ì œì•ˆ
                const keyword = selectedKeyword;
                const item = currentTrendKeywords.find(k => k.keyword === keyword);
                const vol = item && item.countDisplay ? item.countDisplay : (item ? formatSearchCount(String(item.searchCount)) : '');
                if (selectedBrand === 'DV') {
                    el.textContent = `[ì„ íƒ í‚¤ì›Œë“œ: ${keyword}${vol ? ' Â· ê²€ìƒ‰ëŸ‰ ' + vol : ''}]\n\n` +
                        `ì´ í‚¤ì›Œë“œë¥¼ ë©”ì¸ìœ¼ë¡œ í•œ ê°ì„± ë£©ë¶ ê¸°íšì„ ì¶”ì²œí•©ë‹ˆë‹¤. í—¤ë“œë¼ì¸ì—ëŠ” íŠ¸ë Œë“œ ê°ì„±(â€œ${keyword}â€)ì„ ë…¹ì´ê³ , ì„œë¸Œì¹´í”¼ì—ì„œëŠ” ì‹œì¦Œ ë¬´ë“œë‚˜ ì°©ìš© í¬ì¸íŠ¸ë¥¼ ì§§ê²Œ ê°•ì¡°í•˜ì„¸ìš”. ` +
                        `í…œí”Œë¦¿ A(ë°°ë„ˆí˜•) ë˜ëŠ” C(ë¦¬ìŠ¤íŠ¸í˜•)ë¡œ í‚¤ì›Œë“œ ë…¸ì¶œì„ í¬ê²Œ í•˜ë©´ ê²€ìƒ‰ ìœ ì…ì— ìœ ë¦¬í•©ë‹ˆë‹¤. ì°¸ì¡° ì´ë¯¸ì§€ëŠ” í•´ë‹¹ í‚¤ì›Œë“œì™€ ë§ëŠ” í•œ ë²Œ ì½”ë””ë‚˜ ë¬´ë“œ ì‚¬ì§„ì„ ë„£ì–´ ì£¼ì„¸ìš”.`;
                } else {
                    el.textContent = `[ì„ íƒ í‚¤ì›Œë“œ: ${keyword}${vol ? ' Â· ê²€ìƒ‰ëŸ‰ ' + vol : ''}]\n\n` +
                        `"${keyword}" ê²€ìƒ‰ëŸ‰ì´ ë†’ì€ ë§Œí¼, íƒ€ì„ì„¸ì¼Â·í•œì •ìˆ˜ëŸ‰Â·ì¦‰ì‹œ í• ì¸ ë“± ìœ ë‹ˆí¬ ì„¸ì¼ í¬ì¸íŠ¸ë¥¼ ì•ì— ë‘ëŠ” ì „ëµì„ ì¶”ì²œí•©ë‹ˆë‹¤. ` +
                        `í…œí”Œë¦¿ B(ì¹´ë“œí˜•)ë‚˜ D(ì´ë²¤íŠ¸í˜•)ë¡œ ê°€ê²©/í˜œíƒì„ ê°•ì¡°í•˜ê³ , ê¸°íš ì˜ë„ì—ëŠ” â€œí•œì • ê¸°ê°„â€, â€œì„ ì°© Nëª…â€ ë“±ì„ ëª…ì‹œí•˜ë©´ ì „í™˜ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.`;
                }
                return;
            }
            
            if (topN.length === 0) {
                el.textContent = 'íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì œì•ˆì´ í‘œì‹œë©ë‹ˆë‹¤.';
                return;
            }
            
            // í‚¤ì›Œë“œë§Œ ë¡œë“œëœ ìƒíƒœ â€” ì‚¬ìš©ì ì„ íƒ ì „, ìƒìœ„ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ë¨¼ì € ì œì•ˆ
            if (selectedBrand === 'DV') {
                el.textContent = `[í˜„ì¬ íŠ¸ë Œë“œ ìƒìœ„ í‚¤ì›Œë“œ: ${topKeywordStr}]\n\n` +
                    `ìœ„ í‚¤ì›Œë“œë¥¼ ë°˜ì˜í•œ ê°ì„± ë£©ë¶ ê¸°íšì„ ì¶”ì²œí•©ë‹ˆë‹¤. ê²€ìƒ‰ëŸ‰ì´ ë†’ì€ ìˆœìœ¼ë¡œ 1~2ê°œë¥¼ ë©”ì¸ í‚¤ì›Œë“œë¡œ ì •í•˜ê³ , í—¤ë“œë¼ì¸Â·ì„œë¸Œì¹´í”¼ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ ì£¼ì„¸ìš”. ` +
                    `í‚¤ì›Œë“œ ê°•ì¡°ê°€ ëª©í‘œë¼ë©´ í…œí”Œë¦¿ A(ë°°ë„ˆí˜•) ë˜ëŠ” C(ë¦¬ìŠ¤íŠ¸í˜•), ë¬´ë“œ ì¤‘ì‹¬ì´ë¼ë©´ B(ì¹´ë“œí˜•)ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ì™¼ìª½ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ê²€ìƒ‰ì–´ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œ ê¸°ì¤€ìœ¼ë¡œ ë” êµ¬ì²´ì ì¸ ì œì•ˆì„ ë“œë¦½ë‹ˆë‹¤.`;
            } else {
                el.textContent = `[í˜„ì¬ íŠ¸ë Œë“œ ìƒìœ„ í‚¤ì›Œë“œ: ${topKeywordStr}]\n\n` +
                    `ì´ í‚¤ì›Œë“œë“¤ì˜ ê²€ìƒ‰ ìˆ˜ìš”ë¥¼ í™œìš©í•´ íƒ€ì„ì„¸ì¼Â·í•œì • í˜œíƒ ì¤‘ì‹¬ ê¸°íšì„ ì¶”ì²œí•©ë‹ˆë‹¤. ìƒìœ„ 1~2ê°œë¥¼ ë©”ì¸ìœ¼ë¡œ ì¡ê³ , ê°€ê²©/í• ì¸/ì„ ì°©ìˆœì„ ê°•ì¡°í•˜ëŠ” ë¬¸êµ¬ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”. ` +
                    `í…œí”Œë¦¿ B(ì¹´ë“œí˜•) ë˜ëŠ” D(ì´ë²¤íŠ¸í˜•)ë¡œ ì„¸ì¼ì¦ˆ í¬ì¸íŠ¸ë¥¼ í¬ê²Œ ë…¸ì¶œí•˜ê³ , ê¸°íš ì˜ë„ì— â€œí•œì • ê¸°ê°„â€, â€œì„ ì°© Nëª…â€ ë“±ì„ ì ì–´ ë‘ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤. ì™¼ìª½ì—ì„œ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê²€ìƒ‰ì–´ ê¸°ì¤€ ë§ì¶¤ ì œì•ˆì„ ë“œë¦½ë‹ˆë‹¤.`;
            }
        }

        // ë¸Œëœë“œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupBrandSelection() {
            const brandRadios = document.querySelectorAll('input[name="brand"]');
            const checkedRadio = document.querySelector('input[name="brand"]:checked');
            if (checkedRadio) {
                selectedBrand = checkedRadio.value;
            }
            
            brandRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedBrand = this.value;
                    updateInsight();
                });
            });
        }
        
        // í…œí”Œë¦¿ ì¹´ë“œ ì„ íƒ ë° PC/MO í† ê¸€ ì„¤ì •
        function setupTemplateSelection() {
            const cards = document.querySelectorAll('.template-card');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    if (this.classList.contains('template-card--preparing') || this.dataset.template !== 'A') return;
                    const template = this.dataset.template;
                    selectedTemplate = template;

                    // ëª¨ë“  ì¹´ë“œì—ì„œ ì„ íƒ ìŠ¤íƒ€ì¼ ì œê±°
                    cards.forEach(c => {
                        c.classList.remove('ring-4', 'ring-indigo-500', 'ring-offset-2');
                        c.querySelector('.template-check').classList.add('hidden');
                    });
                    document.querySelectorAll('.template-variant').forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white', 'font-medium');
                        btn.classList.add('text-gray-500');
                    });

                    // ì„ íƒí•œ ì¹´ë“œì— ring + ì²´í¬ ì•„ì´ì½˜ í‘œì‹œ
                    this.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
                    this.querySelector('.template-check').classList.remove('hidden');

                    // ì„ íƒí•œ ì¹´ë“œ ë‚´ PC/MO ë²„íŠ¼ ì¤‘ í˜„ì¬ selectedVariant í™œì„±í™”
                    this.querySelectorAll('.template-variant').forEach(btn => {
                        if (btn.dataset.variant === selectedVariant) {
                            btn.classList.add('bg-indigo-600', 'text-white', 'font-medium');
                            btn.classList.remove('text-gray-500');
                        } else {
                            btn.classList.remove('bg-indigo-600', 'text-white', 'font-medium');
                            btn.classList.add('text-gray-500');
                        }
                    });
                });
            });

            // PC/MO ë²„íŠ¼ í´ë¦­ (ì¹´ë“œ ë‚´ë¶€ í† ê¸€)
            document.querySelectorAll('.template-variant').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const template = this.dataset.template;
                    const variant = this.dataset.variant;
                    if (template !== selectedTemplate) return;
                    selectedVariant = variant;

                    document.querySelectorAll('.template-variant').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white', 'font-medium');
                        b.classList.add('text-gray-500');
                    });
                    document.querySelectorAll('.template-variant[data-template="' + template + '"]').forEach(b => {
                        if (b.dataset.variant === variant) {
                            b.classList.add('bg-indigo-600', 'text-white', 'font-medium');
                            b.classList.remove('text-gray-500');
                        }
                    });
                });
            });

            // ì´ˆê¸° ìƒíƒœ: A ì¹´ë“œ ì„ íƒ + PC í™œì„±í™”
            const firstCard = document.querySelector('.template-card[data-template="A"]');
            if (firstCard) {
                firstCard.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
                firstCard.querySelector('.template-check').classList.remove('hidden');
                firstCard.querySelector('.template-variant[data-variant="PC"]').classList.add('bg-indigo-600', 'text-white', 'font-medium');
                firstCard.querySelector('.template-variant[data-variant="PC"]').classList.remove('text-gray-500');
            }
        }
        
        // ì´ˆê¸°í™” í•¨ìˆ˜: ëª¨ë“  ìƒíƒœë¥¼ ë¦¬ì…‹í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆë„ë¡
        function resetAll() {
            // ìƒíƒœ ë³€ìˆ˜ ë¦¬ì…‹
            selectedKeyword = null;
            selectedBrand = 'DV';
            selectedTemplate = 'A';
            referenceImageFromFile = null;
            referenceImageUrlFromInput = null;
            updateReferenceImage();
            var urlInp = document.getElementById('referenceImageUrlInput');
            if (urlInp) urlInp.value = '';
            selectedAiMode = null;
            
            // UI ë¦¬ì…‹
            // 1. í‚¤ì›Œë“œ ì„ íƒ í•´ì œ
            document.querySelectorAll('.trend-item').forEach(function(item) {
                item.classList.remove('bg-indigo-100', 'border-indigo-400', 'ring-2', 'ring-indigo-300');
            });
            
            // 2. ë¸Œëœë“œ ì„ íƒ ë¦¬ì…‹ (DVë¡œ)
            document.querySelectorAll('.brand-btn').forEach(function(btn) {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            });
            var dvBtn = document.querySelector('.brand-btn[data-brand="DV"]');
            if (dvBtn) {
                dvBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                dvBtn.classList.add('bg-indigo-600', 'text-white');
            }
            
            // 3. í…œí”Œë¦¿ ì„ íƒ ë¦¬ì…‹ (Aë¡œ)
            document.querySelectorAll('.template-card').forEach(function(card) {
                card.classList.remove('ring-4', 'ring-indigo-500', 'ring-offset-2');
            });
            var templateA = document.querySelector('.template-card[data-template="A"]');
            if (templateA) {
                templateA.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
            }
            
            // 4. ì°¸ì¡° ì´ë¯¸ì§€ ì´ˆê¸°í™”
            var referenceInput = document.getElementById('referenceImageInput');
            if (referenceInput) referenceInput.value = '';
            var referenceLabel = document.getElementById('referenceImageLabel');
            if (referenceLabel) referenceLabel.textContent = 'ì œí’ˆ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ í‚¤ì›Œë“œì™€ ê¸°íšì˜ë„ì— ë§ëŠ” ë°°ê²½ì— í•©ì„±í•©ë‹ˆë‹¤';
            var referenceZone = document.getElementById('referenceImageZone');
            if (referenceZone) {
                referenceZone.classList.remove('border-indigo-300', 'bg-indigo-50/30');
            }
            
            // 5. AI ìƒì„± ëª¨ë“œ ë¦¬ì…‹
            document.querySelectorAll('input[name="aiGenerateMode"]').forEach(function(radio) {
                radio.checked = false;
            });
            
            // 6. ê¸°íš ì˜ë„ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            var campaignIntent = document.getElementById('campaignIntent');
            if (campaignIntent) campaignIntent.value = '';
            
            // 7. ìƒì„± ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
            setGenerateStatus('');
            
            // 8. ìƒì„±ëœ ì´ë¯¸ì§€ ìˆ¨ê¸°ê¸° ë° ë¦¬ì…‹
            var moImg = document.getElementById('resultMoImage');
            var pcImg = document.getElementById('resultPcImage');
            if (moImg) {
                moImg.src = '';
                moImg.classList.add('hidden');
            }
            if (pcImg) {
                pcImg.src = '';
            }
            
            // 9. í”Œë ˆì´ìŠ¤í™€ë” ë‹¤ì‹œ í‘œì‹œ
            var moPh = document.getElementById('resultMoPlaceholder');
            var pcPh = document.getElementById('resultPcPlaceholder');
            if (moPh) {
                moPh.textContent = 'í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.';
                moPh.classList.remove('hidden');
            }
            if (pcPh) {
                pcPh.textContent = 'í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.';
                pcPh.classList.remove('hidden');
            }
            
            // 10. í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            var moOverlay = document.getElementById('resultMoOverlay');
            var pcOverlay = document.getElementById('resultPcOverlay');
            if (moOverlay) moOverlay.classList.add('hidden');
            if (pcOverlay) pcOverlay.classList.add('hidden');
            
            // 11. ë¸Œëœë“œ/í‚¤ì›Œë“œ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            var moBrand = document.getElementById('resultMoBrand');
            var moKeyword = document.getElementById('resultMoKeyword');
            var pcBrand = document.getElementById('resultPcBrand');
            var pcKeyword = document.getElementById('resultPcKeyword');
            if (moBrand) moBrand.textContent = '';
            if (moKeyword) moKeyword.textContent = '';
            if (pcBrand) pcBrand.textContent = '';
            if (pcKeyword) pcKeyword.textContent = '';
            
            // 12. ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤ (ì„ íƒì‚¬í•­)
            var resultSection = document.getElementById('result');
            if (resultSection) {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            alert('ëª¨ë“  ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ì–´ ì„ íƒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
        }
        
        // AI ì‹œì•ˆ ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (Gemini â†’ ì¹´í”¼ ë°˜ì˜ â†’ ì´ë¯¸ì§€ URL â†’ textStyle ë°°ì¹˜)
        function setupGenerateButton() {
            var generateButton = document.getElementById('generateButton');
            var resetButton = document.getElementById('resetButton');
            
            // ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    resetAll();
                });
            }
            
            generateButton.addEventListener('click', async function() {
                var campaignIntent = document.getElementById('campaignIntent').value;
                if (!selectedKeyword || !selectedTemplate) {
                    alert('í‚¤ì›Œë“œì™€ í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                var modeRadios = document.querySelectorAll('input[name="aiGenerateMode"]');
                var aiMode = null;
                modeRadios.forEach(function(r) { if (r.checked) aiMode = r.value; });
                selectedAiMode = aiMode;
                
                // API ì„ íƒ í™•ì¸
                var apiRadios = document.querySelectorAll('input[name="imageApi"]');
                var imageApi = 'fal';
                apiRadios.forEach(function(r) { if (r.checked) imageApi = r.value; });
                selectedImageApi = imageApi;
                console.log('ğŸ”µ [API ì„ íƒ]', imageApi === 'replicate' ? 'Replicate API ì‚¬ìš©' : 'FAL API ì‚¬ìš©');
                
                var btn = this;
                var origText = btn.textContent;
                btn.disabled = true;
                // URL ì…ë ¥ë€ ê°’ ìƒì„± ì§ì „ì— í•œ ë²ˆ ë” ë°˜ì˜ (ì°¸ì¡° ì´ë¯¸ì§€ í™•ì‹¤íˆ ì ìš©)
                var urlInputSync = document.getElementById('referenceImageUrlInput');
                if (urlInputSync) {
                    var v = (urlInputSync.value || '').trim();
                    if (v) {
                        if (!/^https?:\/\//i.test(v)) v = 'https://' + v;
                        if (/^https?:\/\/.+/i.test(v)) {
                            referenceImageUrlFromInput = v;
                            updateReferenceImage();
                        }
                    }
                }
                console.log('ğŸŸ¡ [ì°¸ì¡° ì´ë¯¸ì§€] ì‚¬ìš© ì—¬ë¶€:', hasReferenceImage, '| URL:', referenceImageUrl ? (referenceImageUrl.length > 60 ? referenceImageUrl.substring(0, 60) + '...' : referenceImageUrl) : '(ì—†ìŒ)');
                setGenerateStatus('í”„ë¡¬í”„íŠ¸ êµ¬ì„± ì¤‘...');
                var geminiResult = await getPromptResult(selectedBrand, selectedKeyword, campaignIntent, aiMode, hasReferenceImage);
                var brandCopy = (geminiResult.brandCopy || '').trim() || selectedBrand + ' 26SS ì»¬ë ‰ì…˜';
                var keywordCopy = (geminiResult.keywordCopy || '').trim() || selectedKeyword;
                document.getElementById('resultMoBrand').textContent = brandCopy;
                document.getElementById('resultMoKeyword').textContent = keywordCopy;
                document.getElementById('resultPcBrand').textContent = brandCopy;
                document.getElementById('resultPcKeyword').textContent = keywordCopy;
                var editBrandEl = document.getElementById('editBrand');
                var editKeywordEl = document.getElementById('editKeyword');
                if (editBrandEl) editBrandEl.value = brandCopy;
                if (editKeywordEl) editKeywordEl.value = keywordCopy;
                setGenerateStatus('AI ë””ìì´ë„ˆê°€ ê³ í™”ì§ˆ ì‹œì•ˆì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...');
                overlayInited['mo-brand'] = overlayInited['mo-keyword'] = overlayInited['pc-brand'] = overlayInited['pc-keyword'] = false;
                var moPhReset = document.getElementById('resultMoPlaceholder');
                if (moPhReset) moPhReset.textContent = 'í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.';
                var loadingEl = document.getElementById('imageLoadingOverlay');
                var loadingMsgEl = document.getElementById('imageLoadingOverlayMessage');
                if (loadingMsgEl) loadingMsgEl.textContent = 'MOÂ·PC ì‹œì•ˆ ë™ì‹œ ìƒì„± ì¤‘...';
                if (loadingEl) { loadingEl.classList.add('visible'); loadingEl.setAttribute('aria-hidden', 'false'); }
                var pcImageSrc, moImageSrc;
                try {
                    console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (MOÂ·PC ë™ì‹œ ìƒì„±)');
                    var baseSeed = Math.floor(Math.random() * 1000000);
                    lastImageSeed = baseSeed;
                    console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] ì‹œë“œ ìƒì„± ì™„ë£Œ:', baseSeed);
                    
                    // ì„ íƒëœ APIì— ë”°ë¼ ë‹¤ë¥¸ í•¨ìˆ˜ í˜¸ì¶œ
                    // ì£¼ì˜: Replicate APIëŠ” CORS ë¬¸ì œë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œ ë¶ˆê°€
                    // ì„œë²„ ì‚¬ì´ë“œ í”„ë¡ì‹œê°€ í•„ìš”í•˜ë¯€ë¡œ í˜„ì¬ëŠ” FAL APIë§Œ ì‚¬ìš©
                    var promMo, promPc;
                    if (selectedImageApi === 'replicate') {
                        console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] Replicate API í˜¸ì¶œ ì¤‘ (í•œë„ ë°©ì§€ë¥¼ ìœ„í•´ MO â†’ PC ìˆœì°¨ ìƒì„±)...');
                        moImageSrc = await fetchReplicateImage(selectedBrand, geminiResult.imagePromptMo || geminiResult.imagePrompt, baseSeed, true, referenceImageUrl);
                        pcImageSrc = await fetchReplicateImage(selectedBrand, geminiResult.imagePrompt, baseSeed, false, referenceImageUrl);
                        if (!pcImageSrc && moImageSrc) pcImageSrc = moImageSrc;
                        console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] Replicate API í˜¸ì¶œ ì™„ë£Œ.');
                    } else {
                        promMo = fetchNanoBananaImage(selectedBrand, geminiResult.imagePromptMo || geminiResult.imagePrompt, baseSeed, true, referenceImageUrl);
                        promPc = fetchNanoBananaImage(selectedBrand, geminiResult.imagePrompt, baseSeed, false, referenceImageUrl);
                        console.log('ğŸŸ¡ [ì§„í–‰ ë‹¨ê³„] FAL API í˜¸ì¶œ ì™„ë£Œ, ì‘ë‹µ ëŒ€ê¸° ì¤‘...');
                        var results = await Promise.all([promMo, promPc]);
                        moImageSrc = results[0] || '';
                        pcImageSrc = results[1] || '';
                        if (!pcImageSrc && moImageSrc) pcImageSrc = moImageSrc;
                    }
                    console.log('âœ… [ì§„í–‰ ë‹¨ê³„] ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (MO:', !!moImageSrc, 'PC:', !!pcImageSrc, ')');
                } catch (error) {
                    console.error('âŒ ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                    var sanitizedError = sanitizeErrorForLogging(error);
                    if (sanitizedError) {
                        console.error('ğŸ“ ì—ëŸ¬ ë©”ì‹œì§€:', sanitizedError.message);
                        if (sanitizedError.stack) {
                            console.error('ğŸ” ì—ëŸ¬ ìŠ¤íƒ:', sanitizedError.stack);
                        }
                    }
                    setGenerateStatus('');
                    btn.disabled = false;
                    btn.textContent = origText;
                    var errMsg = (sanitizedError && sanitizedError.message) ? sanitizedError.message : (error && error.message) ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                    var status429 = (error && error.response && error.response.status === 429);
                    if (status429) {
                        alert('ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤ (429 Too Many Requests).\n\nReplicateì—ì„œ í•œë„ê°€ ê±¸ë¦° ìƒíƒœì…ë‹ˆë‹¤. ë³´í†µ ì•½ 30ì´ˆ í›„ì— í’€ë¦½ë‹ˆë‹¤.\nâ€¢ 30ì´ˆ~1ë¶„ ê¸°ë‹¤ë¦° ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.\nâ€¢ ì‚¬ìš©ëŸ‰/ê²°ì œ í™•ì¸: https://replicate.com/account/billing');
                    } else if (selectedImageApi === 'replicate') {
                        alert('í‚¤ì›Œë“œ ë°˜ì˜ ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nReplicate API ì˜¤ë¥˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•  ê²ƒ:\nâ€¢ server.js í„°ë¯¸ë„ì— ì—ëŸ¬ ë¡œê·¸ê°€ ìˆëŠ”ì§€\nâ€¢ Replicate API í‚¤ê°€ ìœ íš¨í•œì§€\nâ€¢ Replicate ì„œë¹„ìŠ¤ ìƒíƒœ\n\nì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('í‚¤ì›Œë“œ ë°˜ì˜ ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nFAL API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + errMsg);
                    }
                    return;
                } finally {
                    if (loadingEl) { loadingEl.classList.remove('visible'); loadingEl.setAttribute('aria-hidden', 'true'); }
                }
                var moImg = document.getElementById('resultMoImage');
                var pcImg = document.getElementById('resultPcImage');
                var moPh = document.getElementById('resultMoPlaceholder');
                var pcPh = document.getElementById('resultPcPlaceholder');
                var moOverlay = document.getElementById('resultMoOverlay');
                var pcOverlay = document.getElementById('resultPcOverlay');
                function showMo() {
                    moImg.classList.remove('hidden');
                    moPh.classList.add('hidden');
                    moOverlay.classList.remove('hidden');
                    setTimeout(function() { initOverlayPositions(); }, 50);
                }
                function showPc() {
                    pcImg.classList.remove('hidden');
                    pcPh.classList.add('hidden');
                    pcOverlay.classList.remove('hidden');
                    setTimeout(function() { initOverlayPositions(); }, 50);
                }
                function hideMo() {
                    moImg.classList.add('hidden');
                    moPh.classList.remove('hidden');
                    moOverlay.classList.add('hidden');
                }
                function hidePc() {
                    pcImg.classList.add('hidden');
                    pcPh.classList.remove('hidden');
                    pcOverlay.classList.add('hidden');
                }
                pcImg.crossOrigin = 'anonymous';
                // ëª¨ë°”ì¼ ì´ë¯¸ì§€ íƒœê·¸ ì¡´ì¬ ë° ìƒíƒœ í™•ì¸ (ë””ë²„ê¹…ìš© ë¡œê·¸ ì œê±°)
                
                // ëª¨ë°”ì¼ ì´ë¯¸ì§€ ìƒì„± ì¦‰ì‹œ í‘œì‹œ: src í• ë‹¹ í›„ UI ì¦‰ì‹œ ì „í™˜(ë¡œë“œëŠ” onloadì—ì„œ ì™„ë£Œ)
                function forceShowMo() {
                    if (!moImageSrc) { console.error('MO ì´ë¯¸ì§€ ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤!'); return; }
                    var el = document.getElementById('resultMoImage');
                    if (!el || !el.parentNode) { console.error('resultMoImage ìš”ì†Œê°€ DOMì— ì—†ìŠµë‹ˆë‹¤.'); return; }
                    lastGeneratedMoImageUrl = moImageSrc;
                    el.removeAttribute('crossorigin');
                    el.crossOrigin = '';
                    el.src = moImageSrc;
                    el.setAttribute('style', 'display: block !important; visibility: visible !important;');
                    el.style.setProperty('display', 'block', 'important');
                    el.style.setProperty('visibility', 'visible', 'important');
                    el.classList.remove('hidden');
                    if (moPh) moPh.classList.add('hidden');
                    if (moOverlay) moOverlay.classList.remove('hidden');
                    requestAnimationFrame(function() {
                        el.setAttribute('style', 'display: block !important; visibility: visible !important;');
                        el.classList.remove('hidden');
                    });
                    setTimeout(function() { initOverlayPositions(); }, 50);
                }
                
                moImg.onload = function() { 
                    lastGeneratedMoImageUrl = moImageSrc;
                    moImg.classList.remove('hidden');
                    showMo(); 
                };
                moImg.onerror = function() { 
                    // MO ì˜ì—­ì€ ìˆ¨ê¸°ì§€ ì•Šê³ , placeholderë§Œ ë³´ì´ë„ë¡ (ëª¨ë°”ì¼ ì‹œì•ˆ ì¹¸ì€ í•­ìƒ ìœ ì§€)
                    moImg.classList.add('hidden');
                    if (moPh) moPh.classList.remove('hidden');
                    if (moPh) moPh.textContent = 'MO ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    if (moOverlay) moOverlay.classList.add('hidden');
                };
                pcImg.onload = function() { 
                    showPc(); 
                };
                pcImg.onerror = function() { 
                    hidePc(); 
                };
                
                // PC ì´ë¯¸ì§€ ì¦‰ì‹œ í• ë‹¹ ë° ê°•ì œ ë…¸ì¶œ
                if (pcImageSrc) {
                    pcImg.src = pcImageSrc;
                    pcImg.style.setProperty('display', 'block', 'important');
                    pcImg.classList.remove('hidden');
                    if (pcPh) pcPh.classList.add('hidden');
                    if (pcOverlay) pcOverlay.classList.remove('hidden');
                }
                if (pcImg.complete && pcImageSrc) {
                    setTimeout(function() { if (pcImg.src === pcImageSrc) showPc(); }, 100);
                }
                
                // MO: moImageSrc ìƒì„±ë˜ìë§ˆì resultMoImage.src í• ë‹¹, display/hidden !important ê°•ì œ
                if (moImageSrc) {
                    if (moImg) {
                        moImg.src = moImageSrc;
                        moImg.style.setProperty('display', 'block', 'important');
                        moImg.style.setProperty('visibility', 'visible', 'important');
                        moImg.classList.remove('hidden');
                        if (moPh) moPh.classList.add('hidden');
                        if (moOverlay) moOverlay.classList.remove('hidden');
                    }
                    forceShowMo();
                }
                
                lastGeneratedImageUrl = pcImageSrc;
                lastGeneratedPcImageUrl = pcImageSrc;
                lastImagePrompt = geminiResult.imagePrompt;
                lastDetailInstructions = campaignIntent || '';
                lastAiMode = aiMode;
                
                setGenerateStatus('');
                btn.disabled = false;
                btn.textContent = origText;
                var resultEl = document.getElementById('result');
                requestAnimationFrame(function() {
                    var y = resultEl.getBoundingClientRect().top + window.pageYOffset - 16;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                });
            });
        }
        
        // ì‹œì•ˆ ë‹¤ìš´ë¡œë“œ: íŒŒì¼ëª…ì— ì“¸ ìˆ˜ ì—†ëŠ” ë¬¸ì ì œê±°
        function sanitizeFilename(str) {
            return String(str).replace(/[/\\:*?"<>|\s]+/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '') || 'ì‹œì•ˆ';
        }
        
        // ì´ë¯¸ì§€ URL â†’ Base64 (CORS í—ˆìš© í•„ìš”)
        function imageToBase64(imgEl) {
            return new Promise(function(resolve, reject) {
                if (!imgEl || !imgEl.src) { reject(new Error('ì´ë¯¸ì§€ ì—†ìŒ')); return; }
                if (imgEl.src.startsWith('data:')) { resolve(imgEl.src); return; }
                var img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    try {
                        var c = document.createElement('canvas');
                        c.width = img.naturalWidth || img.width;
                        c.height = img.naturalHeight || img.height;
                        var ctx = c.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(c.toDataURL('image/png'));
                    } catch (e) { reject(e); }
                };
                img.onerror = function() { reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨(CORS ë“±)')); };
                img.src = imgEl.src;
            });
        }
        
        // XML í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„
        function escapeXml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }
        
        // MO ì‹œì•ˆ PNG ì €ì¥
        function downloadMoImage() {
            if (!selectedKeyword || !selectedBrand) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
            var el = document.getElementById('resultMoCapture');
            if (!el || typeof html2canvas === 'undefined') { alert('ë‹¤ìš´ë¡œë“œ ë„êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            var brand = selectedBrand === 'DV' ? 'DV' : 'ST';
            var name = sanitizeFilename(brand) + '_' + sanitizeFilename(selectedKeyword) + '_MO.png';
            html2canvas(el, { useCORS: true, scale: 2, backgroundColor: null }).then(function(canvas) {
                var a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = name;
                a.click();
            }).catch(function(err) { console.error(err); alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        }
        
        // PC ì‹œì•ˆ PNG ì €ì¥
        function downloadPcImage() {
            if (!selectedKeyword || !selectedBrand) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
            var el = document.getElementById('resultPcCapture');
            if (!el || typeof html2canvas === 'undefined') { alert('ë‹¤ìš´ë¡œë“œ ë„êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            var brand = selectedBrand === 'DV' ? 'DV' : 'ST';
            var name = sanitizeFilename(brand) + '_' + sanitizeFilename(selectedKeyword) + '_PC.png';
            html2canvas(el, { useCORS: true, scale: 2, backgroundColor: null }).then(function(canvas) {
                var a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = name;
                a.click();
            }).catch(function(err) { console.error(err); alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        }
        
        // MO+PC ì••ì¶• ë‹¤ìš´ë¡œë“œ
        function downloadAllImages() {
            if (!selectedKeyword || !selectedBrand) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
            if (typeof JSZip === 'undefined' || typeof html2canvas === 'undefined') { alert('ë‹¤ìš´ë¡œë“œ ë„êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            var brand = selectedBrand === 'DV' ? 'DV' : 'ST';
            var base = sanitizeFilename(brand) + '_' + sanitizeFilename(selectedKeyword);
            var zip = new JSZip();
            Promise.all([
                html2canvas(document.getElementById('resultMoCapture'), { useCORS: true, scale: 2, backgroundColor: null }),
                html2canvas(document.getElementById('resultPcCapture'), { useCORS: true, scale: 2, backgroundColor: null })
            ]).then(function(results) {
                zip.file(base + '_MO.png', results[0].toDataURL('image/png').split(',')[1], { base64: true });
                zip.file(base + '_PC.png', results[1].toDataURL('image/png').split(',')[1], { base64: true });
                return zip.generateAsync({ type: 'blob' });
            }).then(function(blob) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = base + '_ì‹œì•ˆ.zip';
                a.click();
                URL.revokeObjectURL(a.href);
            }).catch(function(err) { console.error(err); alert('ì••ì¶• ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        }
        
        // ì‹œì•ˆ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´: ìœ„ì¹˜Â·í¬ê¸° ìƒíƒœ (px). html2canvas ìº¡ì²˜ ì‹œ ì´ ê°’ì´ ê·¸ëŒ€ë¡œ ë°˜ì˜ë¨
        var overlayState = {
            'mo-brand': { x: 0, y: 0, fontSize: 14 },
            'mo-keyword': { x: 0, y: 0, fontSize: 28 },
            'pc-brand': { x: 0, y: 0, fontSize: 16 },
            'pc-keyword': { x: 0, y: 0, fontSize: 36 }
        };
        var overlayInited = { 'mo-brand': false, 'mo-keyword': false, 'pc-brand': false, 'pc-keyword': false };
        
        function getOverlayBox(target) { return document.querySelector('.overlay-text-box[data-target="' + target + '"]'); }
        function getTextSpan(box) { return box ? box.querySelector('span:not(.resize-handle)') : null; }
        function getCaptureFor(target) { return target.indexOf('mo') === 0 ? document.getElementById('resultMoCapture') : document.getElementById('resultPcCapture'); }
        
        // í”¼ê·¸ë§ˆ SVG ì¶œë ¥ ê³ ì •: PC 3840x1760, MO 2304x3500 í•˜ë“œì½”ë”©. í…ìŠ¤íŠ¸ ì¢Œí‘œ PC=ì¢Œì¸¡, MO=ìƒë‹¨ ê³ ì •(ì œí’ˆê³¼ ê²¹ì¹˜ì§€ ì•ŠìŒ)
        var FIGMA_MO_WIDTH = 2304, FIGMA_MO_HEIGHT = 3500, FIGMA_PC_WIDTH = 3840, FIGMA_PC_HEIGHT = 1760;
        var SAFE_MO_Y_MAX_RATIO = 0.35;
        var SAFE_PC_X_MAX_RATIO = 0.60;
        async function buildSvgForFigma(variant) {
            var isMo = variant === 'mo';
            var captureId = isMo ? 'resultMoCapture' : 'resultPcCapture';
            var imgId = isMo ? 'resultMoImage' : 'resultPcImage';
            var targets = isMo ? ['mo-brand', 'mo-keyword'] : ['pc-brand', 'pc-keyword'];
            var vbW = isMo ? FIGMA_MO_WIDTH : FIGMA_PC_WIDTH;
            var vbH = isMo ? FIGMA_MO_HEIGHT : FIGMA_PC_HEIGHT;
            console.log('í”¼ê·¸ë§ˆ SVG ìƒì„±:', { variant: variant, viewBox: '0 0 ' + vbW + ' ' + vbH });
            var capture = document.getElementById(captureId);
            var imgEl = document.getElementById(imgId);
            if (!capture || !imgEl || !imgEl.src || imgEl.classList.contains('hidden')) {
                alert('ë¨¼ì € AI ì‹œì•ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return null;
            }
            var base64 = null;
            try {
                base64 = await imageToBase64(imgEl);
            } catch (e) {
                console.error(e);
                alert('ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORSê°€ í—ˆìš©ëœ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return null;
            }
            var captureRect = capture.getBoundingClientRect();
            var canvasW = captureRect.width;
            var canvasH = captureRect.height;
            var scaleX = vbW / canvasW;
            var scaleY = vbH / canvasH;
            var defsNodes = [];
            var gradientNodes = [];
            var textNodes = [];
            var defaultsMap = getTextStyleDefaults(selectedBrand || 'DV');
            var gradientCounter = 0;
            for (var i = 0; i < targets.length; i++) {
                var target = targets[i];
                var state = overlayState[target];
                var box = getOverlayBox(target);
                var textSpan = getTextSpan(box);
                var text = textSpan ? textSpan.textContent : '';
                if (!state || !box || !textSpan) continue;
                var boxRect = box.getBoundingClientRect();
                var textRect = textSpan.getBoundingClientRect();
                var computedStyle = window.getComputedStyle(textSpan);
                var relativeX = boxRect.left - captureRect.left;
                var relativeY = boxRect.top - captureRect.top;
                var xPercent = (relativeX / canvasW) * 100;
                var yPercent = ((relativeY + textRect.height) / canvasH) * 100;
                var x = Math.round((xPercent / 100) * vbW);
                var y = Math.round((yPercent / 100) * vbH);
                var fontSizePx = parseFloat(computedStyle.fontSize) || state.fontSize;
                var fs = Math.round(fontSizePx * scaleY);
                var fontWeight = computedStyle.fontWeight || 'bold';
                var fillColor = computedStyle.color || 'white';
                var fontFamily = computedStyle.fontFamily || 'sans-serif';
                var d = defaultsMap[target] || {};
                var textAnchor = d.centerHoriz ? 'middle' : (d.leftAlign ? 'start' : 'start');
                if (isMo) {
                    x = Math.round(vbW / 2);
                    var moYRatio = Math.min(d.yRatio !== undefined ? d.yRatio : 0.10, SAFE_MO_Y_MAX_RATIO);
                    y = Math.round(moYRatio * vbH);
                } else {
                    var pcXRatio = Math.min(d.leftMarginRatio !== undefined ? d.leftMarginRatio : 0.10, SAFE_PC_X_MAX_RATIO);
                    var forcedY = (d.yRatio !== undefined ? d.yRatio : 0.40) * vbH;
                    x = Math.round(pcXRatio * vbW);
                    y = Math.round(forcedY);
                }
                var textBoxW = boxRect.width;
                var textBoxH = textRect.height;
                var gradientBoxX = Math.round((relativeX / canvasW) * vbW);
                var gradientBoxY = Math.round((relativeY / canvasH) * vbH);
                var gradientBoxW = Math.round((textBoxW / canvasW) * vbW);
                var gradientBoxH = Math.round((textBoxH / canvasH) * vbH);
                var gradientId = 'gradient-' + gradientCounter++;
                defsNodes.push('<linearGradient id="' + gradientId + '" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:rgba(0,0,0,0.3);stop-opacity:1" /><stop offset="100%" style="stop-color:rgba(0,0,0,0.1);stop-opacity:1" /></linearGradient>');
                gradientNodes.push('<rect x="' + gradientBoxX + '" y="' + gradientBoxY + '" width="' + gradientBoxW + '" height="' + gradientBoxH + '" fill="url(#' + gradientId + ')"/>');
                textNodes.push('<text x="' + x + '" y="' + y + '" font-size="' + fs + '" fill="' + fillColor + '" font-weight="' + escapeXml(fontWeight) + '" font-family="' + escapeXml(fontFamily) + '" text-anchor="' + textAnchor + '">' + escapeXml(text) + '</text>');
            }
            var defsSection = defsNodes.length > 0 ? '<defs>' + defsNodes.join('') + '</defs>' : '';
            // í”¼ê·¸ë§ˆ ê·œê²©: viewBox PC 3840x1760, MO 2304x3500. ë°°ê²½ ì´ë¯¸ì§€ ê½‰ ì°¨ê²Œ xMidYMid slice
            var viewBoxStr = '0 0 ' + vbW + ' ' + vbH;
            var svg = '<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="' + viewBoxStr + '" width="' + vbW + '" height="' + vbH + '">\n  ' + defsSection + '\n  <image x="0" y="0" width="' + vbW + '" height="' + vbH + '" href="' + base64 + '" preserveAspectRatio="xMidYMid slice"/>\n  ' + gradientNodes.join('\n  ') + '\n  ' + textNodes.join('\n  ') + '\n</svg>';
            console.log('í”¼ê·¸ë§ˆ SVG ìƒì„± ì™„ë£Œ:', { variant: variant, viewBox: viewBoxStr, vbW: vbW, vbH: vbH, textNodesCount: textNodes.length });
            return svg;
        }
        
        function applyOverlayState(target) {
            var box = getOverlayBox(target);
            if (!box) return;
            var s = overlayState[target];
            box.style.left = s.x + 'px';
            box.style.top = s.y + 'px';
            var textSpan = getTextSpan(box);
            if (textSpan) textSpan.style.fontSize = (s.fontSize + 'px');
        }
        
        function updatePanelFromState(target) {
            var s = overlayState[target];
            var idMap = { 'mo-brand': 'editMoBrandSize', 'mo-keyword': 'editMoKeywordSize', 'pc-brand': 'editPcBrandSize', 'pc-keyword': 'editPcKeywordSize' };
            var el = document.getElementById(idMap[target]);
            if (el) el.value = s.fontSize;
        }
        
        // í…ìŠ¤íŠ¸ ìœ„ì¹˜ ê³ ì •: MO = ìƒë‹¨(ì¤‘ì•™ ì •ë ¬), PC = ì¢Œì¸¡ ì—¬ë°± 10% (í”¼ê·¸ë§ˆ SVGì™€ ë™ì¼)
        function getTextStyleDefaults(brandKey) {
            var isDV = brandKey === 'DV';
            return {
                'mo-brand':  { centerHoriz: true, yRatio: 0.10, fs: 13, fontWeight: isDV ? '600' : '600' },
                'mo-keyword': { centerHoriz: true, yRatio: 0.18, fs: 26, fontWeight: isDV ? '700' : '700' },
                'pc-brand':  { leftAlign: true, leftMarginRatio: 0.10, yRatio: 0.36, fs: 15, fontWeight: isDV ? '600' : '600' },
                'pc-keyword': { leftAlign: true, leftMarginRatio: 0.10, yRatio: 0.46, fs: 32, fontWeight: isDV ? '700' : '700' }
            };
        }
        
        function initOverlayPositions() {
            var brandKey = selectedBrand || 'DV';
            var defaultsMap = getTextStyleDefaults(brandKey);
            var targets = ['mo-brand','mo-keyword','pc-brand','pc-keyword'];
            targets.forEach(function(target) {
                if (overlayInited[target]) return;
                var box = getOverlayBox(target);
                var container = getCaptureFor(target);
                if (!box || !container) return;
                var rect = container.getBoundingClientRect();
                var w = rect.width, h = rect.height;
                var d = defaultsMap[target] || { yRatio: 0.1, fs: 16, fontWeight: '600' };
                overlayState[target].fontSize = Math.max(8, Math.min(72, d.fs));
                overlayInited[target] = true;
                var textSpan = getTextSpan(box);
                if (textSpan) textSpan.style.fontWeight = d.fontWeight || '600';
                overlayState[target].x = 0;
                overlayState[target].y = h * d.yRatio;
                applyOverlayState(target);
                var boxW = box.offsetWidth || 80;
                var boxH = box.offsetHeight || 24;
                var margin = 8;
                var y = Math.max(0, Math.min(h - boxH - margin, h * d.yRatio));
                overlayState[target].y = y;
                var x;
                if (d.centerHoriz) {
                    x = (w - boxW) / 2;
                    x = Math.max(margin, Math.min(w - boxW - margin, x));
                } else if (d.leftAlign) {
                    x = w * (d.leftMarginRatio != null ? d.leftMarginRatio : 0.08);
                    x = Math.max(margin, Math.min(w - boxW - margin, x));
                } else if (d.rightAlign) {
                    var rMargin = w * (d.rightMarginRatio != null ? d.rightMarginRatio : 0.08);
                    x = Math.max(margin, w - boxW - rMargin);
                } else {
                    x = Math.max(margin, Math.min(w - boxW - margin, w * (d.xRatio != null ? d.xRatio : 0.05)));
                }
                overlayState[target].x = Math.max(0, Math.min(w - boxW - margin, x));
                applyOverlayState(target);
                updatePanelFromState(target);
            });
            var sizeIds = ['editMoBrandSize','editMoKeywordSize','editPcBrandSize','editPcKeywordSize'];
            var stateKeys = ['mo-brand','mo-keyword','pc-brand','pc-keyword'];
            stateKeys.forEach(function(k, i) {
                var el = document.getElementById(sizeIds[i]);
                if (el) el.value = overlayState[k].fontSize;
            });
        }
        
        function setupOverlayInteract() {
            if (typeof interact === 'undefined') return;
            interact('.overlay-text-box').draggable({
                ignoreFrom: '.resize-handle',
                listeners: {
                    start: function(e) {
                        e.target.classList.add('dragging');
                    },
                    move: function(e) {
                        var target = e.target.getAttribute('data-target');
                        var container = getCaptureFor(target);
                        if (!container) return;
                        var rect = container.getBoundingClientRect();
                        var state = overlayState[target];
                        state.x += e.dx;
                        state.y += e.dy;
                        state.x = Math.max(0, Math.min(rect.width - (e.target.offsetWidth || 20), state.x));
                        state.y = Math.max(0, Math.min(rect.height - (e.target.offsetHeight || 20), state.y));
                        e.target.style.left = state.x + 'px';
                        e.target.style.top = state.y + 'px';
                        updatePanelFromState(target);
                    },
                    end: function(e) {
                        e.target.classList.remove('dragging');
                    }
                }
            }).on('tap', function(e) {
                if (e.target.classList.contains('resize-handle')) e.stopPropagation();
            });
            
            document.querySelectorAll('.resize-handle').forEach(function(handle) {
                handle.addEventListener('mousedown', function(ev) {
                    ev.preventDefault(); ev.stopPropagation();
                    var box = handle.closest('.overlay-text-box');
                    var key = box.getAttribute('data-target');
                    var startY = ev.clientY; var startSize = overlayState[key].fontSize;
                    function move(e) {
                        var dy = e.clientY - startY;
                        var next = Math.max(8, Math.min(72, startSize + Math.round(dy * 0.5)));
                        overlayState[key].fontSize = next;
                        getTextSpan(box).style.fontSize = next + 'px';
                        updatePanelFromState(key);
                    }
                    function up() {
                        document.removeEventListener('mousemove', move);
                        document.removeEventListener('mouseup', up);
                    }
                    document.addEventListener('mousemove', move);
                    document.addEventListener('mouseup', up);
                });
            });
            
            var sizeInputs = { 'editMoBrandSize': 'mo-brand', 'editMoKeywordSize': 'mo-keyword', 'editPcBrandSize': 'pc-brand', 'editPcKeywordSize': 'pc-keyword' };
            Object.keys(sizeInputs).forEach(function(id) {
                var target = sizeInputs[id];
                document.getElementById(id)?.addEventListener('input', function() {
                    var v = Math.max(8, Math.min(72, parseInt(this.value, 10) || 14));
                    overlayState[target].fontSize = v;
                    applyOverlayState(target);
                });
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŠ¸ë Œë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            fetchTrends();
            // ì €ì¥ëœ API í‚¤ ë¶ˆëŸ¬ì™€ì„œ ì…ë ¥ë€ì— ì±„ìš°ê¸°
            try {
                var g = localStorage.getItem(STORAGE_KEY_GEMINI);
                var f = localStorage.getItem(STORAGE_KEY_FAL);
                var geminiEl = document.getElementById('geminiApiKeyInput');
                var falEl = document.getElementById('falApiKeyInput');
                if (geminiEl && g) geminiEl.value = g;
                if (falEl && f) falEl.value = f;
            } catch (e) {}
            function saveApiKeyToStorage(id, storageKey) {
                var el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('blur', function() {
                    try {
                        var v = (el.value || '').trim();
                        if (v) localStorage.setItem(storageKey, v);
                    } catch (e) {}
                });
            }
            saveApiKeyToStorage('geminiApiKeyInput', STORAGE_KEY_GEMINI);
            saveApiKeyToStorage('falApiKeyInput', STORAGE_KEY_FAL);
            
            document.getElementById('trendsReloadBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                fetchTrends().finally(function() {
                    var btn = document.getElementById('trendsReloadBtn');
                    if (btn) { btn.disabled = false; btn.textContent = 'ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°'; }
                });
            });
            setupBrandSelection();
            setupTemplateSelection();
            setupGenerateButton();
            
            // ì„œë²„ ìƒíƒœ í™•ì¸
            function checkServerStatus() {
                var statusEl = document.getElementById('serverStatus');
                var statusTextEl = document.getElementById('serverStatusText');
                if (!statusEl || !statusTextEl) return;
                
                fetch(API_BASE + '/health')
                    .then(function(r) {
                        if (r.ok) {
                            statusEl.classList.remove('hidden');
                            statusTextEl.textContent = 'âœ… ì„œë²„ ì—°ê²°ë¨ (GeminiÂ·FALÂ·Replicate ì‚¬ìš© ê°€ëŠ¥)';
                            statusTextEl.className = 'text-green-600';
                        } else {
                            throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                        }
                    })
                    .catch(function() {
                        statusEl.classList.remove('hidden');
                        statusTextEl.textContent = 'âš ï¸ ì„œë²„ ë¯¸ì—°ê²° (FAL APIë¡œ ìë™ í´ë°±)';
                        statusTextEl.className = 'text-orange-600';
                    });
            }
            
            // Replicate API ì„ íƒ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
            document.querySelectorAll('input[name="imageApi"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.value === 'replicate') {
                        checkServerStatus();
                    } else {
                        var statusEl = document.getElementById('serverStatus');
                        if (statusEl) statusEl.classList.add('hidden');
                    }
                });
            });
            (function setupReferenceImageAndAiMode() {
                // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ë° ì••ì¶• í•¨ìˆ˜ (í† í° ì†Œëª¨ ìµœì í™”)
                function compressImage(file, maxWidth, maxHeight, quality) {
                    return new Promise(function(resolve, reject) {
                        maxWidth = maxWidth || 1024; // ìµœëŒ€ ë„ˆë¹„ 1024px
                        maxHeight = maxHeight || 1024; // ìµœëŒ€ ë†’ì´ 1024px
                        quality = quality || 0.85; // JPEG í’ˆì§ˆ 85%
                        
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            var img = new Image();
                            img.onload = function() {
                                try {
                                    var canvas = document.createElement('canvas');
                                    var ctx = canvas.getContext('2d');
                                    
                                    // ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë¦¬ì‚¬ì´ì§•
                                    var width = img.width;
                                    var height = img.height;
                                    if (width > maxWidth || height > maxHeight) {
                                        var ratio = Math.min(maxWidth / width, maxHeight / height);
                                        width = Math.round(width * ratio);
                                        height = Math.round(height * ratio);
                                    }
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    
                                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    // JPEGë¡œ ì••ì¶• (PNGë³´ë‹¤ ì‘ìŒ)
                                    var compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                                    
                                    // íŒŒì¼ í¬ê¸° í™•ì¸
                                    var originalSize = file.size;
                                    var compressedSize = Math.round((compressedDataUrl.length - 'data:image/jpeg;base64,'.length) * 0.75); // base64ëŠ” ì•½ 33% ë” í¬ë¯€ë¡œ
                                    
                                    console.log('ğŸ“Š ì´ë¯¸ì§€ ì••ì¶• ê²°ê³¼:', {
                                        ì›ë³¸í¬ê¸°: (originalSize / 1024).toFixed(2) + ' KB',
                                        ì••ì¶•í¬ê¸°: (compressedSize / 1024).toFixed(2) + ' KB',
                                        ì••ì¶•ë¥ : ((1 - compressedSize / originalSize) * 100).toFixed(1) + '%',
                                        í•´ìƒë„: width + 'x' + height
                                    });
                                    
                                    resolve(compressedDataUrl);
                                } catch (err) {
                                    reject(err);
                                }
                            };
                            img.onerror = function() { reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨')); };
                            img.src = e.target.result;
                        };
                        reader.onerror = function() { reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨')); };
                        reader.readAsDataURL(file);
                    });
                }
                
                var zone = document.getElementById('referenceImageZone');
                var input = document.getElementById('referenceImageInput');
                var label = document.getElementById('referenceImageLabel');
                var hint = document.getElementById('aiModeHint');
                if (zone && input) {
                    zone.addEventListener('click', function() { input.click(); });
                    input.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            var file = this.files[0];
                            
                            // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì´ìƒì´ë©´ ê²½ê³ )
                            if (file.size > 10 * 1024 * 1024) {
                                alert('ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (10MB ì´ìƒ). ìë™ìœ¼ë¡œ ì••ì¶•ë©ë‹ˆë‹¤.');
                            }
                            
                            // íŒŒì¼ íƒ€ì… ì²´í¬
                            if (!file.type.match(/^image\/(jpeg|jpg|png|webp)/i)) {
                                alert('ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í˜•ì‹: JPEG, PNG, WebP');
                                return;
                            }
                            
                            // ë¡œë”© í‘œì‹œ
                            if (label) { label.textContent = 'ì´ë¯¸ì§€ ì••ì¶• ì¤‘...'; }
                            
                            // ì´ë¯¸ì§€ ì••ì¶• í›„ ì €ì¥
                            compressImage(file, 1024, 1024, 0.85)
                                .then(function(compressedDataUrl) {
                                    referenceImageFromFile = compressedDataUrl;
                                    updateReferenceImage();
                                    referenceImageComposition = 'Reference image uploaded; use as main subject source.';
                                    if (label) { 
                                        var sizeKB = (file.size / 1024).toFixed(1);
                                        label.textContent = 'ì—…ë¡œë“œë¨: ' + file.name + ' (' + sizeKB + ' KB â†’ ì••ì¶•ë¨)'; 
                                    }
                                    zone.classList.add('border-indigo-300', 'bg-indigo-50/30');
                                    console.log('âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ, í† í° ì†Œëª¨ ìµœì í™”ë¨');
                                })
                                .catch(function(err) {
                                    console.error('âŒ ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', err);
                                    alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                                    referenceImageFromFile = null;
                                    updateReferenceImage();
                                    if (label) { label.textContent = 'ì—…ë¡œë“œ ì‹œ ì œí’ˆì„ ì¤‘ì‹¬ìœ¼ë¡œ ë°°ê²½ì„ ì—°ì¶œí•©ë‹ˆë‹¤'; }
                                    zone.classList.remove('border-indigo-300', 'bg-indigo-50/30');
                                });
                        } else {
                            referenceImageFromFile = null;
                            updateReferenceImage();
                            referenceImageComposition = '';
                            if (label) { label.textContent = 'ì—…ë¡œë“œ ì‹œ ì œí’ˆì„ ì¤‘ì‹¬ìœ¼ë¡œ ë°°ê²½ì„ ì—°ì¶œí•©ë‹ˆë‹¤'; }
                            zone.classList.remove('border-indigo-300', 'bg-indigo-50/30');
                        }
                    });
                }
                // ì œí’ˆ ì´ë¯¸ì§€ URL ì…ë ¥ë€ â€” FALÂ·Replicate ëª¨ë‘ image_urlë¡œ URL ì§€ì›
                var referenceImageUrlInputEl = document.getElementById('referenceImageUrlInput');
                function applyReferenceUrlFromInput(val) {
                    var v = (val || '').trim();
                    if (!v) {
                        referenceImageUrlFromInput = null;
                    } else {
                        if (!/^https?:\/\//i.test(v)) v = 'https://' + v;
                        if (/^https?:\/\/.+/i.test(v)) referenceImageUrlFromInput = v;
                        else referenceImageUrlFromInput = null;
                    }
                    updateReferenceImage();
                }
                if (referenceImageUrlInputEl) {
                    referenceImageUrlInputEl.addEventListener('input', function() { applyReferenceUrlFromInput(this.value); });
                    referenceImageUrlInputEl.addEventListener('blur', function() { applyReferenceUrlFromInput(this.value); });
                }
                document.querySelectorAll('input[name="aiGenerateMode"]').forEach(function(r) {
                    r.addEventListener('change', function() { selectedAiMode = this.value; });
                });
                
                // API ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.querySelectorAll('input[name="imageApi"]').forEach(function(r) {
                    r.addEventListener('change', function() { 
                        selectedImageApi = this.value;
                        console.log('ğŸ”µ [API ë³€ê²½]', selectedImageApi === 'replicate' ? 'Replicate APIë¡œ ë³€ê²½ë¨' : 'FAL APIë¡œ ë³€ê²½ë¨');
                    });
                });
            })();
            setupOverlayInteract();
            document.getElementById('downloadMoBtn')?.addEventListener('click', downloadMoImage);
            document.getElementById('downloadPcBtn')?.addEventListener('click', downloadPcImage);
            document.getElementById('downloadAllBtn')?.addEventListener('click', downloadAllImages);
            document.getElementById('copySvgMoBtn')?.addEventListener('click', async function() {
                var svg = await buildSvgForFigma('mo');
                if (svg && navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(svg).then(function() { alert('MO ì‹œì•ˆ SVGê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. í”¼ê·¸ë§ˆì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'); }).catch(function() { alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
                }
            });
            document.getElementById('copySvgPcBtn')?.addEventListener('click', async function() {
                var svg = await buildSvgForFigma('pc');
                if (svg && navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(svg).then(function() { alert('PC ì‹œì•ˆ SVGê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. í”¼ê·¸ë§ˆì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'); }).catch(function() { alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
                }
            });
            function syncResultTextFromInputs() {
                var editB = document.getElementById('editBrand');
                var editK = document.getElementById('editKeyword');
                var rMoB = document.getElementById('resultMoBrand'); var rMoK = document.getElementById('resultMoKeyword');
                var rPcB = document.getElementById('resultPcBrand'); var rPcK = document.getElementById('resultPcKeyword');
                var brandVal = editB ? editB.value : '';
                var keywordVal = editK ? editK.value : '';
                if (rMoB) rMoB.textContent = brandVal || rMoB.textContent;
                if (rMoK) rMoK.textContent = keywordVal || rMoK.textContent;
                if (rPcB) rPcB.textContent = brandVal || rPcB.textContent;
                if (rPcK) rPcK.textContent = keywordVal || rPcK.textContent;
            }
            ['editBrand','editKeyword'].forEach(function(id) {
                document.getElementById(id)?.addEventListener('input', syncResultTextFromInputs);
            });
            var developBtn = document.getElementById('developImageBtn');
            var regenBtn = document.getElementById('regenerateImageBtn');
            function setDevelopRegenDisabled(disabled) {
                if (developBtn) developBtn.disabled = disabled;
                if (regenBtn) regenBtn.disabled = disabled;
            }
            developBtn?.addEventListener('click', async function() {
                if (!selectedKeyword) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  ì‹œì•ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
                if (!lastGeneratedImageUrl) { alert('ë¨¼ì € AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¡œ ì´ë¯¸ì§€ë¥¼ ë§Œë“  ë’¤ ë””ë²¨ë¡­í•´ì£¼ì„¸ìš”.'); return; }
                var feedback = (document.getElementById('resultFeedback')?.value || '').trim();
                if (!feedback) { alert('í”¼ë“œë°± ë°•ìŠ¤ì— ìˆ˜ì • ì§€ì‹œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ë°°ê²½ì„ ë” ë°ê²Œ)'); return; }
                var moImg = document.getElementById('resultMoImage');
                var pcImg = document.getElementById('resultPcImage');
                var loadingEl = document.getElementById('imageLoadingOverlay');
                var loadingMsg = document.getElementById('imageLoadingOverlayMessage');
                if (loadingMsg) loadingMsg.textContent = 'PC ì‹œì•ˆ ë””ë²¨ë¡­ ì¤‘...';
                setGenerateStatus('ë””ë²¨ë¡­ ì¤‘...');
                setDevelopRegenDisabled(true);
                if (loadingEl) { loadingEl.classList.add('visible'); loadingEl.setAttribute('aria-hidden', 'false'); }
                try {
                    if (!lastGeneratedMoImageUrl || !lastGeneratedPcImageUrl) { alert('ë¨¼ì € AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¡œ ì´ë¯¸ì§€ë¥¼ ë§Œë“  ë’¤ ë””ë²¨ë¡­í•´ì£¼ì„¸ìš”.'); return; }
                    var pcUrl = await fetchFluxImageToImage(lastGeneratedPcImageUrl, feedback, 0.45);
                    if (loadingMsg) loadingMsg.textContent = 'ëª¨ë°”ì¼ ì‹œì•ˆ ë””ë²¨ë¡­ ì¤‘...';
                    var moUrl = await fetchFluxImageToImage(lastGeneratedMoImageUrl, feedback, 0.45);
                    if (pcUrl && moUrl) {
                        lastGeneratedPcImageUrl = pcUrl;
                        lastGeneratedMoImageUrl = moUrl;
                        lastGeneratedImageUrl = pcUrl;
                        moImg.crossOrigin = pcImg.crossOrigin = 'anonymous';
                        
                        // MO ì´ë¯¸ì§€ ê°•ì œ í‘œì‹œ ë¡œì§ (ë””ë²¨ë¡­)
                        function forceShowMoDevelop() {
                            if (!moUrl) return;
                            moImg.src = '';
                            setTimeout(function() {
                                moImg.src = moUrl;
                                setTimeout(function() {
                                    if (moImg.complete || moImg.naturalWidth > 0) {
                                        moImg.classList.remove('hidden');
                                        var moPh = document.getElementById('resultMoPlaceholder');
                                        var moOverlay = document.getElementById('resultMoOverlay');
                                        if (moPh) moPh.classList.add('hidden');
                                        if (moOverlay) moOverlay.classList.remove('hidden');
                                        setTimeout(function() { initOverlayPositions(); }, 50);
                                    }
                                }, 100);
                            }, 10);
                        }
                        
                        moImg.onload = function() {
                            moImg.classList.remove('hidden');
                            var moPh = document.getElementById('resultMoPlaceholder');
                            var moOverlay = document.getElementById('resultMoOverlay');
                            if (moPh) moPh.classList.add('hidden');
                            if (moOverlay) moOverlay.classList.remove('hidden');
                            setTimeout(function() { initOverlayPositions(); }, 50);
                        };
                        moImg.onerror = function() {
                            // ì—ëŸ¬ ë°œìƒ ì‹œ ì¡°ìš©íˆ ì²˜ë¦¬ (ì‚¬ìš©ìì—ê²ŒëŠ” UIë¡œ í‘œì‹œë¨)
                        };
                        
                        pcImg.onload = function() {
                            pcImg.classList.remove('hidden');
                            var pcPh = document.getElementById('resultPcPlaceholder');
                            var pcOverlay = document.getElementById('resultPcOverlay');
                            if (pcPh) pcPh.classList.add('hidden');
                            if (pcOverlay) pcOverlay.classList.remove('hidden');
                            setTimeout(function() { initOverlayPositions(); }, 50);
                        };
                        
                        // ì´ë¯¸ì§€ í• ë‹¹
                        pcImg.src = pcUrl;
                        forceShowMoDevelop();
                    } else { alert('ì´ë¯¸ì§€ ë””ë²¨ë¡­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
                } finally {
                    setGenerateStatus('');
                    setDevelopRegenDisabled(false);
                    if (loadingEl) { loadingEl.classList.remove('visible'); loadingEl.setAttribute('aria-hidden', 'true'); }
                }
            });
            regenBtn?.addEventListener('click', async function() {
                if (!selectedKeyword) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  ì‹œì•ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
                if (!lastImagePrompt) { alert('ë¨¼ì € AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¡œ ì´ë¯¸ì§€ë¥¼ ë§Œë“  ë’¤ ì¬ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
                var feedback = (document.getElementById('resultFeedback')?.value || '').trim();
                var moImg = document.getElementById('resultMoImage');
                var pcImg = document.getElementById('resultPcImage');
                var loadingEl = document.getElementById('imageLoadingOverlay');
                var loadingMsg = document.getElementById('imageLoadingOverlayMessage');
                if (loadingMsg) loadingMsg.textContent = 'PC ì‹œì•ˆ ì¬ìƒì„± ì¤‘...';
                setGenerateStatus('ìƒˆë¡œ ìƒì„± ì¤‘...');
                setDevelopRegenDisabled(true);
                if (loadingEl) { loadingEl.classList.add('visible'); loadingEl.setAttribute('aria-hidden', 'false'); }
                try {
                    var baseSeed = Math.floor(Math.random() * 1000000);
                    lastImageSeed = baseSeed;
                    var regenIntent = (feedback || lastDetailInstructions || '').trim();
                    if (loadingMsg) loadingMsg.textContent = 'MOÂ·PC ì‹œì•ˆ ë™ì‹œ ì¬ìƒì„± ì¤‘...';
                    var fusedMo = fusePrompt(selectedBrand, selectedKeyword, regenIntent, '', true, selectedAiMode || null);
                    var fusedPc = fusePrompt(selectedBrand, selectedKeyword, regenIntent, '', false, selectedAiMode || null);
                    var promMoRegen = fetchNanoBananaImage(selectedBrand, fusedMo, baseSeed, true, referenceImageUrl);
                    var promPcRegen = fetchNanoBananaImage(selectedBrand, fusedPc, baseSeed, false, referenceImageUrl);
                    var resultsRegen = await Promise.all([promMoRegen, promPcRegen]);
                    var moImageSrc = resultsRegen[0] || '';
                    var pcImageSrc = resultsRegen[1] || '';
                    if (!pcImageSrc && moImageSrc) pcImageSrc = moImageSrc;
                    lastGeneratedImageUrl = pcImageSrc;
                    lastGeneratedMoImageUrl = moImageSrc;
                    lastGeneratedPcImageUrl = pcImageSrc;
                    moImg.crossOrigin = pcImg.crossOrigin = 'anonymous';
                    var moPh = document.getElementById('resultMoPlaceholder');
                    var pcPh = document.getElementById('resultPcPlaceholder');
                    var moOverlay = document.getElementById('resultMoOverlay');
                    var pcOverlay = document.getElementById('resultPcOverlay');
                    function showMoRegen() {
                        moImg.classList.remove('hidden');
                        if (moPh) moPh.classList.add('hidden');
                        if (moOverlay) moOverlay.classList.remove('hidden');
                        setTimeout(function() { initOverlayPositions(); }, 50);
                    }
                    function showPcRegen() {
                        pcImg.classList.remove('hidden');
                        if (pcPh) pcPh.classList.add('hidden');
                        if (pcOverlay) pcOverlay.classList.remove('hidden');
                        setTimeout(function() { initOverlayPositions(); }, 50);
                    }
                    function hideMoRegen() {
                        moImg.classList.add('hidden');
                        if (moPh) moPh.classList.remove('hidden');
                        if (moOverlay) moOverlay.classList.add('hidden');
                    }
                    function hidePcRegen() {
                        pcImg.classList.add('hidden');
                        if (pcPh) pcPh.classList.remove('hidden');
                        if (pcOverlay) pcOverlay.classList.add('hidden');
                    }
                    
                    // ì¬ìƒì„± MO ì´ë¯¸ì§€ ìƒì„± ì¦‰ì‹œ í‘œì‹œ (resultMoImageì— moImageSrc í• ë‹¹ í›„ UI ì¦‰ì‹œ ì „í™˜)
                    function forceShowMoRegen() {
                        if (!moImageSrc) return;
                        var el = document.getElementById('resultMoImage');
                        if (!el || !el.parentNode) return;
                        lastGeneratedMoImageUrl = moImageSrc;
                        el.removeAttribute('crossorigin');
                        el.crossOrigin = '';
                        el.src = moImageSrc;
                        el.setAttribute('style', 'display: block !important; visibility: visible !important;');
                        el.style.setProperty('display', 'block', 'important');
                        el.style.setProperty('visibility', 'visible', 'important');
                        el.classList.remove('hidden');
                        if (moPh) moPh.classList.add('hidden');
                        if (moOverlay) moOverlay.classList.remove('hidden');
                        requestAnimationFrame(function() {
                            el.setAttribute('style', 'display: block !important; visibility: visible !important;');
                            el.classList.remove('hidden');
                        });
                        setTimeout(function() { initOverlayPositions(); }, 50);
                    }
                    moImg.onload = function() { 
                        moImg.classList.remove('hidden');
                        showMoRegen(); 
                    };
                    moImg.onerror = function() { 
                        hideMoRegen(); 
                    };
                    pcImg.onload = function() { 
                        showPcRegen(); 
                    };
                    pcImg.onerror = function() { 
                        hidePcRegen(); 
                    };
                    
                    // PC ì´ë¯¸ì§€ í• ë‹¹
                    if (pcImageSrc && pcImageSrc !== pcImg.src) {
                        pcImg.src = '';
                        setTimeout(function() { pcImg.src = pcImageSrc; }, 10);
                    } else if (pcImageSrc) {
                        pcImg.src = pcImageSrc;
                    }
                    if (pcImg.complete && pcImageSrc) {
                        setTimeout(function() { if (pcImg.src === pcImageSrc) showPcRegen(); }, 100);
                    }
                    
                    // MO: moImageSrc ìƒì„±ë˜ìë§ˆì resultMoImage.src í• ë‹¹, display/hidden !important ê°•ì œ
                    if (moImageSrc) {
                        if (moImg) {
                            moImg.src = moImageSrc;
                            moImg.style.setProperty('display', 'block', 'important');
                            moImg.style.setProperty('visibility', 'visible', 'important');
                            moImg.classList.remove('hidden');
                            if (moPh) moPh.classList.add('hidden');
                            if (moOverlay) moOverlay.classList.remove('hidden');
                        }
                        forceShowMoRegen();
                    } else {
                        console.error('ì¬ìƒì„± MO ì´ë¯¸ì§€ ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤! moImageSrc:', moImageSrc);
                    }
                } finally {
                    setGenerateStatus('');
                    setDevelopRegenDisabled(false);
                    if (loadingEl) { loadingEl.classList.remove('visible'); loadingEl.setAttribute('aria-hidden', 'true'); }
                }
            });
        });
    </script>

</body>
</html>