<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°íšì „ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.26/dist/interact.min.js"></script>
    <style>
        /* í•˜ë‹¨ ì‹œì•ˆ ì˜ì—­ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ë„˜ì–´ê°€ê¸° ìœ„í•œ ì„¤ì • */
        html { scroll-behavior: smooth; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* mainì´ í—¤ë”Â·ì¸ì‚¬ì´íŠ¸ ì•„ë˜ ë‚¨ì€ ë†’ì´ë¥¼ ê½‰ ì±„ìš°ë„ë¡ */
        html, body { height: 100%; }
        .main-content {
            flex: 1 1 0%;
            min-height: 0;
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            grid-template-rows: 1fr;
        }
        .overlay-text-box { position: absolute; cursor: move; user-select: none; white-space: nowrap; }
        .overlay-text-box.dragging { outline: 1px dashed rgba(255,255,255,0.9); outline-offset: 2px; }
        .overlay-text-box .resize-handle { position: absolute; right: -2px; bottom: -2px; width: 12px; height: 12px; cursor: nwse-resize; background: rgba(255,255,255,0.6); border-radius: 2px; }
        .overlay-text-box .resize-handle:hover { background: rgba(255,255,255,0.9); }
        .overlay-text-box[data-target^="mo-"] { white-space: normal; max-width: 88%; word-break: keep-all; line-height: 1.2; }
        .image-loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .image-loading-overlay.visible { display: flex; }
        .image-loading-overlay .spinner { width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 0.9s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-y-auto overflow-x-hidden min-h-screen">

    <!-- ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì „ì—­ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="imageLoadingOverlay" class="image-loading-overlay" aria-hidden="true">
        <div class="spinner" role="presentation"></div>
        <p id="imageLoadingOverlayMessage" class="text-lg font-semibold text-indigo-600">AI ë””ìì´ë„ˆê°€ ê³ í™”ì§ˆ ì‹œì•ˆì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <div id="dashboard" class="flex flex-col h-screen flex-shrink-0 overflow-hidden">
        <header class="w-full bg-white border-b z-10 shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-3xl font-bold text-indigo-600">Instant Campaign</h1>
            </div>
            <div class="px-4 py-4 flex gap-4 items-center bg-gray-50">
                <span class="font-medium text-gray-600">ë¸Œëœë“œ ì„ íƒ:</span>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="brand" value="DV" class="w-4 h-4 text-indigo-600" checked>
                    <span class="font-semibold">DV</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="brand" value="ST" class="w-4 h-4 text-indigo-600">
                    <span class="font-semibold">ST</span>
                </label>
            </div>
        </header>

        <div id="aiInsightBar" class="w-full bg-indigo-50 border-b border-indigo-100 shrink-0 px-4 py-3 flex gap-3 items-start">
            <span class="text-sm font-semibold text-indigo-700 whitespace-nowrap pt-0.5">ğŸ¤– AI MD ì œì•ˆ</span>
            <div id="aiInsightText" class="text-sm text-gray-700 min-w-0 flex-1 leading-relaxed whitespace-pre-wrap">íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì œì•ˆì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>

        <main class="main-content grid grid-cols-12 grid-rows-[1fr] gap-0 flex-1 min-h-0 overflow-hidden w-full">
        
        <section class="col-span-3 border-r bg-white p-4 min-h-0 overflow-y-auto">
            <h2 class="text-base font-bold mb-4 text-gray-700">1. ê²€ìƒ‰ì–´ ì„ íƒ</h2>
            <div class="flex items-center justify-between mb-2">
                <span id="trendsUpdateTime" class="text-sm font-bold text-gray-400 uppercase">íŠ¸ë Œë“œ (ë¡œë”© ì¤‘...)</span>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div class="mb-2 text-right">
                <span class="text-xs font-medium text-gray-600">ê²€ìƒ‰ëŸ‰</span>
            </div>
            <div id="trendsList" class="space-y-1">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  íŠ¸ë Œë“œ ë¦¬ìŠ¤íŠ¸ -->
            </div>
            <button type="button" id="trendsReloadBtn" class="mt-3 w-full py-2 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50">ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </section>

        <section class="col-span-5 border-r p-4 min-h-0 overflow-y-auto bg-gray-50">
            <h2 class="text-base font-bold mb-3 text-gray-700">2. ê¸°íšì „ í…œí”Œë¦¿</h2>
            <div class="grid grid-cols-2 gap-3">
                <div class="template-card relative bg-gray-100 rounded-lg p-4 cursor-pointer border-2 border-transparent transition-all duration-200 hover:scale-[1.02] hover:shadow-md ring-4 ring-indigo-500 ring-offset-2" data-template="A">
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ A</p>
                    <p class="text-xs text-gray-500 mb-2">ë°°ë„ˆí˜• Â· í‚¤ì›Œë“œ ê°•ì¡°</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><line x1="0" y1="20" x2="120" y2="20" stroke="currentColor" stroke-width="1"/><line x1="0" y1="40" x2="80" y2="40" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded bg-indigo-600 text-white font-medium" data-template="A" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="A" data-variant="MO">MO</button>
                    </div>
                </div>
                <div class="template-card template-card--preparing relative bg-gray-100 rounded-lg p-4 border-2 border-transparent transition-all duration-200 opacity-75 cursor-not-allowed pointer-events-none" data-template="B">
                    <div class="absolute inset-0 rounded-lg bg-gray-200/80 flex items-center justify-center z-10 pointer-events-auto">
                        <span class="text-sm font-bold text-gray-600">ì¤€ë¹„ì¤‘</span>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white hidden template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ B</p>
                    <p class="text-xs text-gray-500 mb-2">ì¹´ë“œí˜• Â· ì„¸ì¼ì¦ˆ ê°•ì¡°</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><rect x="5" y="5" width="35" height="25" fill="none" stroke="currentColor" stroke-width="1"/><rect x="45" y="5" width="35" height="25" fill="none" stroke="currentColor" stroke-width="1"/><rect x="85" y="5" width="30" height="25" fill="none" stroke="currentColor" stroke-width="1"/><rect x="5" y="35" width="55" height="20" fill="none" stroke="currentColor" stroke-width="1"/><rect x="65" y="35" width="50" height="20" fill="none" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="B" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="B" data-variant="MO">MO</button>
                    </div>
                </div>
                <div class="template-card template-card--preparing relative bg-gray-100 rounded-lg p-4 border-2 border-transparent transition-all duration-200 opacity-75 cursor-not-allowed pointer-events-none" data-template="C">
                    <div class="absolute inset-0 rounded-lg bg-gray-200/80 flex items-center justify-center z-10 pointer-events-auto">
                        <span class="text-sm font-bold text-gray-600">ì¤€ë¹„ì¤‘</span>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white hidden template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ C</p>
                    <p class="text-xs text-gray-500 mb-2">ë¦¬ìŠ¤íŠ¸í˜• Â· ë¸Œëœë“œ ìŠ¤í† ë¦¬</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><line x1="10" y1="12" x2="110" y2="12" stroke="currentColor" stroke-width="1"/><line x1="10" y1="24" x2="110" y2="24" stroke="currentColor" stroke-width="1"/><line x1="10" y1="36" x2="90" y2="36" stroke="currentColor" stroke-width="1"/><line x1="10" y1="48" x2="100" y2="48" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="C" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="C" data-variant="MO">MO</button>
                    </div>
                </div>
                <div class="template-card template-card--preparing relative bg-gray-100 rounded-lg p-4 border-2 border-transparent transition-all duration-200 opacity-75 cursor-not-allowed pointer-events-none" data-template="D">
                    <div class="absolute inset-0 rounded-lg bg-gray-200/80 flex items-center justify-center z-10 pointer-events-auto">
                        <span class="text-sm font-bold text-gray-600">ì¤€ë¹„ì¤‘</span>
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white hidden template-check">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <p class="text-sm font-bold text-gray-800 mb-1">í…œí”Œë¦¿ D</p>
                    <p class="text-xs text-gray-500 mb-2">ì´ë²¤íŠ¸í˜• Â· í”„ë¡œëª¨ì…˜ ê°•ì¡°</p>
                    <div class="aspect-video max-h-24 rounded bg-white border border-gray-200 overflow-hidden flex items-center justify-center mb-2">
                        <svg class="w-full h-full p-1 text-indigo-200" viewBox="0 0 120 60" preserveAspectRatio="none"><rect width="120" height="60" fill="none" stroke="currentColor" stroke-width="1"/><rect x="10" y="10" width="100" height="15" fill="none" stroke="currentColor" stroke-width="1"/><rect x="10" y="30" width="45" height="20" fill="none" stroke="currentColor" stroke-width="1"/><rect x="65" y="30" width="45" height="20" fill="none" stroke="currentColor" stroke-width="1"/></svg>
                    </div>
                    <div class="flex gap-1.5 p-1.5 bg-white rounded border border-gray-200 w-fit" onclick="event.stopPropagation()">
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="D" data-variant="PC">PC</button>
                        <button type="button" class="template-variant px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-100" data-template="D" data-variant="MO">MO</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="col-span-4 p-4 min-h-0 overflow-y-auto bg-white">
            <h2 class="text-base font-bold mb-4 text-gray-700">3. ìƒì„¸ ì„¤ì •</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê°•ì¡° ì˜µì…˜</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-4 py-2 rounded-full bg-indigo-600 text-white text-sm">ì„¸ì¼ì¦ˆ ê°•ì¡°</button>
                        <button class="px-4 py-2 rounded-full bg-white border text-gray-600 text-sm hover:bg-gray-100">í‚¤ì›Œë“œ ê°•ì¡°</button>
                        <button class="px-4 py-2 rounded-full bg-white border text-gray-600 text-sm hover:bg-gray-100">ë¸Œëœë“œ ìŠ¤í† ë¦¬ ê°•ì¡°</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì°¸ì¡° ì´ë¯¸ì§€ ì²¨ë¶€</label>
                    <div id="referenceImageZone" class="w-full h-24 border-2 border-dashed rounded-lg flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="file" id="referenceImageInput" accept="image/*" class="hidden">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
                        <span id="referenceImageLabel" class="text-xs">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</span>
                    </div>
                </div>
                <div id="aiModeSection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI ìƒì„± ëª¨ë“œ</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="aiGenerateMode" value="similar" class="w-4 h-4 text-indigo-600" disabled>
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">ìœ ì‚¬ ì¬ìƒì„±</span> â€” êµ¬ë„/í¬ì¦ˆ ìœ ì§€, ë¸Œëœë“œ ìŠ¤íƒ€ì¼ë¡œ ì¬ì°½ì¡°</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="aiGenerateMode" value="cutout" class="w-4 h-4 text-indigo-600" disabled>
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">ëˆ„ë¼/ë°°ê²½êµì²´</span> â€” ëª¨ë¸ ê³ ì •, ë°°ê²½ë§Œ ë¸Œëœë“œ ì»¨ì…‰ìœ¼ë¡œ</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="aiGenerateMode" value="mood" class="w-4 h-4 text-indigo-600" disabled>
                            <span class="text-sm text-gray-600"><span class="font-medium text-indigo-700">ë¶„ìœ„ê¸° ì°¸ì¡°</span> â€” ìƒ‰ê°/ëŠë‚Œë§Œ ì°¸ê³ í•˜ì—¬ ììœ  ìƒì„±</span>
                        </label>
                    </div>
                    <p id="aiModeHint" class="mt-1.5 text-xs text-gray-400">ì°¸ì¡° ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ë©´ ëª¨ë“œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê¸°íš ì˜ë„ ë° ê°•ì¡°ì </label>
                    <textarea id="campaignIntent" class="w-full border rounded-lg p-3 h-24 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: ì‹ ê·œ íšŒì› ê°€ì… í˜œíƒì„ ê°€ì¥ í¬ê²Œ ë³´ì—¬ì¤˜."></textarea>
                </div>
                <p id="generateStatus" class="text-sm text-indigo-600 min-h-[1.5rem] py-1"></p>
                <button id="generateButton" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg">
                    AI ì‹œì•ˆ ìƒì„±í•˜ê¸° â†“
                </button>
            </div>
        </section>
    </main>
    </div>

    <div id="result" class="min-h-screen w-full bg-indigo-50/60 border-t-2 border-indigo-200 p-4 md:p-6 scroll-mt-4">
        <div class="grid grid-cols-12 gap-0 w-full max-w-full">
            <div class="col-span-12 mb-4">
                <h2 class="text-2xl font-bold text-gray-800 border-b border-indigo-300 pb-3">AI ìƒì„± ê¸°íšì „ ì‹œì•ˆ</h2>
            </div>

            <!-- ì¢Œ+ì¤‘ì•™: ì‹œì•ˆ ê°¤ëŸ¬ë¦¬ (col-span-8) â€” ë¹„ìœ¨ ìœ ì§€, í…ìŠ¤íŠ¸ í¸ì§‘ê³¼ ê°„ê²© í™•ë³´ -->
            <div class="col-span-12 lg:col-span-8 flex flex-col min-h-0 pr-0 lg:pr-6">
                <div class="flex flex-row items-center justify-start gap-4 h-[440px] min-h-[440px] max-w-full rounded-xl border border-indigo-200/80 bg-white shadow-sm overflow-x-auto overflow-y-hidden p-4">
                    <div id="resultMoCapture" class="relative overflow-hidden rounded-lg flex-shrink-0 h-full w-auto" style="aspect-ratio: 2304/3500;">
                        <img id="resultMoImage" src="" alt="MO ì‹œì•ˆ" class="absolute inset-0 w-full h-full object-cover object-center hidden">
                        <p id="resultMoPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500 py-12 px-6 text-center text-sm bg-gray-100">í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
                        <div id="resultMoOverlay" class="absolute inset-0 bg-gradient-to-b from-black/30 to-transparent hidden" style="pointer-events:none">
                            <div class="overlay-text-box" data-target="mo-brand" style="pointer-events:auto; left:0; top:0;"><span id="resultMoBrand" class="font-bold text-white/95 tracking-wide">DV 26SS ì»¬ë ‰ì…˜</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                            <div class="overlay-text-box" data-target="mo-keyword" style="pointer-events:auto; left:0; top:0;"><span id="resultMoKeyword" class="font-black text-white tracking-tight uppercase leading-tight break-words">í‚¤ì›Œë“œ</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                        </div>
                    </div>
                    <div id="resultPcCapture" class="relative overflow-hidden rounded-lg flex-shrink-0 h-full w-auto" style="aspect-ratio: 3840/1760;">
                        <img id="resultPcImage" src="" alt="PC ì‹œì•ˆ" class="absolute inset-0 w-full h-full object-cover object-center hidden">
                        <p id="resultPcPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500 py-12 px-6 text-center text-sm bg-gray-100">í‚¤ì›Œë“œ ì„ íƒ í›„ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
                        <div id="resultPcOverlay" class="absolute inset-0 bg-gradient-to-b from-black/30 to-transparent hidden" style="pointer-events:none">
                            <div class="overlay-text-box" data-target="pc-brand" style="pointer-events:auto; left:0; top:0;"><span id="resultPcBrand" class="font-bold text-white/95 tracking-wide">DV 26SS ì»¬ë ‰ì…˜</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                            <div class="overlay-text-box" data-target="pc-keyword" style="pointer-events:auto; left:0; top:0;"><span id="resultPcKeyword" class="font-black text-white tracking-tight uppercase leading-tight break-words">í‚¤ì›Œë“œ</span><span class="resize-handle" title="í¬ê¸° ì¡°ì ˆ"></span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìš°ì¸¡: ì»¨íŠ¸ë¡¤ íŒ¨ë„ (col-span-4) â€” ìƒë‹¨ 3ë²ˆ(col-span-4)ê³¼ ê°€ë¡œ ë™ì¼ -->
            <div class="col-span-12 lg:col-span-4 p-4 min-h-0 overflow-y-auto bg-white border-l border-gray-200 flex flex-col gap-6">
                <h3 class="text-base font-bold text-gray-700">í…ìŠ¤íŠ¸ í¸ì§‘</h3>
                <div class="rounded-lg bg-amber-50 border border-amber-200/80 px-3 py-2 mb-3">
                    <p class="text-xs text-amber-800 font-medium">ë¬¸êµ¬ê°€ ì‹œì•ˆì—ì„œ ì˜ ë³´ì´ë ¤ë©´ ì§§ê²Œ ì“°ì„¸ìš”.</p>
                    <p class="text-xs text-amber-700 mt-0.5">ìƒë‹¨ ë¬¸êµ¬ 10ì ë‚´ì™¸, ë©”ì¸ ë¬¸êµ¬ 15ì ë‚´ì™¸(ì˜ë¬¸ì´ë©´ 3~4ë‹¨ì–´) ê¶Œì¥.</p>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒë‹¨ ë¬¸êµ¬</label>
                        <input type="text" id="editBrand" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: DV 26SS ì»¬ë ‰ì…˜" maxlength="20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë©”ì¸ ë¬¸êµ¬</label>
                        <input type="text" id="editKeyword" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: SPRING IN QUIET LIGHT" maxlength="25">
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">ë¬¸êµ¬ í¬ê¸° (px)</p>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">MO ìƒë‹¨</label>
                                <input type="number" id="editMoBrandSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="14" placeholder="8~72">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">MO ë©”ì¸</label>
                                <input type="number" id="editMoKeywordSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="28" placeholder="8~72">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">PC ìƒë‹¨</label>
                                <input type="number" id="editPcBrandSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="16" placeholder="8~72">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-0.5">PC ë©”ì¸</label>
                                <input type="number" id="editPcKeywordSize" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm" min="8" max="72" value="36" placeholder="8~72">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-base font-bold text-gray-700 mb-2">ë””ë ‰ì…˜ & ì¬ìƒì„±</h3>
                    <textarea id="resultFeedback" rows="4" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-gray-800 text-sm placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 outline-none resize-y min-h-[100px]" placeholder="ìì—°ì–´ í”¼ë“œë°± ì…ë ¥ (ì˜ˆ: ë°°ê²½ì„ ë” ë°ê²Œ, í†¤ ë‹¤ìš´ ë“±)"></textarea>
                    <div class="mt-2 flex flex-wrap gap-2 justify-end">
                        <button type="button" id="developImageBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium border border-indigo-600">ì´ë¯¸ì§€ ë””ë²¨ë¡­</button>
                        <button type="button" id="regenerateImageBtn" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-800 text-white text-sm font-medium border border-gray-700">ì´ë¯¸ì§€ ì¬ìƒì„±</button>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-200">
                    <h3 class="text-base font-bold text-gray-700 mb-2">ë‹¤ìš´ë¡œë“œ</h3>
                    <div class="flex flex-col gap-2">
                        <button type="button" id="downloadMoBtn" class="w-full py-2.5 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors">MO ì‹œì•ˆ ì €ì¥ (PNG)</button>
                        <button type="button" id="downloadPcBtn" class="w-full py-2.5 text-sm font-medium text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors">PC ì‹œì•ˆ ì €ì¥ (PNG)</button>
                        <button type="button" id="downloadAllBtn" class="w-full py-3 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 border border-indigo-600 rounded-lg transition-colors">ëª¨ë“  ì‹œì•ˆ ì••ì¶• ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="window.scrollTo(0,0);" class="mt-8 text-indigo-600 underline hover:text-indigo-800 text-sm font-medium">ë‹¤ì‹œ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</button>
    </div>

    <script>
        // ========== API ë° í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ìµœìƒë‹¨) ==========
        function getGeminiApiKey() { return 'AIzaSyDqoWOtsSfhu3-cUvfxFqqZnkIvuUOK1mQ'; }
        function getFalApiKey() { return 'a0eec544-5fd2-4ae8-9d86-fe56df3c9013:ff5988995ef98d6c11596cb57f3d6028'; }
        const IS_TEST_MODE = false;
        
        // ì„ íƒëœ í‚¤ì›Œë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let selectedKeyword = null;
        // íŠ¸ë Œë“œ í‚¤ì›Œë“œ ëª©ë¡ (ê²€ìƒ‰ëŸ‰ ë‚´ë¦¼ì°¨ìˆœ) â€” ë¡œë“œ í›„ AI ì œì•ˆì— ì‚¬ìš©
        let currentTrendKeywords = [];
        // ì„ íƒëœ ë¸Œëœë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let selectedBrand = 'DV';
        // ì„ íƒëœ í…œí”Œë¦¿ì„ ì €ì¥í•  ë³€ìˆ˜ (A/B/C/D)
        let selectedTemplate = 'A';
        // ì„ íƒëœ ë ˆì´ì•„ì›ƒ (PC/MO)
        let selectedVariant = 'PC';
        // ë§ˆì§€ë§‰ ìƒì„±ëœ ì´ë¯¸ì§€ URL / í”„ë¡¬í”„íŠ¸ (ë””ë²¨ë¡­Â·ì¬ìƒì„±ìš©)
        let lastGeneratedImageUrl = '';
        let lastImagePrompt = '';
        let lastDetailInstructions = '';
        let lastAiMode = 'mood';
        
        // ë¸Œëœë“œ ë””ìì¸ DNAÂ·ì² í•™ â€” AI ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ìƒì„± ì‹œ ì ˆëŒ€ ì›ì¹™
        const BRAND_KNOWLEDGE = {
            DV: {
                fullName: "Duvetica",
                philosophy: "La Bella Vita (ì¸ìƒì„ ì¦ê¸°ëŠ” ì´íƒˆë¦¬ì•„ì¸ì˜ ì‚¶)",
                coreValues: ["Premium Lifestyle", "Joyful", "Colorful", "Ethical Luxury"],
                visualIdentity: {
                    mood: "ì„¸ë ¨ëœ ì´íƒˆë¦¬ì•ˆ ê°ì„±, ìœ ë‹ˆí¬í•œ ì»¬ëŸ¬ê°, í”„ë¦¬ë¯¸ì—„í•œ ë³¼ë¥¨ê°",
                    background: "ëª¨ë˜í•œ ê±´ì¶•ë¬¼, ê³ ê¸‰ìŠ¤ëŸ¬ìš´ íœ´ì–‘ì§€, í˜¹ì€ ì œí’ˆ ìƒ‰ìƒì„ ê°•ì¡°í•˜ëŠ” ë¯¸ë‹ˆë©€í•œ ë°°ê²½",
                    lighting: "ìœ ê´‘(Glossy) ì†Œì¬ì˜ ì§ˆê°ì„ ì‚´ë¦¬ëŠ” ì„ ëª…í•˜ê³  ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë¹›"
                },
                textStyle: "í™”ì´íŠ¸ ë³¼ë“œ ì‚°ì„¸ë¦¬í”„, ìƒë‹¨ ì¤‘ì•™ ë˜ëŠ” ì—¬ë°±ì„ í™œìš©í•œ ë°°ì¹˜"
            },
            ST: {
                fullName: "Sergio Tacchini",
                philosophy: "Tennis Heritage & Italian Classic (í…Œë‹ˆìŠ¤ ìœ ì‚°ê³¼ í´ë˜ì‹ì˜ ì¡°í™”)",
                coreValues: ["Sporty Elegance", "Classic Silhouette", "Active Lifestyle", "Authentic"],
                visualIdentity: {
                    mood: "ìš°ì•„í•œ í…Œë‹ˆìŠ¤ ì½”íŠ¸ í—¤ë¦¬í‹°ì§€, í´ë˜ì‹ ì•¡í‹°ë¸Œì›¨ì–´, ì •êµí•œ ì‹¤ë£¨ì—£",
                    background: "í”„ë¦¬ë¯¸ì—„ í…Œë‹ˆìŠ¤ í´ëŸ½, í´ë˜ì‹í•œ ì½”íŠ¸, ìš°ì•„í•œ ìŠ¤í¬ì¸  ë¼ìš´ì§€",
                    lighting: "ìì—°ìŠ¤ëŸ½ê³  í™”ì‚¬í•œ í–‡ì‚´, í´ë˜ì‹í•˜ê³  ê¹¨ë—í•œ í†¤"
                },
                textStyle: "í´ë˜ì‹í•˜ê³  ì„¸ë ¨ëœ í°íŠ¸, ì¢Œì¸¡ ì¤‘ì•™ ë˜ëŠ” ì•ˆì •ì ì¸ ëŒ€ì¹­ ë°°ì¹˜"
            }
        };
        
        // ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ êµ¬ë„ ì„¤ëª… (ì‚¬ì§„ ì—…ë¡œë“œ ê¸°ëŠ¥ ì—°ë™ ì‹œ ì„¤ì •)
        let referenceImageComposition = '';
        let hasReferenceImage = false;
        let selectedAiMode = 'mood';
        
        // í”„ë¡¬í”„íŠ¸ ì—”ì§„: í‚¤ì›Œë“œ ì„ ë‘ + ëª¨ë“œë³„ ë¬¸êµ¬ + ë¸Œëœë“œ DNA (ë‚˜ë…¸ë°”ë‚˜ë‚˜ìš© ì˜ì–´ ë¬˜ì‚¬ë¬¸)
        function buildImagePrompt(brandKey, keyword, campaignIntent, referenceDescription, mode) {
            var brand = BRAND_KNOWLEDGE[brandKey];
            if (!brand) return '';
            var v = brand.visualIdentity;
            var values = (brand.coreValues || []).join(', ');
            var brandName = brand.fullName || brandKey;
            var kw = (keyword || '').trim();
            var ref = (referenceDescription || '').trim();
            mode = mode || (ref ? 'similar' : 'mood');
            
            var keywordLead = 'Highly detailed, ' + (kw ? kw + ' core aesthetic. ' : '') + (kw ? 'The image must be dominated by the "' + kw + '" mood and atmosphere. ' : '');
            var brandBlock = 'Brand: ' + brandName + '. ' + (v.mood ? 'Style: ' + v.mood + '. ' : '') + (v.background ? 'Background: ' + v.background + '. ' : '') + (v.lighting ? 'Lighting: ' + v.lighting + '. ' : '') + 'Core values: ' + values + '.';
            var campaignLine = campaignIntent ? ' Campaign intent: ' + campaignIntent + '.' : '';
            
            var modePrompt = '';
            if (mode === 'similar' && ref) {
                modePrompt = 'A professional lookbook shot in ' + (kw || 'premium') + ' atmosphere, with ' + brandName + '\'s premium touch. Keep this exact pose and composition from the reference, re-create with brand style. Reference: ' + ref + '. ';
            } else if (mode === 'cutout' && ref) {
                modePrompt = 'Keep the subject/object exactly as in the reference, but change only the background to a ' + (kw || 'themed') + ' theme following ' + brandName + ' style. Reference composition: ' + ref + '. ';
            } else {
                modePrompt = (kw ? 'Free creation with strong ' + kw + ' mood and atmosphere. ' : '') + 'Reference only the color and feeling; ' + (v.mood || '') + '. ';
            }
            
            return keywordLead + modePrompt + brandBlock + campaignLine;
        }
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function setGenerateStatus(msg) {
            var el = document.getElementById('generateStatus');
            if (el) el.textContent = msg || '';
        }
        
        // Gemini: v1beta + gemini-2.0-flash ë‹¨ì¼ ì£¼ì†Œ. 429 ë“± ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ í›„ ë¡œì»¬ ì—”ì§„ ë°˜í™˜
        function getLocalFallback(brandKey, keyword, campaignIntent, referenceDescription, aiMode) {
            var brand = BRAND_KNOWLEDGE[brandKey];
            return {
                imagePrompt: buildImagePrompt(brandKey, keyword, campaignIntent, referenceDescription, aiMode),
                brandCopy: (brand && brand.fullName) ? brand.fullName + ' 26SS ì»¬ë ‰ì…˜' : (brandKey || '') + ' 26SS ì»¬ë ‰ì…˜',
                keywordCopy: keyword || ''
            };
        }
        
        async function callGeminiForPromptAndCopy(brandKey, keyword, campaignIntent, referenceDescription, aiMode) {
            var brand = BRAND_KNOWLEDGE[brandKey];
            if (!brand) return getLocalFallback(brandKey, keyword, campaignIntent, referenceDescription, aiMode);
            var refNote = referenceDescription ? 'ì°¸ì¡° ì´ë¯¸ì§€ êµ¬ë„/ì„¤ëª…: ' + referenceDescription : 'ì°¸ì¡° ì´ë¯¸ì§€ ì—†ìŒ';
            var modeLabel = { similar: 'ìœ ì‚¬ ì¬ìƒì„±(êµ¬ë„ ìœ ì§€)', cutout: 'ëˆ„ë¼/ë°°ê²½êµì²´', mood: 'ë¶„ìœ„ê¸° ì°¸ì¡°' }[aiMode] || aiMode;
            var promptText = [
                'You are a creative director. Respond with ONLY a valid JSON object (no markdown) with exactly these keys: "imagePrompt" (string), "brandCopy" (string, very short brand/collection line for banner visibility: under 15 characters including spaces, e.g. "DV 26SS ì»¬ë ‰ì…˜"), "keywordCopy" (string, short impactful headline: under 20 characters or 3-4 words in English so it fits MO/PC without truncation).',
                '',
                'IMAGE PROMPT RULES (critical):',
                '1. Create a highly descriptive image prompt in English. Translate the user\'s keywords and detailed instructions into specific visual styles, textures, lighting, and background descriptions. Do not just use the keywords as text; turn them into a scene.',
                '2. Keyword visualization: e.g. keyword "ìŠˆí¼ë³¼" â†’ include "Super Bowl core aesthetic, stadium lighting, sporty luxury mood"; "ì´íƒˆë¦¬ì•„ íœ´ì–‘ì§€" â†’ "Amalfi coast background, Mediterranean sunlight". Always convert the keyword into concrete visual mood and setting, not as on-screen text.',
                '3. The user\'s detailed instructions (campaign intent and reference description below) must be the HIGHEST PRIORITY: put them at the very beginning of imagePrompt, translated into English. E.g. "ìœ ê´‘ ì†Œì¬ ê°•ì¡°" â†’ "glossy material emphasis, reflective surfaces"; "ì–´ë‘ìš´ ë°°ê²½" â†’ "dark background, moody shadows".',
                '',
                'Brand (absolute rule): ' + JSON.stringify(brand),
                'Keyword: ' + (keyword || ''),
                'Campaign intent (MUST appear first in imagePrompt, in English): ' + (campaignIntent || ''),
                refNote,
                'AI mode: ' + modeLabel,
                'Return only a JSON object.'
            ].join('\n');
            var apiKey = getGeminiApiKey();
            var url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey;
            var requestBody = {
                contents: [{ parts: [{ text: promptText }] }],
                generationConfig: { response_mime_type: 'application/json' }
            };
            try {
                var res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                var data = await res.json();
                console.log('Gemini API ì‘ë‹µ (gemini-2.0-flash):', data);
                if (!res.ok) {
                    console.error('Gemini API ì—ëŸ¬:', 'response.status=' + res.status, 'response.statusText=' + res.statusText, data);
                    if (res.status === 429) {
                        alert('í˜¸ì¶œëŸ‰ì´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” (ë¡œì»¬ ì—”ì§„ìœ¼ë¡œ ìë™ ì „í™˜í•©ë‹ˆë‹¤)');
                    }
                    return getLocalFallback(brandKey, keyword, campaignIntent, referenceDescription, aiMode);
                }
                if (data.error) {
                    console.error('Gemini API ì—ëŸ¬:', 'response.status=' + res.status, 'response.statusText=' + res.statusText, data.error);
                    if (res.status === 429) {
                        alert('í˜¸ì¶œëŸ‰ì´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” (ë¡œì»¬ ì—”ì§„ìœ¼ë¡œ ìë™ ì „í™˜í•©ë‹ˆë‹¤)');
                    }
                    return getLocalFallback(brandKey, keyword, campaignIntent, referenceDescription, aiMode);
                }
                var text = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : '';
                if (!text) return getLocalFallback(brandKey, keyword, campaignIntent, referenceDescription, aiMode);
                text = text.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
                var jsonMatch = text.match(/\{[\s\S]*\}/);
                var parsed = jsonMatch ? JSON.parse(jsonMatch[0]) : {};
                console.log('Gemini íŒŒì‹± ê²°ê³¼ (imagePrompt, brandCopy, keywordCopy):', parsed);
                return {
                    imagePrompt: (parsed.imagePrompt || '').trim() || buildImagePrompt(brandKey, keyword, campaignIntent, referenceDescription, aiMode),
                    brandCopy: (parsed.brandCopy || '').trim() || (brand.fullName || brandKey) + ' 26SS ì»¬ë ‰ì…˜',
                    keywordCopy: (parsed.keywordCopy || '').trim() || (keyword || '')
                };
            } catch (e) {
                console.error('Gemini í˜¸ì¶œ ì˜ˆì™¸:', e.message || e);
                return getLocalFallback(brandKey, keyword, campaignIntent, referenceDescription, aiMode);
            }
        }
        
        // fal.ai Flux ì´ë¯¸ì§€ ìƒì„± (ë°°ë„ˆ ë¹„ìœ¨). ìƒì„¸ ì§€ì¹¨(detailInstructions)ì´ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ ìµœìš°ì„ ì— ë°˜ì˜
        function fetchNanoBananaImage(prompt, mode, detailInstructions) {
            var finalPrompt = (detailInstructions && (detailInstructions = String(detailInstructions).trim())) ? ('Critical visual requirements - apply first: ' + detailInstructions + '. ') + (prompt || '') : (prompt || 'fashion banner, high quality');
            if (IS_TEST_MODE) {
                console.log('ìµœì¢… í”„ë¡¬í”„íŠ¸:', finalPrompt);
                var seed = encodeURIComponent(selectedKeyword || 'campaign');
                return Promise.resolve('https://picsum.photos/seed/' + seed + '/1920/1080');
            }
            var apiKey = getFalApiKey();
            return fetch('https://fal.run/fal-ai/flux/dev', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Key ' + apiKey
                },
                body: JSON.stringify({
                    prompt: finalPrompt,
                    image_size: 'landscape_16_9'
                })
            })
                .then(function(r) {
                    if (!r.ok) throw new Error('fal.ai ì‘ë‹µ ì˜¤ë¥˜: ' + r.status);
                    return r.json();
                })
                .then(function(data) {
                    var url = (data && data.images && data.images[0] && data.images[0].url) ? data.images[0].url : null;
                    if (!url) throw new Error('fal.ai ì´ë¯¸ì§€ URL ì—†ìŒ');
                    return url;
                })
                .catch(function(err) {
                    console.error('fal.ai ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', err);
                    return 'https://picsum.photos/seed/fallback/1920/1080';
                });
        }
        
        // fal.ai Flux Image-to-Image (ë””ë²¨ë¡­: í˜„ì¬ ì´ë¯¸ì§€ + í”¼ë“œë°± ë°˜ì˜)
        function fetchFluxImageToImage(imageUrl, prompt, strength) {
            strength = strength == null ? 0.5 : Math.min(1, Math.max(0, strength));
            if (IS_TEST_MODE) {
                console.log('image-to-image:', { imageUrl: imageUrl, prompt: prompt, strength: strength });
                return Promise.resolve(imageUrl || 'https://picsum.photos/seed/dev/1920/1080');
            }
            var apiKey = getFalApiKey();
            return fetch('https://fal.run/fal-ai/flux/dev/image-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Key ' + apiKey
                },
                body: JSON.stringify({
                    image_url: imageUrl,
                    prompt: prompt || 'Keep the same composition, improve quality.',
                    strength: strength
                })
            })
                .then(function(r) {
                    if (!r.ok) throw new Error('fal.ai image-to-image ì‘ë‹µ ì˜¤ë¥˜: ' + r.status);
                    return r.json();
                })
                .then(function(data) {
                    var url = (data && data.images && data.images[0] && data.images[0].url) ? data.images[0].url : null;
                    if (!url) throw new Error('fal.ai image-to-image URL ì—†ìŒ');
                    return url;
                })
                .catch(function(err) {
                    console.error('fal.ai ì´ë¯¸ì§€ ë””ë²¨ë¡­ ì‹¤íŒ¨:', err);
                    return null;
                });
        }
        
        // CSV íŒŒì‹± í•¨ìˆ˜
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const rows = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // CSV íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
                const values = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());
                
                rows.push(values);
            }
            
            return rows;
        }
        
        // Gì—´ ê²€ìƒ‰ëŸ‰ ë¬¸ìì—´ì„ ì •ë ¬ìš© ìˆ«ìë¡œ ë³€í™˜ (ì˜ˆ: "ê²€ìƒ‰ 200+íšŒ"â†’200, "ê²€ìƒ‰ 1ë§Œ+íšŒ"â†’10000)
        function parseCountForSort(countStr) {
            if (!countStr || typeof countStr !== 'string') return 0;
            const s = countStr.trim();
            if (s.toLowerCase().includes('search count')) return 0;
            const man = s.match(/(\d+)\s*ë§Œ/);
            if (man) return (parseInt(man[1], 10) || 0) * 10000;
            const chun = s.match(/(\d+)\s*ì²œ/);
            if (chun) return (parseInt(chun[1], 10) || 0) * 1000;
            const num = s.match(/(\d+)/);
            return num ? parseInt(num[1], 10) || 0 : 0;
        }
        
        // ê²€ìƒ‰ëŸ‰ í¬ë§·íŒ… í•¨ìˆ˜
        function formatSearchCount(count) {
            const num = parseInt(count);
            if (isNaN(num)) return count;
            
            if (num >= 100000) {
                return Math.floor(num / 10000) + 'ë§Œ+';
            } else if (num >= 10000) {
                return Math.floor(num / 1000) + 'ì²œ+';
            } else if (num >= 1000) {
                return Math.floor(num / 1000) + 'ì²œ+';
            }
            return num.toString();
        }
        
        // íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ UIì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function fetchTrends() {
            // ì›ë³¸ Google Sheets CSV URL (Trending Searches ì‹œíŠ¸, ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
            const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWv_8Md3vx8TZezAFvPUQuGJR2cKZZ-PcEelMqGqBhnSTyuXtQi54Kw2dauVa6t-4ZOul_7TiRPz_v/pub?gid=15033788&single=true&output=csv&t=' + Date.now();
            const trendsListContainer = document.getElementById('trendsList');
            const trendsUpdateTime = document.getElementById('trendsUpdateTime');
            
            // í”„ë¡ì‹œ URL ëª©ë¡ (í´ë°± ìˆœì„œ)
            const proxyUrls = [
                'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(originalUrl),
                'https://api.allorigins.win/raw?url=' + encodeURIComponent(originalUrl)
            ];
            
            let csvText = null;
            let lastError = null;
            
            try {
                // ë¡œë”© í‘œì‹œ
                trendsListContainer.innerHTML = '<div class="p-2 text-sm text-gray-500">ë¡œë”© ì¤‘...</div>';
                
                // í”„ë¡ì‹œë¥¼ í†µí•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
                for (let i = 0; i < proxyUrls.length; i++) {
                    try {
                        console.log(`í”„ë¡ì‹œ ${i + 1} ì‹œë„ ì¤‘:`, proxyUrls[i].substring(0, 50) + '...');
                        const response = await fetch(proxyUrls[i], {
                            mode: 'cors',
                            cache: 'no-store'
                        });
                        
                        if (response.ok) {
                            csvText = await response.text();
                            console.log(`í”„ë¡ì‹œ ${i + 1} ì„±ê³µ!`);
                            break;
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.warn(`í”„ë¡ì‹œ ${i + 1} ì‹¤íŒ¨:`, error.message);
                        lastError = error;
                        continue;
                    }
                }
                
                // í”„ë¡ì‹œê°€ ëª¨ë‘ ì‹¤íŒ¨í•˜ë©´ ì§ì ‘ fetch ì‹œë„
                if (!csvText) {
                    try {
                        console.log('ì§ì ‘ fetch ì‹œë„ ì¤‘...');
                        const response = await fetch(originalUrl, {
                            mode: 'cors',
                            cache: 'no-store'
                        });
                        
                        if (response.ok) {
                            csvText = await response.text();
                            console.log('ì§ì ‘ fetch ì„±ê³µ!');
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.warn('ì§ì ‘ fetch ì‹¤íŒ¨:', error.message);
                        lastError = error;
                    }
                }
                
                // ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•œ ê²½ìš°
                if (!csvText) {
                    throw lastError || new Error('ëª¨ë“  ë°ì´í„° ë¡œë“œ ë°©ë²•ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ë””ë²„ê¹… ë¡œê·¸: ì›ë³¸ ë°ì´í„° í™•ì¸
                console.log('ê°€ì ¸ì˜¨ ì›ë³¸ ë°ì´í„°:', csvText.substring(0, 100));
                
                // ì‘ë‹µ í˜•ì‹ í™•ì¸ ë° ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”
                if (!csvText) {
                    throw new Error('CSV ì‘ë‹µì´ nullì…ë‹ˆë‹¤.');
                }
                
                // BOM ì œê±° (ì¼ë¶€ ë‚´ë³´ë‚´ê¸°/ì—‘ì…€ì—ì„œ ë¶™ëŠ” ê²½ìš°)
                csvText = csvText.replace(/^\uFEFF/, '');
                const trimmedText = csvText.trim();
                if (trimmedText === '' || trimmedText.length === 0) {
                    throw new Error('CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
                
                // CSVë¥¼ í–‰ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
                const lines = csvText.split('\n');
                const rows = [];
                
                // ê° í–‰ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // CSV íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
                    const values = [];
                    let currentValue = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue.trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue.trim());
                    
                    rows.push(values);
                }
                
                console.log('ì „ì²´ í–‰ ê°œìˆ˜:', rows.length);
                
                // ì‹œíŠ¸ êµ¬ì¡°: 1í–‰=í—¤ë”, Aì—´(0)=ì‹œê°„, Fì—´(5)=ê²€ìƒ‰ì–´, Gì—´(6)=ê²€ìƒ‰ëŸ‰ (ê³ ì •)
                const dataStartIndex = 1;
                const timeCol = 0;
                const keywordCol = 5;
                const countCol = 6;
                
                // ê¸°ì¤€ ì‹œê°„: ë§ˆì§€ë§‰ ë°ì´í„° í–‰ì˜ Aì—´ ê°’
                let targetTime = null;
                for (let i = rows.length - 1; i >= dataStartIndex; i--) {
                    const row = rows[i];
                    if (row && row.length > timeCol && row[timeCol] != null && String(row[timeCol]).trim() !== '') {
                        targetTime = String(row[timeCol]).trim();
                        break;
                    }
                }
                
                if (!targetTime) {
                    throw new Error('ìµœì‹  ì‹œê°„ëŒ€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ë™ì¼ ì‹œê°„ëŒ€ í–‰ë§Œ ì¶”ì¶œ (1í–‰ì€ í—¤ë” ì œì™¸)
                const latestRows = [];
                for (let i = dataStartIndex; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length > countCol) {
                        const timeValue = String(row[timeCol] ?? '').trim();
                        if (timeValue === targetTime) latestRows.push(row);
                    }
                }
                
                // ì‹œê°„ëŒ€ ì¼ì¹˜ í–‰ì´ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„° í–‰ ì‚¬ìš©
                let rowsToUse = latestRows.length > 0 ? latestRows : rows.slice(dataStartIndex);
                
                trendsUpdateTime.textContent = `íŠ¸ë Œë“œ (${targetTime} ì—…ë°ì´íŠ¸ë¨)`;
                trendsListContainer.innerHTML = '';
                
                if (rowsToUse.length === 0) {
                    trendsListContainer.innerHTML = '<div class="p-2 text-sm text-gray-500">í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    currentTrendKeywords = [];
                    updateInsight();
                    return;
                }
                
                // Fì—´=ê²€ìƒ‰ì–´, Gì—´=ê²€ìƒ‰ëŸ‰ â€” Gì—´ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ, ì •ë ¬ìš© ìˆ«ìë§Œ íŒŒì‹±
                const keywordRows = [];
                rowsToUse.forEach((row) => {
                    const keyword = (row[keywordCol] != null ? String(row[keywordCol]) : '').trim();
                    if (!keyword) return;
                    if (keyword.toLowerCase().includes('search term')) return;
                    const countDisplay = (row[countCol] != null ? String(row[countCol]) : '').trim();
                    const sortNum = parseCountForSort(countDisplay);
                    keywordRows.push({ keyword, countDisplay: countDisplay || '-', searchCount: sortNum });
                });
                keywordRows.sort((a, b) => b.searchCount - a.searchCount);
                currentTrendKeywords = keywordRows;
                
                // ë¦¬ìŠ¤íŠ¸ UI ìƒì„± (ê²€ìƒ‰ëŸ‰ì€ Gì—´ ê°’ ê·¸ëŒ€ë¡œ í‘œì‹œ)
                keywordRows.forEach(({ keyword, countDisplay }) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'p-2 rounded cursor-pointer hover:bg-gray-50 flex justify-between items-center trend-item';
                    listItem.dataset.keyword = keyword;
                    
                    listItem.addEventListener('click', function() {
                        document.querySelectorAll('.trend-item').forEach(item => {
                            item.classList.remove('border-2', 'border-indigo-500', 'bg-indigo-50');
                            const keywordSpan = item.querySelector('.keyword-text');
                            const countDiv = item.querySelector('.count-text');
                            if (keywordSpan) keywordSpan.classList.remove('font-bold', 'text-indigo-600');
                            if (countDiv) countDiv.classList.remove('text-indigo-600');
                        });
                        this.classList.add('border-2', 'border-indigo-500', 'bg-indigo-50');
                        const keywordSpan = this.querySelector('.keyword-text');
                        const countDiv = this.querySelector('.count-text');
                        if (keywordSpan) keywordSpan.classList.add('font-bold', 'text-indigo-600');
                        if (countDiv) countDiv.classList.add('text-indigo-600');
                        selectedKeyword = keyword;
                        updateInsight();
                        console.log('Selected keyword:', selectedKeyword);
                    });
                    
                    listItem.innerHTML = `
                        <span class="text-sm text-gray-700 keyword-text">${keyword}</span>
                        <div class="text-right">
                            <div class="text-sm font-bold count-text">${countDisplay || '-'}</div>
                            <div class="text-xs text-red-500">â†‘ ${Math.floor(Math.random() * 900 + 100)}%</div>
                        </div>
                    `;
                    trendsListContainer.appendChild(listItem);
                });
                
                // í‚¤ì›Œë“œ ë¡œë“œ ì§í›„ AI MD ì œì•ˆ ë¨¼ì € í‘œì‹œ
                updateInsight();
                
            } catch (error) {
                console.error('íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                console.error('ì—ëŸ¬ ìƒì„¸:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                trendsListContainer.innerHTML = '<div class="p-2 text-sm text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                trendsUpdateTime.textContent = 'íŠ¸ë Œë“œ (ì˜¤ë¥˜ ë°œìƒ)';
            }
        }
        
        // AI MD ì œì•ˆ ë¬¸êµ¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (í‚¤ì›Œë“œ ë¡œë“œ í›„ ë¨¼ì € ì œì•ˆ, ì„ íƒ ì‹œ êµ¬ì²´í™”)
        function updateInsight() {
            const el = document.getElementById('aiInsightText');
            if (!el) return;
            
            const topN = currentTrendKeywords.slice(0, 5);
            const topKeywords = topN.map(k => k.keyword);
            const topKeywordStr = topKeywords.length ? topKeywords.join(', ') : '';
            
            if (selectedKeyword) {
                // ì‚¬ìš©ìê°€ í‚¤ì›Œë“œë¥¼ ì„ íƒí•œ ê²½ìš° â€” í•´ë‹¹ í‚¤ì›Œë“œ ê¸°ì¤€ êµ¬ì²´ì  ì œì•ˆ
                const keyword = selectedKeyword;
                const item = currentTrendKeywords.find(k => k.keyword === keyword);
                const vol = item && item.countDisplay ? item.countDisplay : (item ? formatSearchCount(String(item.searchCount)) : '');
                if (selectedBrand === 'DV') {
                    el.textContent = `[ì„ íƒ í‚¤ì›Œë“œ: ${keyword}${vol ? ' Â· ê²€ìƒ‰ëŸ‰ ' + vol : ''}]\n\n` +
                        `ì´ í‚¤ì›Œë“œë¥¼ ë©”ì¸ìœ¼ë¡œ í•œ ê°ì„± ë£©ë¶ ê¸°íšì„ ì¶”ì²œí•©ë‹ˆë‹¤. í—¤ë“œë¼ì¸ì—ëŠ” íŠ¸ë Œë“œ ê°ì„±(â€œ${keyword}â€)ì„ ë…¹ì´ê³ , ì„œë¸Œì¹´í”¼ì—ì„œëŠ” ì‹œì¦Œ ë¬´ë“œë‚˜ ì°©ìš© í¬ì¸íŠ¸ë¥¼ ì§§ê²Œ ê°•ì¡°í•˜ì„¸ìš”. ` +
                        `í…œí”Œë¦¿ A(ë°°ë„ˆí˜•) ë˜ëŠ” C(ë¦¬ìŠ¤íŠ¸í˜•)ë¡œ í‚¤ì›Œë“œ ë…¸ì¶œì„ í¬ê²Œ í•˜ë©´ ê²€ìƒ‰ ìœ ì…ì— ìœ ë¦¬í•©ë‹ˆë‹¤. ì°¸ì¡° ì´ë¯¸ì§€ëŠ” í•´ë‹¹ í‚¤ì›Œë“œì™€ ë§ëŠ” í•œ ë²Œ ì½”ë””ë‚˜ ë¬´ë“œ ì‚¬ì§„ì„ ë„£ì–´ ì£¼ì„¸ìš”.`;
                } else {
                    el.textContent = `[ì„ íƒ í‚¤ì›Œë“œ: ${keyword}${vol ? ' Â· ê²€ìƒ‰ëŸ‰ ' + vol : ''}]\n\n` +
                        `"${keyword}" ê²€ìƒ‰ëŸ‰ì´ ë†’ì€ ë§Œí¼, íƒ€ì„ì„¸ì¼Â·í•œì •ìˆ˜ëŸ‰Â·ì¦‰ì‹œ í• ì¸ ë“± ìœ ë‹ˆí¬ ì„¸ì¼ í¬ì¸íŠ¸ë¥¼ ì•ì— ë‘ëŠ” ì „ëµì„ ì¶”ì²œí•©ë‹ˆë‹¤. ` +
                        `í…œí”Œë¦¿ B(ì¹´ë“œí˜•)ë‚˜ D(ì´ë²¤íŠ¸í˜•)ë¡œ ê°€ê²©/í˜œíƒì„ ê°•ì¡°í•˜ê³ , ê¸°íš ì˜ë„ì—ëŠ” â€œí•œì • ê¸°ê°„â€, â€œì„ ì°© Nëª…â€ ë“±ì„ ëª…ì‹œí•˜ë©´ ì „í™˜ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.`;
                }
                return;
            }
            
            if (topN.length === 0) {
                el.textContent = 'íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì œì•ˆì´ í‘œì‹œë©ë‹ˆë‹¤.';
                return;
            }
            
            // í‚¤ì›Œë“œë§Œ ë¡œë“œëœ ìƒíƒœ â€” ì‚¬ìš©ì ì„ íƒ ì „, ìƒìœ„ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ë¨¼ì € ì œì•ˆ
            if (selectedBrand === 'DV') {
                el.textContent = `[í˜„ì¬ íŠ¸ë Œë“œ ìƒìœ„ í‚¤ì›Œë“œ: ${topKeywordStr}]\n\n` +
                    `ìœ„ í‚¤ì›Œë“œë¥¼ ë°˜ì˜í•œ ê°ì„± ë£©ë¶ ê¸°íšì„ ì¶”ì²œí•©ë‹ˆë‹¤. ê²€ìƒ‰ëŸ‰ì´ ë†’ì€ ìˆœìœ¼ë¡œ 1~2ê°œë¥¼ ë©”ì¸ í‚¤ì›Œë“œë¡œ ì •í•˜ê³ , í—¤ë“œë¼ì¸Â·ì„œë¸Œì¹´í”¼ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ ì£¼ì„¸ìš”. ` +
                    `í‚¤ì›Œë“œ ê°•ì¡°ê°€ ëª©í‘œë¼ë©´ í…œí”Œë¦¿ A(ë°°ë„ˆí˜•) ë˜ëŠ” C(ë¦¬ìŠ¤íŠ¸í˜•), ë¬´ë“œ ì¤‘ì‹¬ì´ë¼ë©´ B(ì¹´ë“œí˜•)ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ì™¼ìª½ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ê²€ìƒ‰ì–´ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œ ê¸°ì¤€ìœ¼ë¡œ ë” êµ¬ì²´ì ì¸ ì œì•ˆì„ ë“œë¦½ë‹ˆë‹¤.`;
            } else {
                el.textContent = `[í˜„ì¬ íŠ¸ë Œë“œ ìƒìœ„ í‚¤ì›Œë“œ: ${topKeywordStr}]\n\n` +
                    `ì´ í‚¤ì›Œë“œë“¤ì˜ ê²€ìƒ‰ ìˆ˜ìš”ë¥¼ í™œìš©í•´ íƒ€ì„ì„¸ì¼Â·í•œì • í˜œíƒ ì¤‘ì‹¬ ê¸°íšì„ ì¶”ì²œí•©ë‹ˆë‹¤. ìƒìœ„ 1~2ê°œë¥¼ ë©”ì¸ìœ¼ë¡œ ì¡ê³ , ê°€ê²©/í• ì¸/ì„ ì°©ìˆœì„ ê°•ì¡°í•˜ëŠ” ë¬¸êµ¬ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”. ` +
                    `í…œí”Œë¦¿ B(ì¹´ë“œí˜•) ë˜ëŠ” D(ì´ë²¤íŠ¸í˜•)ë¡œ ì„¸ì¼ì¦ˆ í¬ì¸íŠ¸ë¥¼ í¬ê²Œ ë…¸ì¶œí•˜ê³ , ê¸°íš ì˜ë„ì— â€œí•œì • ê¸°ê°„â€, â€œì„ ì°© Nëª…â€ ë“±ì„ ì ì–´ ë‘ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤. ì™¼ìª½ì—ì„œ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê²€ìƒ‰ì–´ ê¸°ì¤€ ë§ì¶¤ ì œì•ˆì„ ë“œë¦½ë‹ˆë‹¤.`;
            }
        }

        // ë¸Œëœë“œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupBrandSelection() {
            const brandRadios = document.querySelectorAll('input[name="brand"]');
            const checkedRadio = document.querySelector('input[name="brand"]:checked');
            if (checkedRadio) {
                selectedBrand = checkedRadio.value;
            }
            
            brandRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedBrand = this.value;
                    updateInsight();
                    console.log('ì„ íƒëœ ë¸Œëœë“œ:', selectedBrand);
                });
            });
        }
        
        // í…œí”Œë¦¿ ì¹´ë“œ ì„ íƒ ë° PC/MO í† ê¸€ ì„¤ì •
        function setupTemplateSelection() {
            const cards = document.querySelectorAll('.template-card');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    if (this.classList.contains('template-card--preparing') || this.dataset.template !== 'A') return;
                    const template = this.dataset.template;
                    selectedTemplate = template;

                    // ëª¨ë“  ì¹´ë“œì—ì„œ ì„ íƒ ìŠ¤íƒ€ì¼ ì œê±°
                    cards.forEach(c => {
                        c.classList.remove('ring-4', 'ring-indigo-500', 'ring-offset-2');
                        c.querySelector('.template-check').classList.add('hidden');
                    });
                    document.querySelectorAll('.template-variant').forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white', 'font-medium');
                        btn.classList.add('text-gray-500');
                    });

                    // ì„ íƒí•œ ì¹´ë“œì— ring + ì²´í¬ ì•„ì´ì½˜ í‘œì‹œ
                    this.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
                    this.querySelector('.template-check').classList.remove('hidden');

                    // ì„ íƒí•œ ì¹´ë“œ ë‚´ PC/MO ë²„íŠ¼ ì¤‘ í˜„ì¬ selectedVariant í™œì„±í™”
                    this.querySelectorAll('.template-variant').forEach(btn => {
                        if (btn.dataset.variant === selectedVariant) {
                            btn.classList.add('bg-indigo-600', 'text-white', 'font-medium');
                            btn.classList.remove('text-gray-500');
                        } else {
                            btn.classList.remove('bg-indigo-600', 'text-white', 'font-medium');
                            btn.classList.add('text-gray-500');
                        }
                    });

                    console.log('ì„ íƒëœ í…œí”Œë¦¿:', selectedTemplate, selectedVariant);
                });
            });

            // PC/MO ë²„íŠ¼ í´ë¦­ (ì¹´ë“œ ë‚´ë¶€ í† ê¸€)
            document.querySelectorAll('.template-variant').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const template = this.dataset.template;
                    const variant = this.dataset.variant;
                    if (template !== selectedTemplate) return;
                    selectedVariant = variant;

                    document.querySelectorAll('.template-variant').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white', 'font-medium');
                        b.classList.add('text-gray-500');
                    });
                    document.querySelectorAll('.template-variant[data-template="' + template + '"]').forEach(b => {
                        if (b.dataset.variant === variant) {
                            b.classList.add('bg-indigo-600', 'text-white', 'font-medium');
                            b.classList.remove('text-gray-500');
                        }
                    });
                    console.log('ì„ íƒëœ ë ˆì´ì•„ì›ƒ:', selectedVariant);
                });
            });

            // ì´ˆê¸° ìƒíƒœ: A ì¹´ë“œ ì„ íƒ + PC í™œì„±í™”
            const firstCard = document.querySelector('.template-card[data-template="A"]');
            if (firstCard) {
                firstCard.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
                firstCard.querySelector('.template-check').classList.remove('hidden');
                firstCard.querySelector('.template-variant[data-variant="PC"]').classList.add('bg-indigo-600', 'text-white', 'font-medium');
                firstCard.querySelector('.template-variant[data-variant="PC"]').classList.remove('text-gray-500');
            }
        }
        
        // AI ì‹œì•ˆ ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (Gemini â†’ ì¹´í”¼ ë°˜ì˜ â†’ ì´ë¯¸ì§€ URL â†’ textStyle ë°°ì¹˜)
        function setupGenerateButton() {
            var generateButton = document.getElementById('generateButton');
            generateButton.addEventListener('click', async function() {
                var campaignIntent = document.getElementById('campaignIntent').value;
                if (!selectedKeyword || !selectedTemplate) {
                    alert('í‚¤ì›Œë“œì™€ í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                var modeRadios = document.querySelectorAll('input[name="aiGenerateMode"]');
                var aiMode = 'mood';
                modeRadios.forEach(function(r) { if (r.checked) aiMode = r.value; });
                selectedAiMode = aiMode;
                
                var btn = this;
                var origText = btn.textContent;
                btn.disabled = true;
                setGenerateStatus('Geminiê°€ ë¸Œëœë“œë¥¼ ë¶„ì„í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...');
                
                var geminiResult = { imagePrompt: '', brandCopy: '', keywordCopy: '' };
                try {
                    geminiResult = await callGeminiForPromptAndCopy(selectedBrand, selectedKeyword, campaignIntent, referenceImageComposition, aiMode);
                } catch (e) {
                    console.warn(e);
                    geminiResult.imagePrompt = buildImagePrompt(selectedBrand, selectedKeyword, campaignIntent, referenceImageComposition, aiMode);
                    geminiResult.brandCopy = (BRAND_KNOWLEDGE[selectedBrand] && BRAND_KNOWLEDGE[selectedBrand].fullName) ? BRAND_KNOWLEDGE[selectedBrand].fullName + ' 26SS ì»¬ë ‰ì…˜' : selectedBrand + ' 26SS ì»¬ë ‰ì…˜';
                    geminiResult.keywordCopy = selectedKeyword;
                }
                
                var brandCopy = (geminiResult.brandCopy || '').trim() || selectedBrand + ' 26SS ì»¬ë ‰ì…˜';
                var keywordCopy = (geminiResult.keywordCopy || '').trim() || selectedKeyword;
                document.getElementById('resultMoBrand').textContent = brandCopy;
                document.getElementById('resultMoKeyword').textContent = keywordCopy;
                document.getElementById('resultPcBrand').textContent = brandCopy;
                document.getElementById('resultPcKeyword').textContent = keywordCopy;
                var editBrandEl = document.getElementById('editBrand');
                var editKeywordEl = document.getElementById('editKeyword');
                if (editBrandEl) editBrandEl.value = brandCopy;
                if (editKeywordEl) editKeywordEl.value = keywordCopy;
                
                setGenerateStatus('AI ë””ìì´ë„ˆê°€ ê³ í™”ì§ˆ ì‹œì•ˆì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...');
                overlayInited['mo-brand'] = overlayInited['mo-keyword'] = overlayInited['pc-brand'] = overlayInited['pc-keyword'] = false;
                console.log('imagePrompt (í‚¤ì›Œë“œÂ·ìƒì„¸ì§€ì¹¨ ë°˜ì˜ í™•ì¸):', geminiResult.imagePrompt);
                var loadingEl = document.getElementById('imageLoadingOverlay');
                var loadingMsgEl = document.getElementById('imageLoadingOverlayMessage');
                if (loadingMsgEl) loadingMsgEl.textContent = 'AI ë””ìì´ë„ˆê°€ ê³ í™”ì§ˆ ì‹œì•ˆì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...';
                if (loadingEl) { loadingEl.classList.add('visible'); loadingEl.setAttribute('aria-hidden', 'false'); }
                var imageSrc;
                try {
                    imageSrc = await fetchNanoBananaImage(geminiResult.imagePrompt, aiMode, campaignIntent);
                } finally {
                    if (loadingEl) { loadingEl.classList.remove('visible'); loadingEl.setAttribute('aria-hidden', 'true'); }
                }
                var moImg = document.getElementById('resultMoImage');
                var pcImg = document.getElementById('resultPcImage');
                var moPh = document.getElementById('resultMoPlaceholder');
                var pcPh = document.getElementById('resultPcPlaceholder');
                var moOverlay = document.getElementById('resultMoOverlay');
                var pcOverlay = document.getElementById('resultPcOverlay');
                function showMo() {
                    moImg.classList.remove('hidden');
                    moPh.classList.add('hidden');
                    moOverlay.classList.remove('hidden');
                    setTimeout(function() { initOverlayPositions(); }, 50);
                }
                function showPc() {
                    pcImg.classList.remove('hidden');
                    pcPh.classList.add('hidden');
                    pcOverlay.classList.remove('hidden');
                    setTimeout(function() { initOverlayPositions(); }, 50);
                }
                function hideMo() {
                    moImg.classList.add('hidden');
                    moPh.classList.remove('hidden');
                    moOverlay.classList.add('hidden');
                }
                function hidePc() {
                    pcImg.classList.add('hidden');
                    pcPh.classList.remove('hidden');
                    pcOverlay.classList.add('hidden');
                }
                moImg.onload = showMo;
                moImg.onerror = hideMo;
                pcImg.onload = showPc;
                pcImg.onerror = hidePc;
                moImg.crossOrigin = pcImg.crossOrigin = 'anonymous';
                moImg.src = imageSrc;
                pcImg.src = imageSrc;
                lastGeneratedImageUrl = imageSrc;
                lastImagePrompt = geminiResult.imagePrompt;
                lastDetailInstructions = campaignIntent || '';
                lastAiMode = aiMode;
                
                setGenerateStatus('');
                btn.disabled = false;
                btn.textContent = origText;
                var resultEl = document.getElementById('result');
                requestAnimationFrame(function() {
                    var y = resultEl.getBoundingClientRect().top + window.pageYOffset - 16;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                });
            });
        }
        
        // ì‹œì•ˆ ë‹¤ìš´ë¡œë“œ: íŒŒì¼ëª…ì— ì“¸ ìˆ˜ ì—†ëŠ” ë¬¸ì ì œê±°
        function sanitizeFilename(str) {
            return String(str).replace(/[/\\:*?"<>|\s]+/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '') || 'ì‹œì•ˆ';
        }
        
        // MO ì‹œì•ˆ PNG ì €ì¥
        function downloadMoImage() {
            if (!selectedKeyword || !selectedBrand) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
            var el = document.getElementById('resultMoCapture');
            if (!el || typeof html2canvas === 'undefined') { alert('ë‹¤ìš´ë¡œë“œ ë„êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            var brand = selectedBrand === 'DV' ? 'DV' : 'ST';
            var name = sanitizeFilename(brand) + '_' + sanitizeFilename(selectedKeyword) + '_MO.png';
            html2canvas(el, { useCORS: true, scale: 2, backgroundColor: null }).then(function(canvas) {
                var a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = name;
                a.click();
            }).catch(function(err) { console.error(err); alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        }
        
        // PC ì‹œì•ˆ PNG ì €ì¥
        function downloadPcImage() {
            if (!selectedKeyword || !selectedBrand) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
            var el = document.getElementById('resultPcCapture');
            if (!el || typeof html2canvas === 'undefined') { alert('ë‹¤ìš´ë¡œë“œ ë„êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            var brand = selectedBrand === 'DV' ? 'DV' : 'ST';
            var name = sanitizeFilename(brand) + '_' + sanitizeFilename(selectedKeyword) + '_PC.png';
            html2canvas(el, { useCORS: true, scale: 2, backgroundColor: null }).then(function(canvas) {
                var a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = name;
                a.click();
            }).catch(function(err) { console.error(err); alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        }
        
        // MO+PC ì••ì¶• ë‹¤ìš´ë¡œë“œ
        function downloadAllImages() {
            if (!selectedKeyword || !selectedBrand) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'); return; }
            if (typeof JSZip === 'undefined' || typeof html2canvas === 'undefined') { alert('ë‹¤ìš´ë¡œë“œ ë„êµ¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            var brand = selectedBrand === 'DV' ? 'DV' : 'ST';
            var base = sanitizeFilename(brand) + '_' + sanitizeFilename(selectedKeyword);
            var zip = new JSZip();
            Promise.all([
                html2canvas(document.getElementById('resultMoCapture'), { useCORS: true, scale: 2, backgroundColor: null }),
                html2canvas(document.getElementById('resultPcCapture'), { useCORS: true, scale: 2, backgroundColor: null })
            ]).then(function(results) {
                zip.file(base + '_MO.png', results[0].toDataURL('image/png').split(',')[1], { base64: true });
                zip.file(base + '_PC.png', results[1].toDataURL('image/png').split(',')[1], { base64: true });
                return zip.generateAsync({ type: 'blob' });
            }).then(function(blob) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = base + '_ì‹œì•ˆ.zip';
                a.click();
                URL.revokeObjectURL(a.href);
            }).catch(function(err) { console.error(err); alert('ì••ì¶• ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        }
        
        // ì‹œì•ˆ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´: ìœ„ì¹˜Â·í¬ê¸° ìƒíƒœ (px). html2canvas ìº¡ì²˜ ì‹œ ì´ ê°’ì´ ê·¸ëŒ€ë¡œ ë°˜ì˜ë¨
        var overlayState = {
            'mo-brand': { x: 0, y: 0, fontSize: 14 },
            'mo-keyword': { x: 0, y: 0, fontSize: 28 },
            'pc-brand': { x: 0, y: 0, fontSize: 16 },
            'pc-keyword': { x: 0, y: 0, fontSize: 36 }
        };
        var overlayInited = { 'mo-brand': false, 'mo-keyword': false, 'pc-brand': false, 'pc-keyword': false };
        
        function getOverlayBox(target) { return document.querySelector('.overlay-text-box[data-target="' + target + '"]'); }
        function getTextSpan(box) { return box ? box.querySelector('span:not(.resize-handle)') : null; }
        function getCaptureFor(target) { return target.indexOf('mo') === 0 ? document.getElementById('resultMoCapture') : document.getElementById('resultPcCapture'); }
        
        function applyOverlayState(target) {
            var box = getOverlayBox(target);
            if (!box) return;
            var s = overlayState[target];
            box.style.left = s.x + 'px';
            box.style.top = s.y + 'px';
            var textSpan = getTextSpan(box);
            if (textSpan) textSpan.style.fontSize = (s.fontSize + 'px');
        }
        
        function updatePanelFromState(target) {
            var s = overlayState[target];
            var idMap = { 'mo-brand': 'editMoBrandSize', 'mo-keyword': 'editMoKeywordSize', 'pc-brand': 'editPcBrandSize', 'pc-keyword': 'editPcKeywordSize' };
            var el = document.getElementById(idMap[target]);
            if (el) el.value = s.fontSize;
        }
        
        // ë””í´íŠ¸ ë°°ì¹˜: MO ê°€ìš´ë° ìƒë‹¨(ì´ë¯¸ì§€ ì•ˆìœ¼ë¡œ ì—„ê²© ì œí•œ), PC ì¢Œì¸¡ ì„¸ë¡œ ì¤‘ì•™
        function getTextStyleDefaults(brandKey) {
            var brand = BRAND_KNOWLEDGE[brandKey];
            var isDV = brandKey === 'DV';
            return {
                'mo-brand':  { centerHoriz: true, yRatio: 0.05, fs: 13, fontWeight: isDV ? '600' : '600' },
                'mo-keyword': { centerHoriz: true, yRatio: 0.14, fs: 26, fontWeight: isDV ? '700' : '700' },
                'pc-brand':  { leftAlign: true, leftMarginRatio: 0.08, yRatio: 0.38, fs: 15, fontWeight: isDV ? '600' : '600' },
                'pc-keyword': { leftAlign: true, leftMarginRatio: 0.08, yRatio: 0.48, fs: 32, fontWeight: isDV ? '700' : '700' }
            };
        }
        
        function initOverlayPositions() {
            var brandKey = selectedBrand || 'DV';
            var defaultsMap = getTextStyleDefaults(brandKey);
            var targets = ['mo-brand','mo-keyword','pc-brand','pc-keyword'];
            targets.forEach(function(target) {
                if (overlayInited[target]) return;
                var box = getOverlayBox(target);
                var container = getCaptureFor(target);
                if (!box || !container) return;
                var rect = container.getBoundingClientRect();
                var w = rect.width, h = rect.height;
                var d = defaultsMap[target] || { yRatio: 0.1, fs: 16, fontWeight: '600' };
                overlayState[target].fontSize = Math.max(8, Math.min(72, d.fs));
                overlayInited[target] = true;
                var textSpan = getTextSpan(box);
                if (textSpan) textSpan.style.fontWeight = d.fontWeight || '600';
                overlayState[target].x = 0;
                overlayState[target].y = h * d.yRatio;
                applyOverlayState(target);
                var boxW = box.offsetWidth || 80;
                var boxH = box.offsetHeight || 24;
                var margin = 8;
                var y = Math.max(0, Math.min(h - boxH - margin, h * d.yRatio));
                overlayState[target].y = y;
                var x;
                if (d.centerHoriz) {
                    x = (w - boxW) / 2;
                    x = Math.max(margin, Math.min(w - boxW - margin, x));
                } else if (d.leftAlign) {
                    x = w * (d.leftMarginRatio != null ? d.leftMarginRatio : 0.08);
                    x = Math.max(margin, Math.min(w - boxW - margin, x));
                } else if (d.rightAlign) {
                    var rMargin = w * (d.rightMarginRatio != null ? d.rightMarginRatio : 0.08);
                    x = Math.max(margin, w - boxW - rMargin);
                } else {
                    x = Math.max(margin, Math.min(w - boxW - margin, w * (d.xRatio != null ? d.xRatio : 0.05)));
                }
                overlayState[target].x = Math.max(0, Math.min(w - boxW - margin, x));
                applyOverlayState(target);
                updatePanelFromState(target);
            });
            var sizeIds = ['editMoBrandSize','editMoKeywordSize','editPcBrandSize','editPcKeywordSize'];
            var stateKeys = ['mo-brand','mo-keyword','pc-brand','pc-keyword'];
            stateKeys.forEach(function(k, i) {
                var el = document.getElementById(sizeIds[i]);
                if (el) el.value = overlayState[k].fontSize;
            });
        }
        
        function setupOverlayInteract() {
            if (typeof interact === 'undefined') return;
            interact('.overlay-text-box').draggable({
                ignoreFrom: '.resize-handle',
                listeners: {
                    start: function(e) {
                        e.target.classList.add('dragging');
                    },
                    move: function(e) {
                        var target = e.target.getAttribute('data-target');
                        var container = getCaptureFor(target);
                        if (!container) return;
                        var rect = container.getBoundingClientRect();
                        var state = overlayState[target];
                        state.x += e.dx;
                        state.y += e.dy;
                        state.x = Math.max(0, Math.min(rect.width - (e.target.offsetWidth || 20), state.x));
                        state.y = Math.max(0, Math.min(rect.height - (e.target.offsetHeight || 20), state.y));
                        e.target.style.left = state.x + 'px';
                        e.target.style.top = state.y + 'px';
                        updatePanelFromState(target);
                    },
                    end: function(e) {
                        e.target.classList.remove('dragging');
                    }
                }
            }).on('tap', function(e) {
                if (e.target.classList.contains('resize-handle')) e.stopPropagation();
            });
            
            document.querySelectorAll('.resize-handle').forEach(function(handle) {
                handle.addEventListener('mousedown', function(ev) {
                    ev.preventDefault(); ev.stopPropagation();
                    var box = handle.closest('.overlay-text-box');
                    var key = box.getAttribute('data-target');
                    var startY = ev.clientY; var startSize = overlayState[key].fontSize;
                    function move(e) {
                        var dy = e.clientY - startY;
                        var next = Math.max(8, Math.min(72, startSize + Math.round(dy * 0.5)));
                        overlayState[key].fontSize = next;
                        getTextSpan(box).style.fontSize = next + 'px';
                        updatePanelFromState(key);
                    }
                    function up() {
                        document.removeEventListener('mousemove', move);
                        document.removeEventListener('mouseup', up);
                    }
                    document.addEventListener('mousemove', move);
                    document.addEventListener('mouseup', up);
                });
            });
            
            var sizeInputs = { 'editMoBrandSize': 'mo-brand', 'editMoKeywordSize': 'mo-keyword', 'editPcBrandSize': 'pc-brand', 'editPcKeywordSize': 'pc-keyword' };
            Object.keys(sizeInputs).forEach(function(id) {
                var target = sizeInputs[id];
                document.getElementById(id)?.addEventListener('input', function() {
                    var v = Math.max(8, Math.min(72, parseInt(this.value, 10) || 14));
                    overlayState[target].fontSize = v;
                    applyOverlayState(target);
                });
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŠ¸ë Œë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            fetchTrends();
            document.getElementById('trendsReloadBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                fetchTrends().finally(function() {
                    var btn = document.getElementById('trendsReloadBtn');
                    if (btn) { btn.disabled = false; btn.textContent = 'ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°'; }
                });
            });
            setupBrandSelection();
            setupTemplateSelection();
            setupGenerateButton();
            (function setupReferenceImageAndAiMode() {
                var zone = document.getElementById('referenceImageZone');
                var input = document.getElementById('referenceImageInput');
                var label = document.getElementById('referenceImageLabel');
                var hint = document.getElementById('aiModeHint');
                var radios = document.querySelectorAll('input[name="aiGenerateMode"]');
                function setModeEnabled(enabled) {
                    hasReferenceImage = !!enabled;
                    radios.forEach(function(r) { r.disabled = !enabled; });
                    if (hint) hint.textContent = enabled ? 'ëª¨ë“œë¥¼ ì„ íƒí•œ ë’¤ AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.' : 'ì°¸ì¡° ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ë©´ ëª¨ë“œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (zone && input) {
                    zone.addEventListener('click', function() { input.click(); });
                    input.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            referenceImageComposition = 'User-uploaded reference image; preserve its composition and subject.';
                            if (label) { label.textContent = 'ì²¨ë¶€ë¨: ' + this.files[0].name; }
                            zone.classList.add('border-indigo-300', 'bg-indigo-50/30');
                            setModeEnabled(true);
                            var first = document.querySelector('input[name="aiGenerateMode"][value="similar"]');
                            if (first) { first.checked = true; selectedAiMode = 'similar'; }
                        }
                    });
                }
                document.querySelectorAll('input[name="aiGenerateMode"]').forEach(function(r) {
                    r.addEventListener('change', function() { selectedAiMode = this.value; });
                });
                setModeEnabled(false);
            })();
            setupOverlayInteract();
            document.getElementById('downloadMoBtn')?.addEventListener('click', downloadMoImage);
            document.getElementById('downloadPcBtn')?.addEventListener('click', downloadPcImage);
            document.getElementById('downloadAllBtn')?.addEventListener('click', downloadAllImages);
            function syncResultTextFromInputs() {
                var editB = document.getElementById('editBrand');
                var editK = document.getElementById('editKeyword');
                var rMoB = document.getElementById('resultMoBrand'); var rMoK = document.getElementById('resultMoKeyword');
                var rPcB = document.getElementById('resultPcBrand'); var rPcK = document.getElementById('resultPcKeyword');
                var brandVal = editB ? editB.value : '';
                var keywordVal = editK ? editK.value : '';
                if (rMoB) rMoB.textContent = brandVal || rMoB.textContent;
                if (rMoK) rMoK.textContent = keywordVal || rMoK.textContent;
                if (rPcB) rPcB.textContent = brandVal || rPcB.textContent;
                if (rPcK) rPcK.textContent = keywordVal || rPcK.textContent;
            }
            ['editBrand','editKeyword'].forEach(function(id) {
                document.getElementById(id)?.addEventListener('input', syncResultTextFromInputs);
            });
            var developBtn = document.getElementById('developImageBtn');
            var regenBtn = document.getElementById('regenerateImageBtn');
            function setDevelopRegenDisabled(disabled) {
                if (developBtn) developBtn.disabled = disabled;
                if (regenBtn) regenBtn.disabled = disabled;
            }
            developBtn?.addEventListener('click', async function() {
                if (!selectedKeyword) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  ì‹œì•ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
                if (!lastGeneratedImageUrl) { alert('ë¨¼ì € AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¡œ ì´ë¯¸ì§€ë¥¼ ë§Œë“  ë’¤ ë””ë²¨ë¡­í•´ì£¼ì„¸ìš”.'); return; }
                var feedback = (document.getElementById('resultFeedback')?.value || '').trim();
                if (!feedback) { alert('í”¼ë“œë°± ë°•ìŠ¤ì— ìˆ˜ì • ì§€ì‹œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ë°°ê²½ì„ ë” ë°ê²Œ)'); return; }
                var moImg = document.getElementById('resultMoImage');
                var pcImg = document.getElementById('resultPcImage');
                var loadingEl = document.getElementById('imageLoadingOverlay');
                var loadingMsg = document.getElementById('imageLoadingOverlayMessage');
                if (loadingMsg) loadingMsg.textContent = 'ë””ë²¨ë¡­ ì¤‘...';
                setGenerateStatus('ë””ë²¨ë¡­ ì¤‘...');
                setDevelopRegenDisabled(true);
                if (loadingEl) { loadingEl.classList.add('visible'); loadingEl.setAttribute('aria-hidden', 'false'); }
                try {
                    var url = await fetchFluxImageToImage(lastGeneratedImageUrl, feedback, 0.5);
                    if (url) {
                        lastGeneratedImageUrl = url;
                        moImg.crossOrigin = pcImg.crossOrigin = 'anonymous';
                        moImg.src = pcImg.src = url;
                    } else { alert('ì´ë¯¸ì§€ ë””ë²¨ë¡­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
                } finally {
                    setGenerateStatus('');
                    setDevelopRegenDisabled(false);
                    if (loadingEl) { loadingEl.classList.remove('visible'); loadingEl.setAttribute('aria-hidden', 'true'); }
                }
            });
            regenBtn?.addEventListener('click', async function() {
                if (!selectedKeyword) { alert('ë¨¼ì € í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  ì‹œì•ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
                if (!lastImagePrompt) { alert('ë¨¼ì € AI ì‹œì•ˆ ìƒì„±í•˜ê¸°ë¡œ ì´ë¯¸ì§€ë¥¼ ë§Œë“  ë’¤ ì¬ìƒì„±í•´ì£¼ì„¸ìš”.'); return; }
                var feedback = (document.getElementById('resultFeedback')?.value || '').trim();
                var prompt = lastImagePrompt + (feedback ? '. ' + feedback : '');
                var moImg = document.getElementById('resultMoImage');
                var pcImg = document.getElementById('resultPcImage');
                var loadingEl = document.getElementById('imageLoadingOverlay');
                var loadingMsg = document.getElementById('imageLoadingOverlayMessage');
                if (loadingMsg) loadingMsg.textContent = 'ìƒˆë¡œ ìƒì„± ì¤‘...';
                setGenerateStatus('ìƒˆë¡œ ìƒì„± ì¤‘...');
                setDevelopRegenDisabled(true);
                if (loadingEl) { loadingEl.classList.add('visible'); loadingEl.setAttribute('aria-hidden', 'false'); }
                try {
                    var imageSrc = await fetchNanoBananaImage(prompt, lastAiMode, feedback || lastDetailInstructions);
                    lastGeneratedImageUrl = imageSrc;
                    moImg.crossOrigin = pcImg.crossOrigin = 'anonymous';
                    moImg.src = pcImg.src = imageSrc;
                } finally {
                    setGenerateStatus('');
                    setDevelopRegenDisabled(false);
                    if (loadingEl) { loadingEl.classList.remove('visible'); loadingEl.setAttribute('aria-hidden', 'true'); }
                }
            });
        });
    </script>

</body>
</html>